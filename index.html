<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg: var(--tg-theme-bg-color, #f0f2f5);
      --card: var(--tg-theme-secondary-bg-color, #ffffff);
      --text: var(--tg-theme-text-color, #222);
      --hint: var(--tg-theme-hint-color, #777);
      --accent: #2481cc;
      
      /* Нова палітра */
      --color-light: #e6e6a1;
      --color-dark: #00193a;
      --white: #ffffff;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 12px;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    
    select {
      padding: 8px 12px; border-radius: 10px; border: 1px solid rgba(0,0,0,0.1);
      background: var(--card); color: var(--text); font-size: 0.9rem; font-weight: bold; outline: none;
    }

    .tabs { display: flex; background: rgba(0,0,0,0.05); border-radius: 10px; padding: 2px; margin-bottom: 12px; }
    .tab { flex: 1; text-align: center; padding: 8px; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: bold; }
    .tab.active { background: var(--card); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

    /* Динамічний статусний блок */
    .status-card {
      border-radius: 15px;
      padding: 15px;
      text-align: center;
      margin-bottom: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    /* Коли світло Є */
    .status-on { background-color: var(--color-light) !important; color: var(--color-dark) !important; }
    /* Коли світла НЕМАЄ */
    .status-off { background-color: var(--color-dark) !important; color: var(--color-light) !important; }

    .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; width: 100%; }

    .hour {
      aspect-ratio: 1.8; display: flex; align-items: center; justify-content: center;
      font-size: 0.75rem; font-weight: bold; border-radius: 8px; background: var(--white);
      color: var(--color-dark); border: 1px solid rgba(0,0,0,0.05); position: relative;
    }

    /* Класи замальовки годин за твоїми кольорами */
    .off-full { background-color: var(--color-dark) !important; color: var(--color-light) !important; border: none; }
    .off-left { background: linear-gradient(90deg, var(--color-dark) 50%, var(--white) 50%) !important; }
    .off-right { background: linear-gradient(90deg, var(--white) 50%, var(--color-dark) 50%) !important; }
    
    .current { outline: 3px solid var(--accent); z-index: 10; }

    .loader-text { color: var(--hint); font-style: italic; font-size: 0.8rem; margin-top: 20px; text-align: center; }

    /* Футер */
    .footer {
      margin-top: auto;
      padding: 20px 10px 10px;
      font-size: 0.75rem;
      color: var(--hint);
      text-align: center;
      line-height: 1.3;
    }
  </style>
</head>
<body>

  <div class="header-row">
    <select id="q-select" onchange="changeQueue()">
      <option value="1.1">Черга 1.1</option><option value="1.2">Черга 1.2</option>
      <option value="2.1">Черга 2.1</option><option value="2.2">Черга 2.2</option>
      <option value="3.1">Черга 3.1</option><option value="3.2">Черга 3.2</option>
      <option value="4.1">Черга 4.1</option><option value="4.2">Черга 4.2</option>
      <option value="5.1">Черга 5.1</option><option value="5.2">Черга 5.2</option>
      <option value="6.1">Черга 6.1</option><option value="6.2">Черга 6.2</option>
    </select>
    <div class="date-badge" id="date-label" style="font-weight:bold;">--.--</div>
  </div>

  <div class="tabs">
    <div id="tab0" class="tab active" onclick="loadData(0)">СЬОГОДНІ</div>
    <div id="tab1" class="tab" onclick="loadData(1)">НА ЗАВТРА</div>
  </div>

  <div id="status" class="status-card">Синхронізація...</div>
  
  <div id="grid" class="grid"></div>
  <div id="loader" class="loader-text" style="display:none;">⏳ Оновлення...</div>

  <div class="footer">
    Графік відповідає офіційним сповіщенням і може не співпадати з реальними відключеннями
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    
    // Встав своє посилання з GAS сюди
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzJieO6MQN5NjOJJHUzauaUfCDx-sP8S_9tY_y5KPu-vxb7AX113hjccEFxzooS10fX5g/exec"; 

    const userId = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : "197183975";
    let currentOffset = 0;

    async function loadData(offset) {
      currentOffset = offset;
      const gridEl = document.getElementById('grid');
      const statusEl = document.getElementById('status');
      const loaderEl = document.getElementById('loader');

      gridEl.innerHTML = ""; 
      statusEl.innerText = "";
      statusEl.className = "status-card"; // скидаємо класи кольору
      loaderEl.style.display = "block";

      document.getElementById('tab0').classList.toggle('active', offset === 0);
      document.getElementById('tab1').classList.toggle('active', offset === 1);
      
      try {
        const finalUrl = `${WEB_APP_URL}?action=getSchedule&chatId=${userId}&offset=${offset}`;
        const response = await fetch(finalUrl, { method: 'GET', redirect: 'follow' });
        const data = await response.json();
        render(data);
      } catch (err) {
        statusEl.innerHTML = `<span style="color:red">Помилка зв'язку</span>`;
      } finally {
        loaderEl.style.display = "none";
      }
    }

    async function changeQueue() {
      const newQ = document.getElementById('q-select').value;
      tg.HapticFeedback.impactOccurred('medium');
      try {
        const saveUrl = `${WEB_APP_URL}?action=saveQueue&chatId=${userId}&queue=${newQ}`;
        await fetch(saveUrl, { method: 'GET', redirect: 'follow' });
        loadData(currentOffset);
      } catch (err) { console.error(err); }
    }

    function render(data) {
  const statusEl = document.getElementById('status');
  const gridEl = document.getElementById('grid');
  const dateEl = document.getElementById('date-label');
  const qSelect = document.getElementById('q-select');

  // Очищаємо вміст сітки
  gridEl.innerHTML = "";
  
  // Скидаємо класи статусу до початкового стану (тільки базова картка)
  statusEl.className = "status-card";

  // Логіка відображення блоку статусу:
  // Якщо є помилка — завжди показуємо блок, щоб вивести текст помилки.
  // Якщо помилки немає, але це графік на завтра — ховаємо блок, бо статус "Зараз" неактуальний.
  if (data.error) {
    statusEl.style.display = 'block';
    statusEl.innerHTML = `<span style="color:var(--red); font-weight:bold;">${data.error}</span>`;
    if (data.date) dateEl.innerText = data.date;
    return;
  } else if (data.isTomorrow) {
    statusEl.style.display = 'none';
  } else {
    statusEl.style.display = 'block';
  }

  // Заповнюємо дату та чергу
  dateEl.innerText = data.date;
  qSelect.value = data.queue;
  statusEl.innerHTML = data.status.replace(/\n/g, '<br>');

  // Визначаємо колір статус-карти (тільки для "Сьогодні")
  if (!data.isTomorrow) {
    if (data.status.includes("ВІДСУТНЄ")) {
      statusEl.classList.add('status-off');
    } else {
      statusEl.classList.add('status-on');
    }
  }

  const nowH = new Date().getHours();

  // Малюємо сітку годин
  for (let h = 0; h < 24; h++) {
    const cell = document.createElement('div');
    const firstHalfOff = isTimeOff(h, 15, data.slots);
    const secondHalfOff = isTimeOff(h, 45, data.slots);

    if (firstHalfOff && secondHalfOff) {
      cell.className = 'hour off-full';
    } else if (firstHalfOff) {
      cell.className = 'hour off-left';
    } else if (secondHalfOff) {
      cell.className = 'hour off-right';
    } else {
      cell.className = 'hour';
    }

    // Підсвітка поточної години тільки на вкладці "Сьогодні"
    if (h === nowH && !data.isTomorrow) {
      cell.classList.add('current');
    }
    
    cell.innerHTML += `${h.toString().padStart(2, '0')}-${(h+1).toString().padStart(2, '0')}`;
    gridEl.appendChild(cell);
  }
}
    function isTimeOff(h, m, slots) {
      const total = h * 60 + m;
      return slots.some(s => {
        if (!s.isOutage) return false;
        const sM = parseInt(s.start.split(':')[0]) * 60 + parseInt(s.start.split(':')[1]);
        let eM = s.end === "00:00" ? 1440 : parseInt(s.end.split(':')[0]) * 60 + parseInt(s.end.split(':')[1]);
        return total >= sM && total < eM;
      });
    }

    window.onload = () => loadData(0);
  </script>
</body>
</html>
