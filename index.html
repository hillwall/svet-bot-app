<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>–ì—Ä–∞—Ñ—ñ–∫ —Å–≤—ñ—Ç–ª–∞ –í—ñ–Ω–Ω–∏—Ü—è</title>
  <!-- –û—Ñ—ñ—Ü—ñ–π–Ω–∞ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg: var(--tg-theme-bg-color, #f0f2f5);
      --card: var(--tg-theme-secondary-bg-color, #ffffff);
      --text: var(--tg-theme-text-color, #222);
      --hint: var(--tg-theme-hint-color, #777);
      --accent: #2481cc;
      --color-light: #e6e6a1;
      --color-dark: #00193a;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 15px;
      margin: 0;
      -webkit-user-select: none;
      user-select: none;
    }

    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      margin-bottom: 15px;
    }

    .status-on { color: #2ecc71; font-weight: bold; }
    .status-off { color: #e74c3c; font-weight: bold; }

    .grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-top: 15px;
    }

    .hour {
      padding: 10px 5px;
      text-align: center;
      border-radius: 8px;
      font-size: 12px;
      background: #eee;
      border: 1px solid #ddd;
      color: #333;
    }

    /* –°—Ç–∏–ª—ñ –¥–ª—è –∑–∞—Ñ–∞—Ä–±–æ–≤—É–≤–∞–Ω–Ω—è –≥–æ–¥–∏–Ω */
    .off-full { background: var(--color-dark); color: white; border-color: var(--color-dark); }
    .off-left { background: linear-gradient(90deg, var(--color-dark) 50%, #eee 50%); color: #333; }
    .off-right { background: linear-gradient(90deg, #eee 50%, var(--color-dark) 50%); color: #333; }
    
    .current {
      border: 2px solid var(--accent);
      font-weight: bold;
      transform: scale(1.05);
      box-shadow: 0 0 5px rgba(36, 129, 204, 0.5);
    }

    .loader {
      text-align: center;
      padding: 50px 20px;
      font-style: italic;
      color: var(--hint);
    }

    .btn-row {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    button {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      border: none;
      background: var(--accent);
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    button:active { opacity: 0.7; }
    button.inactive { background: var(--hint); opacity: 0.5; }

    .error {
      background: #fff5f5;
      color: #e74c3c;
      text-align: center;
      padding: 20px;
      border-radius: 12px;
      border: 1px solid #ffc1c1;
    }
    
    small { display: block; margin-top: 10px; font-size: 11px; opacity: 0.7; }
  </style>
</head>
<body>
  <div id="app">
    <div class="loader">–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –¥–æ–¥–∞—Ç–∫–∞...</div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    
    // –í–°–¢–ê–í –°–Æ–î–ò –°–í–û–Ñ –ü–û–°–ò–õ–ê–ù–ù–Ø –ù–ê WEB APP (DEPLOYMENT URL)
    const webAppUrl = "–¢–£–¢_–¢–í–û–Ñ_–ü–û–°–ò–õ–ê–ù–ù–Ø_–ó_GOOGLE_APPS_SCRIPT"; 

    // –û—Ç—Ä–∏–º–∞–Ω–Ω—è ID –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
    const chatId = tg.initDataUnsafe?.user?.id || "197183975";

    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑–∞–ø–∏—Ç—ñ–≤ –¥–æ API —á–µ—Ä–µ–∑ fetch (CORS)
    async function callApi(action, params = {}) {
      const query = new URLSearchParams({ action, chatId, ...params }).toString();
      const url = `${webAppUrl}?${query}`;
      
      const response = await fetch(url);
      if (!response.ok) throw new Error("–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ");
      return await response.json();
    }

    // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö
    async function init(offset = 0) {
      const app = document.getElementById('app');
      app.innerHTML = '<div class="loader">–û—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö —ñ–∑ —Å–µ—Ä–≤–µ—Ä–∞...</div>';
      
      try {
        const data = await callApi('getData', { offset });
        if (data.error) {
          app.innerHTML = `
            <div class="error">
              <b>üìç –ß–µ—Ä–≥–∞ ${data.queue || '–Ω–µ –≤–∏–∑–Ω–∞—á–µ–Ω–∞'}</b><br><br>
              ${data.error}
            </div>`;
          return;
        }
        render(data);
      } catch (e) {
        app.innerHTML = `
          <div class="error">
            –ü–æ–º–∏–ª–∫–∞ –∑–≤'—è–∑–∫—É –∑ —Å–µ—Ä–≤–µ—Ä–æ–º Google.<br>
            –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ –≤–∏ –∑—Ä–æ–±–∏–ª–∏ Deployment —è–∫ "Anyone".
            <small>${e.message}</small>
          </div>`;
      }
    }

    // –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É
    function render(data) {
      const app = document.getElementById('app');
      let html = `
        <div class="btn-row">
          <button onclick="init(0)" class="${data.isTomorrow ? 'inactive' : ''}">–°—å–æ–≥–æ–¥–Ω—ñ</button>
          <button onclick="init(1)" class="${data.isTomorrow ? '' : 'inactive'}">–ó–∞–≤—Ç—Ä–∞</button>
        </div>
        <div class="card">
          <div style="font-size: 18px; margin-bottom: 8px;">üìç –ß–µ—Ä–≥–∞ <b>${data.queue}</b> (–í—ñ–Ω–Ω–∏—Ü—è)</div>
          <div style="color: var(--hint); font-size: 14px; margin-bottom: 12px;">üìÖ ${data.date}</div>
          <div class="${data.status.includes('–í–Ü–î–°–£–¢–ù–Ñ') ? 'status-off' : 'status-on'}">${data.status}</div>
        </div>
        <div class="grid">
      `;

      const nowH = new Date().getHours();
      
      for (let h = 0; h < 24; h++) {
        const firstHalf = isOff(h, 15, data.slots);
        const secondHalf = isOff(h, 45, data.slots);
        
        let cls = 'hour';
        if (firstHalf && secondHalf) cls += ' off-full';
        else if (firstHalf) cls += ' off-left';
        else if (secondHalf) cls += ' off-right';
        
        // –ü—ñ–¥—Å–≤—ñ—á—É—î–º–æ –ø–æ—Ç–æ—á–Ω—É –≥–æ–¥–∏–Ω—É –ª–∏—à–µ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ "–°—å–æ–≥–æ–¥–Ω—ñ"
        if (h === nowH && !data.isTomorrow) cls += ' current';

        html += `<div class="${cls}">${h < 10 ? '0'+h : h}:00</div>`;
      }

      html += `</div>`;
      app.innerHTML = html;
    }

    // –õ–æ–≥—ñ–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —á–∏ –≤–∏–º–∫–Ω–µ–Ω–æ –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π —á–∞—Å
    function isOff(h, m, slots) {
      if (!slots) return false;
      const time = h * 60 + m;
      return slots.some(s => {
        if (!s.isOutage) return false;
        const [sh, sm] = s.start.split(':').map(Number);
        let [eh, em] = s.end.split(':').map(Number);
        if (eh === 0 && em === 0) eh = 24; // –û–±—Ä–æ–±–∫–∞ 00:00 —è–∫ –∫—ñ–Ω—Ü—è –¥–æ–±–∏
        return time >= (sh * 60 + sm) && time < (eh * 60 + em);
      });
    }

    // –°—Ç–∞—Ä—Ç –¥–æ–¥–∞—Ç–∫–∞
    window.onload = () => init(0);
  </script>
</body>
</html>
