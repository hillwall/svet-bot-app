<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>–°–≤—ñ—Ç–ª–æ –í—ñ–Ω–Ω–∏—Ü—è</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg: var(--tg-theme-bg-color, #f0f2f5);
      --card: var(--tg-theme-secondary-bg-color, #ffffff);
      --text: var(--tg-theme-text-color, #222);
      --hint: var(--tg-theme-hint-color, #777);
      --accent: #2481cc;
      --color-dark: #00193a;
    }
    body { font-family: sans-serif; background: var(--bg); color: var(--text); padding: 15px; margin: 0; }
    .card { background: var(--card); border-radius: 12px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 15px; }
    .status-on { color: #2ecc71; font-weight: bold; }
    .status-off { color: #e74c3c; font-weight: bold; }
    .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 15px; }
    .hour { padding: 10px 5px; text-align: center; border-radius: 8px; font-size: 12px; background: #eee; border: 1px solid #ddd; }
    .off-full { background: var(--color-dark); color: white; border-color: var(--color-dark); }
    .off-left { background: linear-gradient(90deg, var(--color-dark) 50%, #eee 50%); }
    .off-right { background: linear-gradient(90deg, #eee 50%, var(--color-dark) 50%); }
    .current { border: 2px solid var(--accent); transform: scale(1.05); font-weight: bold; }
    .btn-row { display: flex; gap: 10px; margin-bottom: 15px; }
    button { flex: 1; padding: 12px; border-radius: 10px; border: none; background: var(--accent); color: white; font-weight: bold; }
    button.inactive { opacity: 0.5; }
    .loader { text-align: center; padding: 40px; font-style: italic; color: var(--hint); }
    .error-box { background: #fff5f5; color: #e74c3c; padding: 15px; border-radius: 10px; border: 1px solid #ffc1c1; text-align: center; }
  </style>
</head>
<body>
  <div id="app">
    <div class="loader">–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è...</div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    
    // –í–ê–ñ–õ–ò–í–û: –ó–ê–ú–Ü–ù–ò –ù–ê –°–í–û–Ñ –ù–û–í–ï –ü–û–°–ò–õ–ê–ù–ù–Ø –ü–Ü–°–õ–Ø NEW DEPLOYMENT
    const webAppUrl = "–¢–£–¢_–í–°–¢–ê–í_–ü–û–°–ò–õ–ê–ù–ù–Ø_–©–û_–û–¢–†–ò–ú–ê–í_–ü–Ü–°–õ–Ø_DEPLOY"; 

    const chatId = tg.initDataUnsafe?.user?.id || "197183975";

    async function callApi(action, params = {}) {
      const query = new URLSearchParams({ action, chatId, ...params }).toString();
      const response = await fetch(`${webAppUrl}?${query}`);
      if (!response.ok) throw new Error("–°–µ—Ä–≤–µ—Ä GAS –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–≤");
      return await response.json();
    }

    async function init(offset = 0) {
      const app = document.getElementById('app');
      app.innerHTML = '<div class="loader">–û–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö...</div>';
      
      try {
        const data = await callApi('getData', { offset });
        if (data.error) {
          app.innerHTML = `<div class="error-box"><b>üìç –ß–µ—Ä–≥–∞ ${data.queue || '?'}</b><br><br>${data.error}</div>`;
          return;
        }
        render(data);
      } catch (e) {
        app.innerHTML = `<div class="error-box">–ü–æ–º–∏–ª–∫–∞ –∑–≤'—è–∑–∫—É.<br><small>${e.message}</small><br><br>–ü–µ—Ä–µ–≤—ñ—Ä —á–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤–∫–∞–∑–∞–Ω–æ Web App URL —Ç–∞ —á–∏ –∑—Ä–æ–±–ª–µ–Ω–æ New Deployment.</div>`;
      }
    }

    function render(data) {
      const app = document.getElementById('app');
      let html = `
        <div class="btn-row">
          <button onclick="init(0)" class="${data.isTomorrow ? 'inactive' : ''}">–°—å–æ–≥–æ–¥–Ω—ñ</button>
          <button onclick="init(1)" class="${data.isTomorrow ? '' : 'inactive'}">–ó–∞–≤—Ç—Ä–∞</button>
        </div>
        <div class="card">
          <div style="font-size: 18px; margin-bottom: 8px;">üìç –ß–µ—Ä–≥–∞ <b>${data.queue}</b></div>
          <div style="color: var(--hint); font-size: 14px; margin-bottom: 12px;">üìÖ ${data.date}</div>
          <div class="${data.status.includes('–í–Ü–î–°–£–¢–ù–Ñ') ? 'status-off' : 'status-on'}">${data.status}</div>
        </div>
        <div class="grid">
      `;

      const nowH = new Date().getHours();
      for (let h = 0; h < 24; h++) {
        const first = isOff(h, 15, data.slots);
        const second = isOff(h, 45, data.slots);
        let cls = 'hour';
        if (first && second) cls += ' off-full';
        else if (first) cls += ' off-left';
        else if (second) cls += ' off-right';
        if (h === nowH && !data.isTomorrow) cls += ' current';
        html += `<div class="${cls}">${h < 10 ? '0'+h : h}:00</div>`;
      }
      html += `</div>`;
      app.innerHTML = html;
    }

    function isOff(h, m, slots) {
      const time = h * 60 + m;
      return slots.some(s => {
        if (!s.isOutage) return false;
        const [sh, sm] = s.start.split(':').map(Number);
        let [eh, em] = s.end.split(':').map(Number);
        if (eh === 0 && em === 0) eh = 24;
        return time >= (sh * 60 + sm) && time < (eh * 60 + em);
      });
    }

    window.onload = () => init(0);
  </script>
</body>
</html>
