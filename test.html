<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root { --bg: var(--tg-theme-bg-color, #ffffff); --text: var(--tg-theme-text-color, #222); --accent: #2481cc; }
    body { font-family: sans-serif; background: var(--bg); color: var(--text); padding: 15px; margin: 0; }
    .card { background: var(--tg-theme-secondary-bg-color, #f0f2f5); padding: 15px; border-radius: 12px; margin-bottom: 15px; }
    select, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #ccc; font-size: 16px; }
    button { background: var(--accent); color: white; border: none; font-weight: bold; }
    .grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px; }
    .hour { font-size: 10px; text-align: center; padding: 10px 2px; border-radius: 5px; background: #ddd; }
    .off { background: #00193a; color: #fff; }
    .on { background: #e6e6a1; color: #000; }
    .tabs { display: flex; gap: 5px; margin-bottom: 15px; }
    .tab { flex: 1; padding: 10px; text-align: center; background: #eee; border-radius: 8px; cursor: pointer; font-weight: bold; }
    .tab.active { background: var(--accent); color: white; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div id="setup-view">
    <h3>üåç –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ç–µ—Å—Ç—É</h3>
    <label>–û–±–µ—Ä—ñ—Ç—å –æ–±–ª–∞—Å—Ç—å:</label>
    <select id="reg-sel" onchange="loadQueues()"><option>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</option></select>
    <div id="q-box" class="hidden">
      <label>–û–±–µ—Ä—ñ—Ç—å —á–µ—Ä–≥—É:</label>
      <select id="q-sel"></select>
      <button onclick="save()">–ó–±–µ—Ä–µ–≥—Ç–∏ –≤–∏–±—ñ—Ä</button>
    </div>
  </div>

  <div id="main-view" class="hidden">
    <div class="tabs">
      <div id="t0" class="tab active" onclick="loadSched(0)">–°—å–æ–≥–æ–¥–Ω—ñ</div>
      <div id="t1" class="tab" onclick="loadSched(1)">–ó–∞–≤—Ç—Ä–∞</div>
    </div>
    <div class="card">
      <h2 id="status">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</h2>
      <div id="grid" class="grid"></div>
    </div>
    <button onclick="document.getElementById('setup-view').classList.remove('hidden'); document.getElementById('main-view').classList.add('hidden');">‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</button>
  </div>

<script>
  const tg = window.Telegram.WebApp;
  // –¢–ï–°–¢–û–í–ò–ô URL –í–ï–ë-–î–û–î–ê–¢–ö–ê
  const API = "https://script.google.com/macros/s/AKfycbx0_wj63qj6n3ADHCuHpaTdz-5NmQ61ZWSFKNCjaAkvSsmbBncpiITnkqFN3salqppCAA/exec";
  const user = tg.initDataUnsafe.user || { id: "197183975" };

  async function init() {
    tg.expand();
    try {
      const r = await fetch(API + "?action=getRegions");
      const data = await r.json();
      const sel = document.getElementById('reg-sel');
      sel.innerHTML = '<option value="">-- –û–±–µ—Ä—ñ—Ç—å –æ–±–ª–∞—Å—Ç—å --</option>';
      data.forEach(item => sel.innerHTML += `<option value="${item.url}">${item.name}</option>`);
    } catch(e) { console.error("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –æ–±–ª–∞—Å—Ç–µ–π"); }
  }

  async function loadQueues() {
    const url = document.getElementById('reg-sel').value;
    if(!url) return;
    const r = await fetch(API + "?action=getQueues&regionUrl=" + encodeURIComponent(url));
    const data = await r.json();
    const sel = document.getElementById('q-sel');
    sel.innerHTML = '';
    data.forEach(item => sel.innerHTML += `<option value="${item.url}">${item.name}</option>`);
    document.getElementById('q-box').classList.remove('hidden');
  }

  async function save() {
    const q = document.getElementById('q-sel');
    const url = q.value;
    const name = q.options[q.selectedIndex].text;
    await fetch(`${API}?action=saveSelection&chatId=${user.id}&url=${encodeURIComponent(url)}&name=${encodeURIComponent(name)}`);
    loadSched(0);
  }

  async function loadSched(offset) {
    document.getElementById('setup-view').classList.add('hidden');
    document.getElementById('main-view').classList.remove('hidden');
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById('t' + offset).classList.add('active');

    const r = await fetch(`${API}?action=getSchedule&chatId=${user.id}&offset=${offset}`);
    const data = await r.json();
    document.getElementById('status').innerText = data.status || "–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö";
    
    const grid = document.getElementById('grid');
    grid.innerHTML = '';
    // –í—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ 24 –≥–æ–¥–∏–Ω–∏
    for(let h=0; h<24; h++) {
      const isOff = data.slots && data.slots[h] === 1;
      grid.innerHTML += `<div class="hour ${isOff ? 'off' : 'on'}">${h}:00</div>`;
    }
  }

  init();
</script>
</body>
</html>
