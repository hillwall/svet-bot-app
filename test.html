<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg: var(--tg-theme-bg-color, #f0f2f5);
      --card: var(--tg-theme-secondary-bg-color, #ffffff);
      --text: var(--tg-theme-text-color, #222);
      --accent: #2481cc;
      --color-light: #e6e6a1;
      --color-dark: #00193a;
      --white: #ffffff;
    }
    body { font-family: sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 12px; }
    .view { display: none; }
    .view.active { display: block; }
    select, .btn { width: 100%; padding: 12px; margin-top: 10px; border-radius: 10px; border: 1px solid #ccc; font-size: 16px; box-sizing: border-box; }
    .btn { background: var(--accent); color: white; font-weight: bold; cursor: pointer; border: none; }
    .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 15px; }
    .hour { padding: 8px 2px; text-align: center; border-radius: 8px; font-size: 12px; font-weight: bold; background: var(--white); border: 1px solid #ddd; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .off { background: var(--color-dark) !important; color: white !important; }
    .tabs { display: flex; gap: 5px; margin-bottom: 15px; }
    .tab { flex: 1; padding: 10px; text-align: center; background: #ddd; border-radius: 8px; cursor: pointer; }
    .tab.active { background: var(--accent); color: white; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .status-card { padding: 15px; border-radius: 12px; text-align: center; font-weight: bold; margin-bottom: 15px; border: 1px solid #ddd; background: var(--card); }
  </style>
</head>
<body>

  <div id="setup-view" class="view">
    <h3>üîß –í–∏–±—ñ—Ä –æ–±–ª–∞—Å—Ç—ñ —Ç–∞ —á–µ—Ä–≥–∏</h3>
    <select id="region" onchange="loadQueues()">
      <option value="">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</option>
    </select>
    <select id="queue" disabled style="margin-top:15px;">
      <option value="">–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –æ–±–ª–∞—Å—Ç—å</option>
    </select>
    <button id="save-btn" class="btn" onclick="saveSelection()" disabled style="opacity:0.6; margin-top:20px;">–ó–±–µ—Ä–µ–≥—Ç–∏ –≤–∏–±—ñ—Ä</button>
  </div>

  <div id="schedule-view" class="view">
    <div class="header">
      <div id="info" style="font-weight:bold; font-size:14px;"></div>
      <button class="btn" style="width:auto; padding:5px 15px; margin:0;" onclick="showSetup()">‚úèÔ∏è –ó–º—ñ–Ω–∏—Ç–∏</button>
    </div>
    <div class="tabs">
      <div id="tab0" class="tab active" onclick="loadSchedule(0)">–°–¨–û–ì–û–î–ù–Ü</div>
      <div id="tab1" class="tab" onclick="loadSchedule(1)">–ó–ê–í–¢–†–ê</div>
    </div>
    <div id="status" class="status-card"></div>
    <div id="grid" class="grid"></div>
  </div>

<script>
  // ‚ùóÔ∏è –ó–ê–ú–Ü–ù–ò –ù–ê –°–í–û–Ñ –ü–û–°–ò–õ–ê–ù–ù–Ø –í–Ü–î GOOGLE APPS SCRIPT
  const API = "https://script.google.com/macros/s/AKfyc...—Ç–≤—ñ–π_id.../exec"; 
  
  let tg = window.Telegram.WebApp;
  const userId = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : "197183975"; 

  async function init() {
    tg.expand();
    try {
      const res = await fetch(`${API}?action=checkUser&chatId=${userId}`);
      const data = await res.json();
      if (data.hasQueue) showSchedule();
      else showSetup();
    } catch(e) {
      alert("–ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è –∑ —Å–µ—Ä–≤–µ—Ä–æ–º. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.");
    }
  }

  async function showSetup() {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.getElementById('setup-view').classList.add('active');
    
    const sel = document.getElementById('region');
    sel.innerHTML = '<option>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</option>';
    
    const res = await fetch(`${API}?action=getRegions`);
    const regions = await res.json();
    
    if(!regions || regions.length === 0) {
      sel.innerHTML = '<option>‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞: –°–ø–∏—Å–æ–∫ –ø—É—Å—Ç–∏–π</option>';
      return;
    }

    sel.innerHTML = '<option value="">-- –û–±–µ—Ä—ñ—Ç—å –æ–±–ª–∞—Å—Ç—å --</option>';
    regions.forEach(r => sel.innerHTML += `<option value="${r.url}">${r.name}</option>`);
  }

  async function loadQueues() {
    const url = document.getElementById('region').value;
    const qSel = document.getElementById('queue');
    const btn = document.getElementById('save-btn');
    
    qSel.innerHTML = '<option>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</option>';
    qSel.disabled = true;
    btn.disabled = true;
    btn.style.opacity = '0.6';

    if (!url) return;

    const res = await fetch(`${API}?action=getQueues&regionUrl=${url}`);
    const queues = await res.json();

    qSel.innerHTML = '<option value="">-- –û–±–µ—Ä—ñ—Ç—å —á–µ—Ä–≥—É --</option>';
    queues.forEach(q => {
      // –î–æ–¥–∞—î–º–æ –Ω–∞–∑–≤—É —á–µ—Ä–≥–∏ –≤ –∞—Ç—Ä–∏–±—É—Ç, —â–æ–± –ø–æ—Ç—ñ–º –∑–±–µ—Ä–µ–≥—Ç–∏
      qSel.innerHTML += `<option value="${q.url}" data-name="${q.name}">${q.name}</option>`;
    });
    qSel.disabled = false;
  }
  
  // –ê–∫—Ç–∏–≤–∞—Ü—ñ—è –∫–Ω–æ–ø–∫–∏
  document.getElementById('queue').addEventListener('change', function() {
      const btn = document.getElementById('save-btn');
      if(this.value) { btn.disabled = false; btn.style.opacity = '1'; }
  });

  async function saveSelection() {
    const regSel = document.getElementById('region');
    const qSel = document.getElementById('queue');
    const regionName = regSel.options[regSel.selectedIndex].text;
    const queueName = qSel.options[qSel.selectedIndex].getAttribute('data-name');
    const queueUrl = qSel.value;
    
    if(!queueUrl) return;

    document.getElementById('save-btn').innerText = "–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...";
    await fetch(`${API}?action=saveUser&chatId=${userId}&queue=${encodeURIComponent(queueName)}&url=${encodeURIComponent(queueUrl)}&regionName=${encodeURIComponent(regionName)}`);
    document.getElementById('save-btn').innerText = "–ó–±–µ—Ä–µ–≥—Ç–∏ –≤–∏–±—ñ—Ä";
    showSchedule();
  }

  function showSchedule() {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.getElementById('schedule-view').classList.add('active');
    loadSchedule(0);
  }

  async function loadSchedule(offset) {
    document.getElementById('tab0').classList.toggle('active', offset === 0);
    document.getElementById('tab1').classList.toggle('active', offset === 1);
    
    const grid = document.getElementById('grid');
    const statusEl = document.getElementById('status');
    
    grid.innerHTML = '<div style="grid-column: span 4; text-align:center; padding:20px;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';
    statusEl.innerHTML = '...';

    const res = await fetch(`${API}?action=getSchedule&chatId=${userId}&offset=${offset}`);
    const data = await res.json();
    
    if (data.error) {
      grid.innerHTML = `<div style="grid-column: span 4; text-align:center; color:red;">${data.error}</div>`;
      statusEl.innerText = "–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö";
      return;
    }

    document.getElementById('info').innerText = `${data.region}, ${data.queue}`;
    const isOutage = (data.status === "–í–Ü–î–°–£–¢–ù–Ñ");
    
    statusEl.innerText = isOutage ? "üí° –°–≤—ñ—Ç–ª–æ –Ω–∞—Ä–∞–∑—ñ –í–Ü–î–°–£–¢–ù–Ñ" : "üîÜ –°–≤—ñ—Ç–ª–æ –Ω–∞—Ä–∞–∑—ñ –Ñ";
    statusEl.style.background = isOutage ? "var(--color-dark)" : "var(--color-light)";
    statusEl.style.color = isOutage ? "white" : "black";

    grid.innerHTML = '';
    data.slots.forEach(s => {
      const cell = document.createElement('div');
      cell.className = `hour ${s.isOutage ? 'off' : ''}`;
      cell.innerHTML = `<span>${s.start}</span><span style="font-size:16px;">${s.isOutage ? 'üåë' : 'üåï'}</span>`;
      grid.appendChild(cell);
    });
  }

  init();
</script>
</body>
</html>
