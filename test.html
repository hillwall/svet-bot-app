<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: var(--tg-theme-bg-color, #ffffff);
            --text: var(--tg-theme-text-color, #222222);
            --hint: var(--tg-theme-hint-color, #999999);
            --btn-bg: var(--tg-theme-button-color, #2481cc);
            --btn-text: var(--tg-theme-button-text-color, #ffffff);
            --secondary: var(--tg-theme-secondary-bg-color, #f0f2f5);
        }
        body { font-family: sans-serif; background-color: var(--bg); color: var(--text); padding: 20px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-size: 14px; color: var(--hint); }
        select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ccc; background: var(--secondary); color: var(--text); font-size: 16px; }
        select:disabled { opacity: 0.5; }
        .btn { background: var(--btn-bg); color: var(--btn-text); border: none; padding: 16px; border-radius: 12px; font-size: 16px; width: 100%; font-weight: bold; cursor: pointer; }
        .loader { font-size: 12px; color: var(--btn-bg); display: none; margin-top: 5px; }
    </style>
</head>
<body>
    <div id="app">
        <h3>üìç –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ª–æ–∫–∞—Ü—ñ—ó</h3>
        <div class="form-group">
            <label>1. –û–±–ª–∞—Å—Ç—å:</label>
            <select id="region" onchange="onRegionChange()"><option value="">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</option></select>
        </div>
        <div class="form-group">
            <label>2. –ú—ñ—Å—Ç–æ / –†–∞–π–æ–Ω:</label>
            <select id="city" disabled onchange="onCityChange()"><option value="">–û–±–µ—Ä—ñ—Ç—å –æ–±–ª–∞—Å—Ç—å</option></select>
            <div id="city-loader" class="loader">–®—É–∫–∞—î–º–æ –º—ñ—Å—Ç–∞...</div>
        </div>
        <div class="form-group">
            <label>3. –ß–µ—Ä–≥–∞ / –í—É–ª–∏—Ü—è:</label>
            <select id="queue" disabled onchange="validate()"><option value="">–û–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ç–æ –∞–±–æ –æ–±–ª–∞—Å—Ç—å</option></select>
            <div id="queue-loader" class="loader">–®—É–∫–∞—î–º–æ —á–µ—Ä–≥–∏...</div>
        </div>
        <button id="save-btn" class="btn" disabled onclick="save()">–ó–±–µ—Ä–µ–≥—Ç–∏ –≤–∏–±—ñ—Ä</button>
    </div>

    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbx0_wj63qj6n3ADHCuHpaTdz-5NmQ61ZWSFKNCjaAkvSsmbBncpiITnkqFN3salqppCAA/exec";
        let tg = window.Telegram.WebApp;
        tg.expand();

        async function init() {
            const res = await fetch(`${WEB_APP_URL}?action=getRegions`);
            const data = await res.json();
            const sel = document.getElementById('region');
            sel.innerHTML = '<option value="">-- –û–±–µ—Ä—ñ—Ç—å –æ–±–ª–∞—Å—Ç—å --</option>';
            data.forEach(r => sel.innerHTML += `<option value="${r.url}">${r.name}</option>`);
        }

        async function onRegionChange() {
            const url = document.getElementById('region').value;
            const citySel = document.getElementById('city');
            const queueSel = document.getElementById('queue');
            
            citySel.innerHTML = '<option value="">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</option>';
            citySel.disabled = true;
            queueSel.innerHTML = '<option value="">–®—É–∫–∞—î–º–æ —á–µ—Ä–≥–∏...</option>';
            queueSel.disabled = true;

            if (!url) return;
            document.getElementById('city-loader').style.display = 'block';

            const res = await fetch(`${WEB_APP_URL}?action=getChildren&url=${encodeURIComponent(url)}`);
            const data = await res.json();

            // –§—ñ–ª—å—Ç—Ä—É—î–º–æ –æ—Ç—Ä–∏–º–∞–Ω—ñ –¥–∞–Ω—ñ
            const cities = data.filter(item => !item.isQueue);
            const queues = data.filter(item => item.isQueue);

            // –ó–∞–ø–æ–≤–Ω—é—î–º–æ –º—ñ—Å—Ç–∞
            if (cities.length > 0) {
                citySel.innerHTML = '<option value="">-- –û–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ç–æ --</option>';
                cities.forEach(c => citySel.innerHTML += `<option value="${c.url}">${c.name}</option>`);
                citySel.disabled = false;
            } else {
                citySel.innerHTML = '<option value="">–ú—ñ—Å—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</option>';
            }

            // –ó–∞–ø–æ–≤–Ω—é—î–º–æ —á–µ—Ä–≥–∏ (—è–∫—â–æ –≤–æ–Ω–∏ —î –ø—Ä—è–º–æ –≤ –æ–±–ª–∞—Å—Ç—ñ)
            if (queues.length > 0) {
                queueSel.innerHTML = '<option value="">-- –û–±–µ—Ä—ñ—Ç—å —á–µ—Ä–≥—É --</option>';
                queues.forEach(q => queueSel.innerHTML += `<option value="${q.url}">${q.name}</option>`);
                queueSel.disabled = false;
            } else {
                queueSel.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ç–æ —Å–ø–æ—á–∞—Ç–∫—É</option>';
            }

            document.getElementById('city-loader').style.display = 'none';
            validate();
        }

        async function onCityChange() {
            const url = document.getElementById('city').value;
            const queueSel = document.getElementById('queue');
            if (!url) return;

            queueSel.innerHTML = '<option value="">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —á–µ—Ä–≥...</option>';
            queueSel.disabled = true;
            document.getElementById('queue-loader').style.display = 'block';

            const res = await fetch(`${WEB_APP_URL}?action=getChildren&url=${encodeURIComponent(url)}`);
            const data = await res.json();

            if (data.length > 0) {
                queueSel.innerHTML = '<option value="">-- –û–±–µ—Ä—ñ—Ç—å —á–µ—Ä–≥—É/–≤—É–ª–∏—Ü—é --</option>';
                data.forEach(q => queueSel.innerHTML += `<option value="${q.url}">${q.name}</option>`);
                queueSel.disabled = false;
            } else {
                queueSel.innerHTML = '<option value="">–ß–µ—Ä–≥ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</option>';
            }
            document.getElementById('queue-loader').style.display = 'none';
            validate();
        }

        function validate() {
            const region = document.getElementById('region').value;
            document.getElementById('save-btn').disabled = !region;
        }

        async function save() {
            const region = document.getElementById('region');
            const city = document.getElementById('city');
            const queue = document.getElementById('queue');
            
            const finalUrl = queue.value || city.value || region.value;
            const finalName = queue.selectedOptions[0]?.text || city.selectedOptions[0]?.text || region.selectedOptions[0]?.text;
            const chatId = tg.initDataUnsafe.user?.id || "197183975";

            const btn = document.getElementById('save-btn');
            btn.disabled = true;
            btn.innerText = "–ó–±–µ—Ä—ñ–≥–∞—î–º–æ...";

            await fetch(`${WEB_APP_URL}?action=saveSelection&chatId=${chatId}&url=${encodeURIComponent(finalUrl)}&name=${encodeURIComponent(finalName)}`);
            tg.close();
        }

        init();
    </script>
</body>
</html>
