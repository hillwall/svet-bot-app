<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
:root {
  --bg:#f3f4f6;
  --card:#fff;
  --accent:#2563eb;
  --off:#0f172a;
  --on:#fde68a;
}
body {
  margin:0;
  font-family:system-ui,-apple-system;
  background:var(--bg);
  padding:12px;
}
.card {
  background:var(--card);
  border-radius:14px;
  padding:14px;
  margin-bottom:12px;
}
h2 {margin:0 0 10px}
select,button {
  width:100%;
  padding:10px;
  border-radius:10px;
  border:1px solid #ddd;
  font-size:15px;
}
button {
  background:var(--accent);
  color:#fff;
  border:none;
  margin-top:8px;
}
.tabs {
  display:flex;
  gap:6px;
}
.tab {
  flex:1;
  padding:8px;
  border-radius:8px;
  background:#e5e7eb;
  text-align:center;
  font-weight:600;
}
.tab.active {
  background:var(--card);
  box-shadow:0 2px 6px rgba(0,0,0,.1);
}
.grid {
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:6px;
}
.hour {
  font-size:12px;
  padding:6px;
  border-radius:8px;
  background:#fff;
  text-align:center;
}
.off {background:var(--off);color:#fde68a}
.on {background:var(--on)}
.current {outline:3px solid var(--accent)}
.status {
  padding:12px;
  border-radius:12px;
  font-weight:600;
  text-align:center;
}
.status.on {background:var(--on)}
.status.off {background:var(--off);color:#fde68a}
</style>
</head>

<body>

<div id="step-select" class="card">
  <h2>Оберіть область</h2>
  <select id="region"></select>

  <h2 style="margin-top:10px">Оберіть чергу</h2>
  <select id="queue"></select>

  <button onclick="save()">Зберегти</button>
</div>

<div id="step-schedule" style="display:none">

  <div class="card">
    <div class="tabs">
      <div class="tab active" onclick="load(0)" id="t0">Сьогодні</div>
      <div class="tab" onclick="load(1)" id="t1">Завтра</div>
    </div>
  </div>

  <div id="status" class="card status">Завантаження…</div>
  <div id="grid" class="card grid"></div>

</div>

<script>
const tg = Telegram.WebApp;
tg.expand();

const API_URL = "https://script.google.com/macros/s/AKfycbx0_wj63qj6n3ADHCuHpaTdz-5NmQ61ZWSFKNCjaAkvSsmbBncpiITnkqFN3salqppCAA/exec";
const chatId = tg.initDataUnsafe.user?.id || "test";

async function api(p){
  const r = await fetch(API_URL + "?" + new URLSearchParams(p));
  return r.json();
}

async function init(){
  const regions = await api({action:"getRegions"});
  const rSel = document.getElementById("region");
  regions.forEach(r=>{
    const o=document.createElement("option");
    o.value=r.url; o.text=r.name;
    rSel.appendChild(o);
  });
  loadQueues();
}

async function loadQueues(){
  const regionUrl = region.value;
  const qs = await api({action:"getQueues", region:regionUrl});
  const qSel = document.getElementById("queue");
  qSel.innerHTML="";
  qs.forEach(q=>{
    const o=document.createElement("option");
    o.value=q.url; o.text=q.name;
    qSel.appendChild(o);
  });
}
region.onchange=loadQueues;

async function save(){
  const rName = region.options[region.selectedIndex].text;
  const qName = queue.options[queue.selectedIndex].text;
  const qUrl = queue.value;

  await api({
    action:"saveSelection",
    chatId,
    region_name:rName,
    queue_name:qName,
    queue_url:qUrl
  });

  document.getElementById("step-select").style.display="none";
  document.getElementById("step-schedule").style.display="block";
  load(0);
}

async function load(offset){
  t0.classList.toggle("active",offset===0);
  t1.classList.toggle("active",offset===1);

  const d = await api({action:"getSchedule",chatId,offset});
  if(d.error){
    status.innerText=d.error;
    return;
  }

  status.className="card status "+(d.status.includes("ВІДСУТНЄ")?"off":"on");
  status.innerHTML=d.status.replace(/\n/g,"<br>");

  grid.innerHTML="";
  const nowH=new Date().getHours();

  for(let h=0;h<24;h++){
    const cell=document.createElement("div");
    cell.className="hour";
    if(isOff(h,15,d.slots)&&isOff(h,45,d.slots)) cell.classList.add("off");
    else cell.classList.add("on");
    if(h===nowH && offset===0) cell.classList.add("current");
    cell.innerText=`${String(h).padStart(2,"0")}-${String(h+1).padStart(2,"0")}`;
    grid.appendChild(cell);
  }
}

function isOff(h,m,slots){
  const t=h*60+m;
  return slots.some(s=>{
    if(!s.isOutage) return false;
    const a=s.start.split(":").map(Number);
    const b=s.end==="00:00"?[24,0]:s.end.split(":").map(Number);
    return t>=a[0]*60+a[1] && t<b[0]*60+b[1];
  });
}

init();
</script>
</body>
</html>
