<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg: var(--tg-theme-bg-color, #f0f2f5);
      --card: var(--tg-theme-secondary-bg-color, #ffffff);
      --text: var(--tg-theme-text-color, #222);
      --hint: var(--tg-theme-hint-color, #777);
      --accent: #2481cc;
      --color-light: #e6e6a1;
      --color-dark: #00193a;
      --white: #ffffff;
    }
    body { font-family: sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 12px; }
    .view { display: none; }
    .view.active { display: block; }
    select, .btn { width: 100%; padding: 12px; margin-top: 10px; border-radius: 10px; border: 1px solid #ccc; font-size: 16px; }
    .btn { background: var(--accent); color: white; font-weight: bold; cursor: pointer; border: none; }
    .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 15px; }
    .hour { padding: 10px 5px; text-align: center; border-radius: 8px; font-size: 12px; font-weight: bold; background: var(--white); border: 1px solid #ddd; }
    .off { background: var(--color-dark) !important; color: var(--color-light) !important; }
    .tabs { display: flex; gap: 5px; margin-bottom: 15px; }
    .tab { flex: 1; padding: 10px; text-align: center; background: #ddd; border-radius: 8px; cursor: pointer; }
    .tab.active { background: var(--accent); color: white; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .status-card { padding: 15px; border-radius: 12px; text-align: center; font-weight: bold; margin-bottom: 15px; }
  </style>
</head>
<body>

  <div id="setup-view" class="view">
    <h3>üîß –í–∏–±—ñ—Ä –æ–±–ª–∞—Å—Ç—ñ —Ç–∞ —á–µ—Ä–≥–∏</h3>
    <label>–û–±–ª–∞—Å—Ç—å:</label>
    <select id="region" onchange="loadQueues()"><option>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</option></select>
    <label>–ß–µ—Ä–≥–∞:</label>
    <select id="queue" disabled><option>–û–±–µ—Ä—ñ—Ç—å –æ–±–ª–∞—Å—Ç—å</option></select>
    <button id="save-btn" class="btn" onclick="saveSelection()">–ó–±–µ—Ä–µ–≥—Ç–∏ –≤–∏–±—ñ—Ä</button>
  </div>

  <div id="schedule-view" class="view">
    <div class="header">
      <div id="info" style="font-weight:bold">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
      <button class="btn" style="width:auto; padding: 5px 10px;" onclick="showSetup()">üîÑ –ó–º—ñ–Ω–∏—Ç–∏</button>
    </div>
    <div class="tabs">
      <div id="tab0" class="tab active" onclick="loadSchedule(0)">–°–¨–û–ì–û–î–ù–Ü</div>
      <div id="tab1" class="tab" onclick="loadSchedule(1)">–ó–ê–í–¢–†–ê</div>
    </div>
    <div id="status" class="status-card"></div>
    <div id="grid" class="grid"></div>
  </div>

<script>
  const API = "–¢–í–û–Ø_URL_GAS_–í–Ü–î_WEB_APP";
  let tg = window.Telegram.WebApp;
  const userId = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : "197183975";

  async function init() {
    tg.expand();
    const res = await fetch(`${API}?action=checkUser&chatId=${userId}`);
    const data = await res.json();
    if (data.hasQueue) {
      showSchedule();
    } else {
      showSetup();
    }
  }

  async function showSetup() {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.getElementById('setup-view').classList.add('active');
    const res = await fetch(`${API}?action=getRegions`);
    const regions = await res.json();
    const sel = document.getElementById('region');
    sel.innerHTML = '<option value="">-- –û–±–µ—Ä—ñ—Ç—å –æ–±–ª–∞—Å—Ç—å --</option>';
    regions.forEach(r => sel.innerHTML += `<option value="${r.url}">${r.name}</option>`);
  }

  async function loadQueues() {
    const url = document.getElementById('region').value;
    if (!url) return;
    const res = await fetch(`${API}?action=getQueues&regionUrl=${url}`);
    const queues = await res.json();
    const sel = document.getElementById('queue');
    sel.innerHTML = '';
    queues.forEach(q => sel.innerHTML += `<option value="${q.url}" data-name="${q.name}">${q.name}</option>`);
    sel.disabled = false;
  }

  async function saveSelection() {
    const regSel = document.getElementById('region');
    const qSel = document.getElementById('queue');
    const regionName = regSel.options[regSel.selectedIndex].text;
    const queueName = qSel.options[qSel.selectedIndex].getAttribute('data-name');
    const queueUrl = qSel.value;

    await fetch(`${API}?action=saveUser&chatId=${userId}&queue=${queueName}&url=${queueUrl}&regionName=${regionName}`);
    showSchedule();
  }

  function showSchedule() {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.getElementById('schedule-view').classList.add('active');
    loadSchedule(0);
  }

  async function loadSchedule(offset) {
    document.getElementById('tab0').classList.toggle('active', offset === 0);
    document.getElementById('tab1').classList.toggle('active', offset === 1);
    
    const res = await fetch(`${API}?action=getSchedule&chatId=${userId}&offset=${offset}`);
    const data = await res.json();
    
    if (data.error) {
      document.getElementById('status').innerText = data.error;
      return;
    }

    document.getElementById('info').innerText = `${data.region}, —á–µ—Ä–≥–∞ ${data.queue}`;
    const statusEl = document.getElementById('status');
    statusEl.innerText = data.status === "–í–Ü–î–°–£–¢–ù–Ñ" ? "üí° –°–≤—ñ—Ç–ª–æ –Ω–∞—Ä–∞–∑—ñ –í–Ü–î–°–£–¢–ù–Ñ" : "üîÜ –°–≤—ñ—Ç–ª–æ –Ω–∞—Ä–∞–∑—ñ –Ñ";
    statusEl.style.background = data.status === "–í–Ü–î–°–£–¢–ù–Ñ" ? "var(--color-dark)" : "var(--color-light)";
    statusEl.style.color = data.status === "–í–Ü–î–°–£–¢–ù–Ñ" ? "white" : "black";

    const grid = document.getElementById('grid');
    grid.innerHTML = '';
    data.slots.forEach(s => {
      const cell = document.createElement('div');
      cell.className = `hour ${s.isOutage ? 'off' : ''}`;
      cell.innerText = `${s.start}\n${s.isOutage ? 'üåë' : 'üåï'}`;
      grid.appendChild(cell);
    });
  }

  init();
</script>
</body>
</html>
