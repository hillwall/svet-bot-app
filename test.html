<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg: var(--tg-theme-bg-color, #f0f2f5);
      --card: var(--tg-theme-secondary-bg-color, #ffffff);
      --text: var(--tg-theme-text-color, #222);
      --hint: var(--tg-theme-hint-color, #777);
      --accent: #2481cc;
      --color-light: #e6e6a1; /* –ñ–æ–≤—Ç–∏–π (—Å–≤—ñ—Ç–ª–æ —î) */
      --color-dark: #00193a;  /* –¢–µ–º–Ω–∏–π (—Å–≤—ñ—Ç–ª–∞ –Ω–µ–º–∞) */
      --white: #ffffff;
    }
    body { font-family: sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 12px; }
    .view { display: none; }
    .view.active { display: block; }
    select, .btn { width: 100%; padding: 12px; margin-top: 10px; border-radius: 10px; border: 1px solid #ccc; font-size: 16px; box-sizing: border-box; }
    .btn { background: var(--accent); color: white; font-weight: bold; cursor: pointer; border: none; }
    .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 15px; }
    .hour { padding: 8px 2px; text-align: center; border-radius: 8px; font-size: 12px; font-weight: bold; background: var(--white); border: 1px solid #ddd; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .off { background: var(--color-dark) !important; color: white !important; border-color: #000; }
    .tabs { display: flex; gap: 5px; margin-bottom: 15px; }
    .tab { flex: 1; padding: 10px; text-align: center; background: #ddd; border-radius: 8px; cursor: pointer; user-select: none; }
    .tab.active { background: var(--accent); color: white; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .status-card { padding: 15px; border-radius: 12px; text-align: center; font-weight: bold; margin-bottom: 15px; border: 1px solid #ddd; }
  </style>
</head>
<body>

  <div id="setup-view" class="view">
    <h3>üîß –í–∏–±—ñ—Ä –æ–±–ª–∞—Å—Ç—ñ —Ç–∞ —á–µ—Ä–≥–∏</h3>
    <label>–û–±–ª–∞—Å—Ç—å:</label>
    <select id="region" onchange="loadQueues()">
      <option value="">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</option>
    </select>
    
    <label style="margin-top:15px; display:block;">–ß–µ—Ä–≥–∞:</label>
    <select id="queue" disabled>
      <option value="">–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –æ–±–ª–∞—Å—Ç—å</option>
    </select>
    
    <button id="save-btn" class="btn" onclick="saveSelection()" disabled style="opacity: 0.6;">–ó–±–µ—Ä–µ–≥—Ç–∏ –≤–∏–±—ñ—Ä</button>
    <div id="setup-error" style="color: red; margin-top: 10px; font-size: 12px; display: none;"></div>
  </div>

  <div id="schedule-view" class="view">
    <div class="header">
      <div id="info" style="font-weight:bold; font-size: 14px;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
      <button class="btn" style="width:auto; padding: 5px 15px; margin:0;" onclick="showSetup()">‚úèÔ∏è –ó–º—ñ–Ω–∏—Ç–∏</button>
    </div>
    
    <div class="tabs">
      <div id="tab0" class="tab active" onclick="loadSchedule(0)">–°–¨–û–ì–û–î–ù–Ü</div>
      <div id="tab1" class="tab" onclick="loadSchedule(1)">–ó–ê–í–¢–†–ê</div>
    </div>

    <div id="status" class="status-card">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É...</div>
    <div id="grid" class="grid"></div>
  </div>

<script>
  // ‚ùóÔ∏è –¢–£–¢ –í–°–¢–ê–í –°–í–û–Ñ –ü–û–°–ò–õ–ê–ù–ù–Ø –ù–ê WEB APP (—Å–∫—Ä–∏–ø—Ç)
  const API = "https://script.google.com/macros/s/AKfycbx0_wj63qj6n3ADHCuHpaTdz-5NmQ61ZWSFKNCjaAkvSsmbBncpiITnkqFN3salqppCAA/exec"; 
  
  let tg = window.Telegram.WebApp;
  const userId = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : "197183975"; 

  async function init() {
    tg.expand();
    try {
      // –°–ø–æ—á–∞—Ç–∫—É –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —î —é–∑–µ—Ä –≤ –±–∞–∑—ñ
      const res = await fetch(`${API}?action=checkUser&chatId=${userId}`);
      const data = await res.json();
      
      if (data.hasQueue) {
        showSchedule();
      } else {
        showSetup();
      }
    } catch (e) {
      alert("–ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è: " + e);
    }
  }

  async function showSetup() {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.getElementById('setup-view').classList.add('active');
    
    const sel = document.getElementById('region');
    sel.innerHTML = '<option>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É...</option>';
    
    try {
      const res = await fetch(`${API}?action=getRegions`);
      const regions = await res.json();
      
      sel.innerHTML = '<option value="">-- –û–±–µ—Ä—ñ—Ç—å –æ–±–ª–∞—Å—Ç—å --</option>';
      if (regions.length === 0) {
        sel.innerHTML = '<option>‚ö†Ô∏è –°–ø–∏—Å–æ–∫ –ø—É—Å—Ç–∏–π. –ó–∞–ø—É—Å—Ç—ñ—Ç—å crawlEverything</option>';
        return;
      }
      
      regions.forEach(r => {
        sel.innerHTML += `<option value="${r.url}">${r.name}</option>`;
      });
    } catch (e) {
      sel.innerHTML = '<option>–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</option>';
      document.getElementById('setup-error').innerText = "–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–∞–Ω—ñ. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç.";
      document.getElementById('setup-error').style.display = 'block';
    }
  }

  async function loadQueues() {
    const url = document.getElementById('region').value;
    const qSel = document.getElementById('queue');
    const saveBtn = document.getElementById('save-btn');
    
    qSel.innerHTML = '<option>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —á–µ—Ä–≥...</option>';
    qSel.disabled = true;
    saveBtn.disabled = true;
    saveBtn.style.opacity = '0.6';

    if (!url) {
        qSel.innerHTML = '<option>–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –æ–±–ª–∞—Å—Ç—å</option>';
        return;
    }

    try {
      const res = await fetch(`${API}?action=getQueues&regionUrl=${url}`);
      const queues = await res.json();
      
      qSel.innerHTML = '<option value="">-- –û–±–µ—Ä—ñ—Ç—å —á–µ—Ä–≥—É --</option>';
      
      if (queues.length === 0) {
         qSel.innerHTML = '<option>–ß–µ—Ä–≥ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ :(</option>';
      } else {
         queues.forEach(q => {
           qSel.innerHTML += `<option value="${q.url}" data-name="${q.name}">${q.name}</option>`;
         });
         qSel.disabled = false;
      }
    } catch (e) {
      qSel.innerHTML = '<option>–ü–æ–º–∏–ª–∫–∞</option>';
    }
  }
  
  // –ê–∫—Ç–∏–≤—É—î–º–æ –∫–Ω–æ–ø–∫—É —Ç—ñ–ª—å–∫–∏ –∫–æ–ª–∏ –æ–±—Ä–∞–Ω–∞ —á–µ—Ä–≥–∞
  document.getElementById('queue').addEventListener('change', function() {
      const btn = document.getElementById('save-btn');
      if(this.value) {
          btn.disabled = false;
          btn.style.opacity = '1';
      } else {
          btn.disabled = true;
          btn.style.opacity = '0.6';
      }
  });

  async function saveSelection() {
    const regSel = document.getElementById('region');
    const qSel = document.getElementById('queue');
    
    if (!qSel.value) return;

    const regionName = regSel.options[regSel.selectedIndex].text;
    const queueName = qSel.options[qSel.selectedIndex].getAttribute('data-name');
    const queueUrl = qSel.value;
    
    document.getElementById('save-btn').innerText = "–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...";

    await fetch(`${API}?action=saveUser&chatId=${userId}&queue=${encodeURIComponent(queueName)}&url=${encodeURIComponent(queueUrl)}&regionName=${encodeURIComponent(regionName)}`);
    
    document.getElementById('save-btn').innerText = "–ó–±–µ—Ä–µ–≥—Ç–∏ –≤–∏–±—ñ—Ä";
    showSchedule();
  }

  function showSchedule() {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.getElementById('schedule-view').classList.add('active');
    loadSchedule(0);
  }

  async function loadSchedule(offset) {
    document.getElementById('tab0').classList.toggle('active', offset === 0);
    document.getElementById('tab1').classList.toggle('active', offset === 1);
    
    const grid = document.getElementById('grid');
    const statusEl = document.getElementById('status');
    const infoEl = document.getElementById('info');
    
    grid.innerHTML = '<div style="grid-column: span 4; text-align:center;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';
    
    try {
      const res = await fetch(`${API}?action=getSchedule&chatId=${userId}&offset=${offset}`);
      const data = await res.json();
      
      if (data.error) {
        statusEl.innerText = data.error;
        statusEl.style.background = "#fff";
        statusEl.style.color = "red";
        grid.innerHTML = '';
        infoEl.innerText = "–ü–æ–º–∏–ª–∫–∞";
        return;
      }

      infoEl.innerText = `${data.region}, ${data.queue}`;
      
      // –õ–æ–≥—ñ–∫–∞ —Å—Ç–∞—Ç—É—Å—É
      const isOutage = data.status === "–í–Ü–î–°–£–¢–ù–Ñ";
      statusEl.innerText = isOutage ? "üí° –°–≤—ñ—Ç–ª–æ –Ω–∞—Ä–∞–∑—ñ –í–Ü–î–°–£–¢–ù–Ñ" : "üîÜ –°–≤—ñ—Ç–ª–æ –Ω–∞—Ä–∞–∑—ñ –Ñ";
      statusEl.style.background = isOutage ? "var(--color-dark)" : "var(--color-light)";
      statusEl.style.color = isOutage ? "white" : "black";

      grid.innerHTML = '';
      data.slots.forEach(s => {
        const cell = document.createElement('div');
        cell.className = `hour ${s.isOutage ? 'off' : ''}`;
        cell.innerHTML = `<span>${s.start}</span><span style="font-size:16px; margin-top:2px;">${s.isOutage ? 'üåë' : 'üåï'}</span>`;
        grid.appendChild(cell);
      });
    } catch (e) {
      grid.innerHTML = '–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≥—Ä–∞—Ñ—ñ–∫—É.';
    }
  }

  init();
</script>
</body>
</html>
