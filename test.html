<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ì—Ä–∞—Ñ—ñ–∫ —Å–≤—ñ—Ç–ª–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: var(--tg-theme-bg-color, #212121);
            color: var(--tg-theme-text-color, #ffffff);
            font-family: sans-serif;
            padding-bottom: 20px;
            font-size: 14px;
            min-height: 100vh;
            display: flex; flex-direction: column;
        }
        .container { max-width: 400px; flex-grow: 1; display: flex; flex-direction: column; }
        .header-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .queue-title { font-weight: bold; font-size: 1.1em; }
        .date-display { color: var(--tg-theme-hint-color, #aaaaaa); font-size: 0.9em; }

        /* COLORS */
        .status-card { border-radius: 12px; padding: 15px; text-align: center; margin-bottom: 15px; border: none; }
        .status-card.off-mode { background-color: #00193a !important; color: #e6e6a1 !important; }
        .status-card.on-mode { background-color: #e6e5a2 !important; color: #00193a !important; }
        .status-emoji { font-size: 1.5em; display: block; margin-bottom: 5px; }
        .status-timer { font-size: 1.2em; font-weight: bold; margin: 5px 0; }
        .status-next { font-size: 0.9em; opacity: 0.9; }

        .nav-pills .nav-link { color: var(--tg-theme-text-color, #fff); background-color: #2c2c2c; margin: 0 5px; border-radius: 8px; padding: 8px 0; }
        .nav-pills .nav-link.active { background-color: var(--tg-theme-button-color, #3390ec); color: var(--tg-theme-button-text-color, #fff); }

        .slot-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 15px; }
        .slot { border-radius: 8px; padding: 12px 2px; text-align: center; font-size: 13px; font-weight: 600; border: 1px solid transparent; position: relative; }
        .slot.off { background-color: #00193a; color: #e6e6a1; border-color: #00193a; }
        .slot.on { background-color: #e6e6a1; color: #00193a; border-color: #e6e6a1; }
        .slot.maybe { background-color: #a1a1a1; color: #ffffff; }
        .slot.split-off-on { background: linear-gradient(90deg, #00193a 50%, #e6e6a1 50%); color: #00193a; border-color: #00193a; }
        .slot.split-on-off { background: linear-gradient(90deg, #e6e6a1 50%, #00193a 50%); color: #00193a; border-color: #00193a; }
        .text-stroke { text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff; font-weight: 800; }
        .slot.current { border: 2px solid var(--tg-theme-button-color, #3390ec); transform: scale(1.05); z-index: 2; }

        .btn-tg { background-color: var(--tg-theme-button-color, #3390ec); color: var(--tg-theme-button-text-color, #ffffff); width: 100%; padding: 12px; border: none; border-radius: 8px; margin-top: 15px; font-weight: bold; }
        .btn-outline { background: transparent; border: 1px solid var(--tg-theme-hint-color, #777); color: var(--tg-theme-hint-color, #ccc); margin-top: 15px; font-size: 0.9em; }
        
        .screen-section { display: none; } 
        .visible { display: block; }
        #loading-screen { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; flex-grow: 1; text-align: center; }
        .spinner { font-size: 2em; animation: spin 1s infinite linear; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .form-select { background-position: right 0.75rem center; }
        .disclaimer { font-size: 0.9em; color: #888; text-align: center; margin-top: 25px; font-style: italic; padding: 0 10px; }
    </style>
</head>
<body>

<div class="container py-3">
    <div id="loading-screen"><div class="spinner">‚è≥</div><div class="mt-2 text-muted">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div></div>

    <div id="setup-screen" class="screen-section">
        <h4 class="mb-4 text-center">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h4>
        <div class="mb-3">
            <label class="form-label text-muted small">–û–±–ª–∞—Å—Ç—å</label>
            <select id="region-select" class="form-select bg-dark text-white border-secondary">
                <option value="">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É...</option>
            </select>
        </div>
        <div class="mb-3">
            <label class="form-label text-muted small">–ß–µ—Ä–≥–∞</label>
            <select id="queue-select" class="form-select bg-dark text-white border-secondary" disabled>
                <option value="">–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –æ–±–ª–∞—Å—Ç—å</option>
            </select>
        </div>
        <button id="save-btn" class="btn-tg" onclick="saveSettings()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
        <div class="text-center mt-3" id="cancel-setup-btn" style="display:none;">
            <button class="btn btn-link text-muted" onclick="showScheduleView()" style="text-decoration: none;">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        </div>
    </div>

    <div id="schedule-screen" class="screen-section">
        <div class="header-info">
            <div><div class="queue-title" id="display-queue-name">...</div><div class="date-display" id="display-region-name">...</div></div>
            <button class="btn btn-sm btn-dark border-0" onclick="tg.close()">‚úñ</button>
        </div>
        <div id="status-banner" class="status-card d-none"></div>
        <ul class="nav nav-pills nav-fill mt-3">
            <li class="nav-item"><a class="nav-link active" id="tab-today" href="#" onclick="switchDay(0)">–°—å–æ–≥–æ–¥–Ω—ñ</a></li>
            <li class="nav-item"><a class="nav-link" id="tab-tomorrow" href="#" onclick="switchDay(1)">–ó–∞–≤—Ç—Ä–∞</a></li>
        </ul>
        <div class="text-center small text-muted mt-2" id="current-date-text"></div>
        <div id="grid-container" class="slot-grid"><div class="col-span-4 text-center py-5">‚åõ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div></div>
        <div class="disclaimer">–ì—Ä–∞—Ñ—ñ–∫ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –æ—Ñ—ñ—Ü—ñ–π–Ω–∏–º —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è–º –æ–±–ª–µ–Ω–µ—Ä–≥–æ —ñ –º–æ–∂–µ –Ω–µ —Å–ø—ñ–≤–ø–∞–¥–∞—Ç–∏ –∑ —Ä–µ–∞–ª—å–Ω–∏–º–∏ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è–º–∏</div>
        <button class="btn-tg btn-outline" onclick="toggleEdit()">‚öôÔ∏è –ó–º—ñ–Ω–∏—Ç–∏ —á–µ—Ä–≥—É</button>
    </div>
</div>

<script>
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbx0_wj63qj6n3ADHCuHpaTdz-5NmQ61ZWSFKNCjaAkvSsmbBncpiITnkqFN3salqppCAA/exec'; 
    let tg = window.Telegram.WebApp;
    tg.expand();

    function resolveUserId() {
        let id = tg.initDataUnsafe?.user?.id;
        if (id) return String(id);
        id = localStorage.getItem('svitlo_user_id');
        if (id) return id;
        id = 'user_' + Math.floor(Math.random() * 1000000);
        localStorage.setItem('svitlo_user_id', id);
        return id;
    }

    let currentUserId = resolveUserId();
    
    let regionsData = [];
    let userSettings = null;
    let currentSchedule = [];

    window.onload = async function() {
        try {
            const [userResp, treeResp] = await Promise.all([
                fetch(`${GAS_API_URL}?action=getUser&userId=${currentUserId}&t=${Date.now()}`),
                fetch(`${GAS_API_URL}?action=getTree&t=${Date.now()}`)
            ]);
            userSettings = await userResp.json();
            regionsData = await treeResp.json();
            
            populateRegions();
            document.getElementById('loading-screen').style.display = 'none';

            if (userSettings.found || (userSettings.regionName && userSettings.regionName !== "")) {
                document.getElementById('display-queue-name').innerText = userSettings.queueName;
                document.getElementById('display-region-name').innerText = userSettings.regionName;
                showScheduleView();
                switchDay(0);
            } else {
                showSetupView();
            }
        } catch (e) {
            document.getElementById('loading-screen').innerHTML = `<div class="text-danger">–ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è: ${e.message}</div>`;
        }
    };

    function populateRegions() {
        const rSelect = document.getElementById('region-select');
        rSelect.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å –æ–±–ª–∞—Å—Ç—å...</option>';
        Object.keys(regionsData).forEach(rName => {
            const opt = document.createElement('option');
            opt.value = rName; opt.innerText = rName;
            rSelect.appendChild(opt);
        });
        rSelect.addEventListener('change', () => {
            const qSelect = document.getElementById('queue-select');
            qSelect.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å —á–µ—Ä–≥—É...</option>';
            qSelect.disabled = false;
            const queues = regionsData[rSelect.value];
            if(queues) {
                queues.forEach(q => {
                    const opt = document.createElement('option');
                    opt.value = q.url; opt.innerText = q.name;
                    qSelect.appendChild(opt);
                });
            }
        });
    }

    async function saveSettings() {
        const rSelect = document.getElementById('region-select');
        const qSelect = document.getElementById('queue-select');
        
        if(!rSelect.value || !qSelect.value) { tg.showAlert("–û–±–µ—Ä—ñ—Ç—å –æ–±–ª–∞—Å—Ç—å —Ç–∞ —á–µ—Ä–≥—É"); return; }

        const rName = rSelect.options[rSelect.selectedIndex].text;
        const qName = qSelect.options[qSelect.selectedIndex].text;
        const qUrl = qSelect.value;
        
        tg.MainButton.showProgress();
        await fetch(`${GAS_API_URL}?action=saveUser&userId=${currentUserId}&regionName=${encodeURIComponent(rName)}&queueName=${encodeURIComponent(qName)}&queueUrl=${encodeURIComponent(qUrl)}&t=${Date.now()}`);
        tg.MainButton.hideProgress();

        userSettings = { found: true, regionName: rName, queueName: qName, queueUrl: qUrl };
        document.getElementById('display-queue-name').innerText = qName;
        document.getElementById('display-region-name').innerText = rName;
        showScheduleView();
        switchDay(0);
    }

    let activeDayOffset = 0;
    function getLocalDateString(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    async function switchDay(dayOffset) {
        activeDayOffset = dayOffset;
        document.getElementById('tab-today').classList.toggle('active', dayOffset === 0);
        document.getElementById('tab-tomorrow').classList.toggle('active', dayOffset === 1);
        
        const container = document.getElementById('grid-container');
        container.innerHTML = '<div class="col-span-4 text-center py-5">‚åõ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';
        document.getElementById('status-banner').classList.add('d-none');

        const date = new Date();
        date.setDate(date.getDate() + dayOffset);
        const dateStrApi = getLocalDateString(date);
        const dDisplay = pad(date.getDate()) + '.' + pad(date.getMonth()+1) + '.' + date.getFullYear();
        document.getElementById('current-date-text').innerText = dDisplay;

        if (!userSettings || !userSettings.queueUrl) return;

        const resp = await fetch(`${GAS_API_URL}?action=getSchedule&queueUrl=${encodeURIComponent(userSettings.queueUrl)}&date=${dateStrApi}&t=${Date.now()}`);
        const data = await resp.json();
        currentSchedule = data.schedule;
        renderGrid(data.schedule);
        if (dayOffset === 0) updateStatusBanner();
    }

    function renderGrid(scheduleArray) {
        const container = document.getElementById('grid-container');
        container.innerHTML = '';
        if (!scheduleArray || scheduleArray.length === 0) {
            container.innerHTML = `<div class="empty-msg" style="grid-column: span 4; text-align:center; color:#888; padding:20px;">ü§∑‚Äç‚ôÇÔ∏è –ì—Ä–∞—Ñ—ñ–∫ —â–µ –Ω–µ –æ–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ.</div>`;
            return;
        }
        const now = new Date();
        const currentH = now.getHours();

        for (let h = 0; h < 24; h++) {
            const val1 = scheduleArray[h*2];     
            const val2 = scheduleArray[h*2+1];   
            const div = document.createElement('div');
            div.className = 'slot';
            div.innerText = `${pad(h)}-${pad(h+1)}`;
            
            if (val1 === val2) {
                if (val1 === 0) div.classList.add('off');       
                else if (val1 === 2) div.classList.add('maybe'); 
                else div.classList.add('on');                   
            } else {
                if (val1 === 0 && val2 === 1) div.classList.add('split-off-on', 'text-stroke');
                else if (val1 === 1 && val2 === 0) div.classList.add('split-on-off', 'text-stroke');
                else div.classList.add('off');
            }
            if (activeDayOffset === 0 && h === currentH) div.classList.add('current');
            container.appendChild(div);
        }
    }

    function updateStatusBanner() {
        const banner = document.getElementById('status-banner');
        if (!currentSchedule || currentSchedule.length === 0) return;
        const now = new Date();
        const nowIndex = now.getHours() * 2 + (now.getMinutes() >= 30 ? 1 : 0);
        if (nowIndex >= 48) return; 

        const isLight = currentSchedule[nowIndex] === 1;
        const currentStatusVal = currentSchedule[nowIndex];
        let changeIndex = -1;
        for (let i = nowIndex + 1; i < 48; i++) {
            if (currentSchedule[i] !== currentStatusVal) { changeIndex = i; break; }
        }

        banner.className = 'status-card';
        banner.classList.remove('off-mode', 'on-mode');
        let statusText = isLight ? "–ó–∞—Ä–∞–∑ —Å–≤—ñ—Ç–ª–æ –Ñ (–ø–æ –≥—Ä–∞—Ñ—ñ–∫—É)" : "–ó–∞—Ä–∞–∑ —Å–≤—ñ—Ç–ª–æ –í–Ü–î–°–£–¢–ù–Ñ";
        let emoji = isLight ? "üåù" : "üåö";
        let timeLeftHtml = "", nextEventHtml = "";

        if (isLight) banner.classList.add('on-mode');
        else banner.classList.add('off-mode');

        if (changeIndex !== -1) {
            const targetDate = new Date();
            targetDate.setHours(Math.floor(changeIndex / 2));
            targetDate.setMinutes((changeIndex % 2) * 30);
            targetDate.setSeconds(0);
            const diffMs = targetDate - now;
            if (diffMs > 0) {
                const diffHrs = Math.floor(diffMs / 3600000);
                const diffMins = Math.floor((diffMs % 3600000) / 60000);
                timeLeftHtml = `<div>–ó–∞–ª–∏—à–∏–ª–æ—Å—è: ${diffHrs} –≥–æ–¥ ${diffMins} —Ö–≤.</div>`;
                const nextAction = isLight ? "–í–∏–º–∫–Ω–µ–Ω–Ω—è" : "–£–≤—ñ–º–∫–Ω–µ–Ω–Ω—è";
                nextEventHtml = `<div>${isLight ? 'üåö' : 'üåù'} ${nextAction} –æ ${pad(targetDate.getHours())}:${pad(targetDate.getMinutes())}</div>`;
            }
        } else {
            timeLeftHtml = "<div>–ë–µ–∑ –∑–º—ñ–Ω –¥–æ –∫—ñ–Ω—Ü—è –¥–æ–±–∏</div>";
        }
        banner.innerHTML = `<div class="status-emoji">${emoji} ${statusText}</div><div class="status-timer">${timeLeftHtml}</div><div class="status-next">${nextEventHtml}</div>`;
        banner.classList.remove('d-none');
    }

    function showSetupView() {
        document.getElementById('setup-screen').classList.add('visible');
        document.getElementById('schedule-screen').classList.remove('visible');
        document.getElementById('cancel-setup-btn').style.display = 'none'; 
    }
    function showScheduleView() {
        document.getElementById('setup-screen').classList.remove('visible');
        document.getElementById('schedule-screen').classList.add('visible');
    }
    function toggleEdit() {
        document.getElementById('schedule-screen').classList.remove('visible');
        document.getElementById('setup-screen').classList.add('visible');
        document.getElementById('cancel-setup-btn').style.display = 'block'; 
    }
    function pad(n) { return n < 10 ? '0'+n : n; }
</script>
</body>
</html>
