<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: var(--tg-theme-bg-color, #ffffff);
            --text: var(--tg-theme-text-color, #222222);
            --hint: var(--tg-theme-hint-color, #999999);
            --btn-bg: var(--tg-theme-button-color, #2481cc);
            --btn-text: var(--tg-theme-button-text-color, #ffffff);
            --secondary: var(--tg-theme-secondary-bg-color, #f0f2f5);
        }
        body { 
            font-family: sans-serif; 
            background-color: var(--bg); 
            color: var(--text); 
            padding: 20px; 
            margin: 0;
        }
        .form-group { margin-bottom: 20px; }
        label { 
            display: block; 
            margin-bottom: 8px; 
            font-size: 14px; 
            color: var(--hint); 
            font-weight: bold; 
        }
        select { 
            width: 100%; 
            padding: 12px; 
            border-radius: 10px; 
            border: 1px solid #ccc; 
            background: var(--secondary); 
            color: var(--text); 
            font-size: 16px; 
            outline: none; 
        }
        select:disabled { opacity: 0.4; }
        .btn { 
            background: var(--btn-bg); 
            color: var(--btn-text); 
            border: none; 
            padding: 18px; 
            border-radius: 12px; 
            font-size: 16px; 
            width: 100%; 
            font-weight: bold; 
            cursor: pointer; 
            margin-top: 10px; 
        }
        .btn:disabled { 
            background: #ccc; 
            color: #888; 
        }
        .loader { 
            font-size: 12px; 
            color: var(--btn-bg); 
            display: none; 
            margin-top: 5px; 
        }
    </style>
</head>
<body>
    <div id="app">
        <h3 style="margin-top:0">üîß –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≥—Ä–∞—Ñ—ñ–∫—É</h3>
        
        <div class="form-group">
            <label>1. –û–ë–ï–†–Ü–¢–¨ –û–ë–õ–ê–°–¢–¨</label>
            <select id="region" onchange="onRegionChange()">
                <option value="">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</option>
            </select>
        </div>

        <div class="form-group">
            <label>2. –û–ë–ï–†–Ü–¢–¨ –ß–ï–†–ì–£ / –ì–†–£–ü–£</label>
            <div id="queue-loader" class="loader">–ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —á–µ—Ä–≥–∏...</div>
            <select id="queue" disabled onchange="validate()">
                <option value="">–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –æ–±–ª–∞—Å—Ç—å</option>
            </select>
        </div>

        <button id="save-btn" class="btn" disabled onclick="save()">–ó–±–µ—Ä–µ–≥—Ç–∏ –≤–∏–±—ñ—Ä</button>
    </div>

    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbx0_wj63qj6n3ADHCuHpaTdz-5NmQ61ZWSFKNCjaAkvSsmbBncpiITnkqFN3salqppCAA/exec";
        let tg = window.Telegram.WebApp;
        tg.expand();

        async function init() {
            try {
                const res = await fetch(`${WEB_APP_URL}?action=getRegions`);
                const data = await res.json();
                const sel = document.getElementById('region');
                sel.innerHTML = '<option value="">-- –û–±–µ—Ä—ñ—Ç—å –æ–±–ª–∞—Å—Ç—å --</option>';
                data.forEach(r => sel.innerHTML += `<option value="${r.url}">${r.name}</option>`);
            } catch (e) { 
                alert("–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó"); 
            }
        }

        async function onRegionChange() {
            const url = document.getElementById('region').value;
            const queueSel = document.getElementById('queue');
            queueSel.innerHTML = '<option value="">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</option>';
            queueSel.disabled = true;
            validate();

            if (!url) return;
            document.getElementById('queue-loader').style.display = 'block';

            try {
                const res = await fetch(`${WEB_APP_URL}?action=getChildren&url=${encodeURIComponent(url)}`);
                const data = await res.json();
                if (data.length > 0) {
                    queueSel.innerHTML = '<option value="">-- –û–±–µ—Ä—ñ—Ç—å —á–µ—Ä–≥—É --</option>';
                    data.forEach(q => queueSel.innerHTML += `<option value="${q.url}" data-name="${q.name}">${q.name}</option>`);
                    queueSel.disabled = false;
                } else {
                    queueSel.innerHTML = '<option value="">–ß–µ—Ä–≥ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</option>';
                }
            } catch (e) { 
                alert("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —á–µ—Ä–≥"); 
            } finally { 
                document.getElementById('queue-loader').style.display = 'none'; 
            }
        }

        function validate() {
            const queueValue = document.getElementById('queue').value;
            document.getElementById('save-btn').disabled = (queueValue === "");
        }

        async function save() {
            const queueSel = document.getElementById('queue');
            const finalUrl = queueSel.value;
            const finalName = queueSel.selectedOptions[0]?.text;
            const chatId = tg.initDataUnsafe.user?.id || "197183975";

            const btn = document.getElementById('save-btn');
            btn.disabled = true;
            btn.innerText = "–ó–±–µ—Ä—ñ–≥–∞—î–º–æ...";

            await fetch(`${WEB_APP_URL}?action=saveSelection&chatId=${chatId}&url=${encodeURIComponent(finalUrl)}&name=${encodeURIComponent(finalName)}`);
            
            // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –¥–∞–Ω—ñ –Ω–∞–∑–∞–¥ –≤ –±–æ—Ç
            tg.sendData(JSON.stringify({
                queue: finalName,
                url: finalUrl
            }));
            
            tg.close();
        }
        
        init();
    </script>
</body>
</html>
