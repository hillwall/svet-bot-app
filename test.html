<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Світло Бот</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg: var(--tg-theme-bg-color, #f0f2f5);
      --card: var(--tg-theme-secondary-bg-color, #ffffff);
      --text: var(--tg-theme-text-color, #222);
      --hint: var(--tg-theme-hint-color, #777);
      --accent: #2481cc;
      
      /* Палітра "Вінниця" */
      --color-light: #e6e6a1; /* Світло є */
      --color-dark: #333333;  /* Світла немає */
      --color-current-border: #ff3b30;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 12px;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      box-sizing: border-box;
    }

    /* КАРТКИ І КОНТЕЙНЕРИ */
    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .hidden { display: none !important; }

    /* ЕЛЕМЕНТИ ФОРМИ */
    h3 { margin-top: 0; text-align: center; }
    p { color: var(--hint); font-size: 14px; text-align: center; }

    select {
      width: 100%; padding: 12px; margin-bottom: 12px;
      border: 1px solid #ccc; border-radius: 10px;
      background: var(--bg); color: var(--text);
      font-size: 16px; -webkit-appearance: none;
    }
    
    button.main-btn {
      width: 100%; padding: 14px; border: none; border-radius: 10px;
      background: var(--accent); color: white;
      font-size: 16px; font-weight: 600; cursor: pointer;
    }

    /* ЗАГОЛОВОК ГРАФІКА */
    .header-row {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 12px;
    }
    .title-block h2 { margin: 0; font-size: 20px; }
    .title-block span { font-size: 13px; color: var(--hint); }
    .status-badge {
      background: var(--color-light); color: #000;
      padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: bold;
    }
    .status-badge.off { background: var(--color-dark); color: #fff; }

    /* ТАБИ (Сьогодні/Завтра) */
    .tabs {
      display: flex; background: rgba(0,0,0,0.05);
      border-radius: 9px; padding: 3px; margin-bottom: 16px;
    }
    .tab {
      flex: 1; text-align: center; padding: 8px;
      border-radius: 7px; font-size: 14px; cursor: pointer;
      color: var(--hint); transition: 0.2s;
    }
    .tab.active {
      background: var(--card); color: var(--text);
      font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* СІТКА ГРАФІКА (ВІННИЦЬКИЙ СТИЛЬ) */
    .grid {
      display: flex; flex-wrap: wrap;
      gap: 0; border-radius: 8px; overflow: hidden;
      border: 1px solid rgba(0,0,0,0.1);
    }
    .hour {
      width: 25%; /* 4 в ряд для мобільного */
      height: 50px;
      background-color: var(--color-light);
      border: 1px solid rgba(0,0,0,0.05);
      box-sizing: border-box;
      display: flex; align-items: center; justify-content: center;
      font-size: 14px; font-weight: 500; color: #333;
      position: relative;
    }
    
    /* Адаптивність сітки */
    @media (min-width: 350px) { .hour { width: 20%; } } /* 5 в ряд */
    @media (min-width: 400px) { .hour { width: 16.66%; } } /* 6 в ряд */

    /* Статуси */
    .hour.off-full { background-color: var(--color-dark); color: #fff; }
    
    /* Поточна година */
    .hour.current {
      box-shadow: inset 0 0 0 3px var(--color-current-border);
      z-index: 2;
    }

    .loader { text-align: center; padding: 40px; color: var(--hint); }
  </style>
</head>
<body>

  <div id="loader" class="loader">
    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
    </svg>
    <p>Завантаження даних...</p>
  </div>

  <div id="setup-screen" class="card hidden">
    <h3>⚙️ Налаштування</h3>
    <p>Оберіть вашу область та чергу</p>
    
    <select id="region-select" onchange="loadQueues()">
      <option value="">Завантаження областей...</option>
    </select>
    
    <div id="queue-block" class="hidden">
      <select id="queue-select">
        <option value="">Оберіть чергу</option>
      </select>
      <button class="main-btn" onclick="saveConfig()">Зберегти</button>
    </div>
  </div>

  <div id="view-screen" class="hidden">
    <div class="card">
      <div class="header-row">
        <div class="title-block">
          <h2 id="view-queue">Черга ...</h2>
          <span id="view-region">Область ...</span>
        </div>
        <div id="status-badge" class="status-badge">Світло є</div>
      </div>

      <div class="tabs">
        <div id="tab-0" class="tab active" onclick="loadSchedule(0)">Сьогодні</div>
        <div id="tab-1" class="tab" onclick="loadSchedule(1)">Завтра</div>
      </div>

      <div id="schedule-grid" class="grid">
        </div>
      <p id="error-msg" style="color:red; margin-top:10px;"></p>
    </div>

    <button onclick="showSetup()" style="background:none; border:none; color:var(--accent); width:100%; padding:10px;">
      Змінити налаштування
    </button>
  </div>

<script>
  const tg = window.Telegram.WebApp;
  tg.expand();
  const userId = tg.initDataUnsafe?.user?.id || "TEST_USER_ID"; // Фолбек для тесту

  // ВСТАВ СЮДИ URL СКРИПТА GOOGLE (той, що закінчується на /exec)
  // ВАЖЛИВО: Переконайся, що ти зробив New Deployment!
  const API_URL = "https://script.google.com/macros/s/AKfycbx0_wj63qj6n3ADHCuHpaTdz-5NmQ61ZWSFKNCjaAkvSsmbBncpiITnkqFN3salqppCAA/exec";

  // --- API ---
  async function callApi(action, params = {}) {
    const url = new URL(API_URL);
    url.searchParams.append('action', action);
    for (const k in params) url.searchParams.append(k, params[k]);
    try {
      const res = await fetch(url);
      return await res.json();
    } catch (e) {
      console.error(e);
      return null;
    }
  }

  // --- INIT ---
  window.onload = async () => {
    // Перевіряємо, чи є збережені дані
    const user = await callApi('getUserSchedule', { chatId: userId });
    document.getElementById('loader').classList.add('hidden');

    if (user && user.error === "UserNotFound") {
      showSetup();
    } else if (user && !user.error) {
      showView(user);
    } else {
      alert("Помилка з'єднання з сервером. Спробуйте пізніше.");
    }
  };

  // --- SETUP LOGIC ---
  async function showSetup() {
    document.getElementById('view-screen').classList.add('hidden');
    document.getElementById('setup-screen').classList.remove('hidden');
    
    const regions = await callApi('getRegions');
    const rSel = document.getElementById('region-select');
    rSel.innerHTML = '<option value="">Оберіть область</option>';
    regions.forEach(r => {
      const opt = document.createElement('option');
      opt.value = r.url;
      opt.text = r.name;
      rSel.appendChild(opt);
    });
  }

  async function loadQueues() {
    const url = document.getElementById('region-select').value;
    if (!url) return;
    
    const qs = await callApi('getChildren', { url: url });
    const qSel = document.getElementById('queue-select');
    qSel.innerHTML = '<option value="">Оберіть чергу</option>';
    qs.forEach(q => {
      const opt = document.createElement('option');
      opt.value = q.url;
      opt.text = q.name;
      qSel.appendChild(opt);
    });
    document.getElementById('queue-block').classList.remove('hidden');
  }

  async function saveConfig() {
    const rSel = document.getElementById('region-select');
    const qSel = document.getElementById('queue-select');
    if (!qSel.value) return alert("Оберіть чергу!");

    document.getElementById('loader').classList.remove('hidden');
    document.getElementById('setup-screen').classList.add('hidden');

    await callApi('saveSelection', {
      chatId: userId,
      url: qSel.value,
      name: qSel.options[qSel.selectedIndex].text
    });
    
    location.reload();
  }

  // --- VIEW LOGIC ---
  function showView(data) {
    document.getElementById('setup-screen').classList.add('hidden');
    document.getElementById('view-screen').classList.remove('hidden');
    
    // Відображення заголовків
    document.getElementById('view-queue').innerText = data.queueName;
    document.getElementById('view-region').innerText = "Ваша область"; // Або передати назву з бекенду

    renderGrid(data.schedule);
  }

  async function loadSchedule(offset) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById('tab-' + offset).classList.add('active');
    
    document.getElementById('schedule-grid').innerHTML = '<div style="width:100%;text-align:center;padding:20px;">Оновлення...</div>';
    
    const res = await callApi('getUserSchedule', { chatId: userId, dateOffset: offset });
    if (res.schedule && res.schedule.error) {
       document.getElementById('schedule-grid').innerHTML = '';
       document.getElementById('error-msg').innerText = res.schedule.error;
    } else {
       renderGrid(res.schedule);
    }
  }

  function renderGrid(schedule) {
    const grid = document.getElementById('schedule-grid');
    grid.innerHTML = "";
    document.getElementById('error-msg').innerText = "";

    if (!schedule || !schedule.slots) return;

    const currentHour = new Date().getHours();
    let currentStatus = "Світло є";
    let isCurrentOff = false;

    // Малюємо 24 квадратики
    for (let i = 0; i < 24; i++) {
      const slot = schedule.slots.find(s => s.hour === i);
      const isOff = slot && slot.status === 'off';
      
      const div = document.createElement('div');
      
      // Стилі як у Вінниці
      if (isOff) {
        div.className = 'hour off-full'; 
      } else {
        div.className = 'hour';
      }

      // Поточна година
      // Перевіряємо чи це сьогодні (логіка проста: якщо завантажили 'Сьогодні', то підсвічуємо)
      const activeTab = document.querySelector('.tab.active').innerText;
      if (i === currentHour && activeTab === 'Сьогодні') {
        div.classList.add('current');
        if (isOff) {
            currentStatus = "Світла немає";
            isCurrentOff = true;
        }
      }

      // Текст 00-01
      div.innerText = `${String(i).padStart(2,'0')}-${String(i+1).padStart(2,'0')}`;
      grid.appendChild(div);
    }

    // Оновлюємо бейдж статусу
    const badge = document.getElementById('status-badge');
    badge.innerText = currentStatus;
    if (isCurrentOff) badge.classList.add('off'); else badge.classList.remove('off');
  }
</script>
</body>
</html>
