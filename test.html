<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>–°–≤—ñ—Ç–ª–æ –ë–æ—Ç</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg: var(--tg-theme-bg-color, #f0f2f5);
      --card: var(--tg-theme-secondary-bg-color, #ffffff);
      --text: var(--tg-theme-text-color, #222);
      --hint: var(--tg-theme-hint-color, #777);
      --accent: #2481cc;
      
      /* –ü–∞–ª—ñ—Ç—Ä–∞ –í—ñ–Ω–Ω–∏—Ü—ñ */
      --color-light: #e6e6a1;
      --color-dark: #00193a;
      --white: #ffffff;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 12px;
      display: flex; flex-direction: column; min-height: 100vh;
    }

    .hidden { display: none !important; }

    /* –®–ê–ü–ö–ê */
    .header-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
    .title-group h1 { margin: 0; font-size: 22px; font-weight: 700; }
    .title-group p { margin: 4px 0 0 0; font-size: 14px; color: var(--hint); }
    
    .status-badge {
      font-size: 13px; font-weight: 600; padding: 6px 12px; border-radius: 20px;
      background-color: var(--color-light); color: #333; white-space: nowrap;
    }
    .status-badge.off { background-color: var(--color-dark); color: var(--white); }

    /* –¢–ê–ë–ò */
    .tabs {
      display: flex; background: rgba(118, 118, 128, 0.12);
      border-radius: 9px; padding: 2px; margin-bottom: 20px;
    }
    .tab {
      flex: 1; text-align: center; padding: 8px; font-size: 14px; font-weight: 500;
      cursor: pointer; border-radius: 7px; color: var(--text);
    }
    .tab.active { background: var(--card); box-shadow: 0 3px 8px rgba(0,0,0,0.12); font-weight: 600; }

    /* –°–Ü–¢–ö–ê –ì–†–ê–§–Ü–ö–ê - 4 –°–¢–û–í–ü–ß–ò–ö–ò */
    .schedule-card {
      background: var(--card); border-radius: 16px; padding: 16px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px;
    }
    .grid { display: flex; flex-wrap: wrap; border-radius: 8px; overflow: hidden; border: 1px solid rgba(0,0,0,0.1); }

    .hour {
      width: 25%; /* üî• –ñ–û–†–°–¢–ö–û 4 –ì–û–î–ò–ù–ò –í –†–Ø–î */
      height: 44px;
      background-color: var(--color-light);
      border: 0.5px solid rgba(0,0,0,0.05);
      box-sizing: border-box;
      display: flex; align-items: center; justify-content: center;
      font-size: 13px; font-weight: 500; color: #333;
      position: relative;
    }

    /* üî• –°–¢–ò–õ–Ü –î–õ–Ø –ü–û–õ–û–í–ò–ù–û–ö (–ó –í—ñ–Ω–Ω–∏—Ü—ñ) */
    .hour.off-full { background-color: var(--color-dark); color: var(--white); border-color: #002555; }
    
    .hour.off-left {
      background: linear-gradient(90deg, var(--color-dark) 50%, var(--color-light) 50%);
      color: var(--text); /* –¢–µ–∫—Å—Ç –º–∞—î –±—É—Ç–∏ –≤–∏–¥–Ω–æ */
    }
    .hour.off-right {
      background: linear-gradient(90deg, var(--color-light) 50%, var(--color-dark) 50%);
      color: var(--text);
    }

    /* –ü–æ—Ç–æ—á–Ω–∞ –≥–æ–¥–∏–Ω–∞ */
    .hour.current { border: 2px solid #ff3b30 !important; z-index: 10; }
    .hour.current::after {
      content: ''; position: absolute; top: 2px; right: 2px; width: 6px; height: 6px;
      background: #ff3b30; border-radius: 50%;
    }

    /* –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è */
    select { width: 100%; padding: 14px; margin-bottom: 12px; border: 1px solid #ccc; border-radius: 12px; font-size: 16px; background: var(--card); }
    .btn-main { width: 100%; padding: 16px; border: none; border-radius: 14px; background: var(--accent); color: white; font-size: 16px; font-weight: 600; cursor: pointer; }
    .btn-text { background: none; border: none; width: 100%; padding: 12px; color: var(--hint); cursor: pointer; }
    
    .loader { margin-top: 50px; text-align: center; color: var(--hint); }
  </style>
</head>
<body>

  <div id="loader" class="loader">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>

  <div id="setup-screen" class="hidden" style="text-align:center; padding-top:20px;">
    <h2>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h2>
    <p style="margin-bottom:20px; color:var(--hint)">–û–±–µ—Ä—ñ—Ç—å –æ–±–ª–∞—Å—Ç—å —Ç–∞ —á–µ—Ä–≥—É</p>
    <select id="region-select" onchange="loadQueues()"><option value="">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</option></select>
    <div id="queue-block" class="hidden">
      <select id="queue-select"><option value="">–û–±–µ—Ä—ñ—Ç—å —á–µ—Ä–≥—É</option></select>
      <button class="btn-main" onclick="saveConfig()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
    </div>
  </div>

  <div id="view-screen" class="hidden">
    <div class="header-row">
      <div class="title-group">
        <h1 id="view-queue">–ß–µ—Ä–≥–∞</h1>
        <p id="view-region">–û–±–ª–∞—Å—Ç—å</p>
      </div>
      <div id="status-badge" class="status-badge">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</div>
    </div>

    <div class="tabs">
      <div id="tab-0" class="tab active" onclick="loadSchedule(0)">–°—å–æ–≥–æ–¥–Ω—ñ</div>
      <div id="tab-1" class="tab" onclick="loadSchedule(1)">–ó–∞–≤—Ç—Ä–∞</div>
    </div>

    <div class="schedule-card">
      <div id="schedule-grid" class="grid"></div>
      <div id="error-msg" style="text-align:center; color:red; margin-top:5px;"></div>
    </div>

    <button class="btn-text" onclick="showSetup()">‚öôÔ∏è –ó–º—ñ–Ω–∏—Ç–∏ —á–µ—Ä–≥—É</button>
  </div>

<script>
  const tg = window.Telegram.WebApp;
  tg.expand();
  const userId = tg.initDataUnsafe?.user?.id || "TEST_USER_ID";

  // üëá –í–°–¢–ê–í –°–í–Ü–ô WEB APP URL (–ü–µ—Ä–µ–≤—ñ—Ä —â–æ–± —Ü–µ –±—É–≤ /exec)
  const API_URL = "https://script.google.com/macros/s/AKfycbx0_wj63qj6n3ADHCuHpaTdz-5NmQ61ZWSFKNCjaAkvSsmbBncpiITnkqFN3salqppCAA/exec";

  async function callApi(action, params = {}) {
    const url = new URL(API_URL);
    url.searchParams.append('action', action);
    for (const k in params) url.searchParams.append(k, params[k]);
    try { return await (await fetch(url)).json(); } 
    catch (e) { return { error: "–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ" }; }
  }

  window.onload = async () => {
    const data = await callApi('getUserSchedule', { chatId: userId });
    document.getElementById('loader').classList.add('hidden');
    if (data && data.error === "UserNotFound") showSetup();
    else if (data && !data.error) showView(data);
    else showSetup();
  };

  async function showSetup() {
    document.getElementById('view-screen').classList.add('hidden');
    document.getElementById('setup-screen').classList.remove('hidden');
    const regions = await callApi('getRegions');
    const rSel = document.getElementById('region-select');
    rSel.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å –æ–±–ª–∞—Å—Ç—å</option>';
    if (regions) regions.forEach(r => {
        rSel.innerHTML += `<option value="${r.url}">${r.name}</option>`;
    });
  }

  async function loadQueues() {
    const url = document.getElementById('region-select').value;
    if (!url) return;
    const qs = await callApi('getChildren', { url });
    const qSel = document.getElementById('queue-select');
    qSel.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å —á–µ—Ä–≥—É</option>';
    if (qs) qs.forEach(q => {
        qSel.innerHTML += `<option value="${q.url}">${q.name}</option>`;
    });
    document.getElementById('queue-block').classList.remove('hidden');
  }

  async function saveConfig() {
    const qSel = document.getElementById('queue-select');
    if (!qSel.value) return alert("–û–±–µ—Ä—ñ—Ç—å —á–µ—Ä–≥—É!");
    document.getElementById('loader').classList.remove('hidden');
    await callApi('saveSelection', {
      chatId: userId, url: qSel.value, name: qSel.options[qSel.selectedIndex].text
    });
    location.reload();
  }

  function showView(data) {
    document.getElementById('setup-screen').classList.add('hidden');
    document.getElementById('view-screen').classList.remove('hidden');
    document.getElementById('view-queue').innerText = data.queueName || "–ß–µ—Ä–≥–∞";
    document.getElementById('view-region').innerText = data.region || "–í–∞—à–∞ –æ–±–ª–∞—Å—Ç—å";
    renderGrid(data.schedule);
  }

  async function loadSchedule(offset) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById('tab-' + offset).classList.add('active');
    document.getElementById('schedule-grid').innerHTML = '<div style="width:100%;text-align:center;padding:20px;color:gray;">–û–Ω–æ–≤–ª–µ–Ω–Ω—è...</div>';
    
    const res = await callApi('getUserSchedule', { chatId: userId, dateOffset: offset });
    if (res.schedule && res.schedule.error) {
       document.getElementById('schedule-grid').innerHTML = '';
       document.getElementById('error-msg').innerText = res.schedule.error;
    } else {
       renderGrid(res.schedule);
    }
  }

  // üî• –ì–û–õ–û–í–ù–ê –§–£–ù–ö–¶–Ü–Ø –ú–ê–õ–Æ–í–ê–ù–ù–Ø (–ó –í—ñ–Ω–Ω–∏—Ü—ñ)
  function renderGrid(schedule) {
    const grid = document.getElementById('schedule-grid');
    grid.innerHTML = "";
    document.getElementById('error-msg').innerText = "";
    if (!schedule || !schedule.slots) return;

    const currentHour = new Date().getHours();
    const isToday = document.getElementById('tab-0').classList.contains('active');
    let isCurrentOff = false;

    for (let i = 0; i < 24; i++) {
      const slot = schedule.slots.find(s => s.hour === i);
      const div = document.createElement('div');
      
      // –õ–æ–≥—ñ–∫–∞ —Å—Ç–∏–ª—ñ–≤
      let className = 'hour';
      
      // –Ø–∫—â–æ –±–µ–∫–µ–Ω–¥ –Ω–∞–¥—ñ—à–ª–µ –ø–æ–ª–æ–≤–∏–Ω–∫–∏ (–Ω–∞ –º–∞–π–±—É—Ç–Ω—î), —Ñ—Ä–æ–Ω—Ç —Ü–µ –∑—Ä–æ–∑—É–º—ñ—î
      // –ü–æ–∫–∏ —â–æ –±–µ–∫–µ–Ω–¥ —à–ª–µ –ø—Ä–æ—Å—Ç–æ 'off' –∞–±–æ 'on'
      if (slot && slot.status === 'off') {
        className += ' off-full';
      } 
      // –î–æ–¥–∞–Ω–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∞ –Ω–∞ –º–∞–π–±—É—Ç–Ω—î, —è–∫—â–æ –±–µ–∫–µ–Ω–¥ –ø–æ—á–Ω–µ —Å–ª–∞—Ç–∏ 'off-left'
      else if (slot && slot.status === 'off-left') {
        className += ' off-left';
      }
      else if (slot && slot.status === 'off-right') {
        className += ' off-right';
      }

      if (isToday && i === currentHour) {
        className += ' current';
        if (slot && slot.status.includes('off')) isCurrentOff = true;
      }

      div.className = className;
      div.innerText = `${String(i).padStart(2,'0')}-${String(i+1).padStart(2,'0')}`;
      grid.appendChild(div);
    }

    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –±–µ–π–¥–∂–∞
    const badge = document.getElementById('status-badge');
    if (isToday) {
        badge.innerText = isCurrentOff ? "–°–≤—ñ—Ç–ª–∞ –Ω–µ–º–∞—î" : "–°–≤—ñ—Ç–ª–æ —î";
        badge.className = isCurrentOff ? "status-badge off" : "status-badge";
    } else {
        badge.innerText = "–ó–∞–≤—Ç—Ä–∞";
        badge.className = "status-badge";
    }
  }
</script>
</body>
</html>
