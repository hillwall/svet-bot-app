<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>–°–≤—ñ—Ç–ª–æ –ë–æ—Ç</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg: var(--tg-theme-bg-color, #f0f2f5);
      --card: var(--tg-theme-secondary-bg-color, #ffffff);
      --text: var(--tg-theme-text-color, #222);
      --hint: var(--tg-theme-hint-color, #777);
      --accent: #2481cc;
      --light-on: #e6e6a1;
      --light-off: #00193a;
      --white: #ffffff;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      margin: 0; padding: 12px;
      display: flex; flex-direction: column; min-height: 100vh;
    }

    .hidden { display: none !important; }
    
    /* –®–∞–ø–∫–∞ */
    .header-row { margin-bottom: 16px; }
    .header-row h1 { margin: 0; font-size: 22px; font-weight: 800; }
    .header-row p { margin: 4px 0 0 0; font-size: 14px; color: var(--hint); }

    /* –ë–õ–û–ö –°–¢–ê–¢–£–°–£ (–Ø–ö –£ –í–Ü–ù–ù–ò–¶–Ü) */
    .info-block {
      background: var(--card);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      text-align: left;
    }
    .status-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
    .status-timer { font-size: 15px; color: var(--text); margin-bottom: 4px; }
    .status-next { font-size: 14px; color: var(--hint); }

    .status-on-text { color: #5a9900; }
    .status-off-text { color: #d32f2f; }

    /* –¢–∞–±–∏ */
    .tabs { display: flex; background: rgba(0,0,0,0.05); border-radius: 10px; padding: 3px; margin-bottom: 16px; }
    .tab { flex: 1; text-align: center; padding: 8px; font-size: 14px; font-weight: 600; cursor: pointer; border-radius: 8px; color: var(--hint); }
    .tab.active { background: var(--card); color: var(--text); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

    /* –°—ñ—Ç–∫–∞ */
    .schedule-card { background: var(--card); border-radius: 16px; padding: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .grid { 
      display: flex; flex-wrap: wrap; 
      /* –©–æ–± –≤–∏–≥–ª—è–¥–∞–ª–∏ —è–∫ –æ–∫—Ä–µ–º—ñ –±–ª–æ–∫–∏ */
      gap: 1px; 
      background: #ccc; /* –ö–æ–ª—ñ—Ä –ª—ñ–Ω—ñ–π –º—ñ–∂ –±–ª–æ–∫–∞–º–∏ */
      border: 1px solid #ccc;
      border-radius: 8px; overflow: hidden; 
    }

    .hour {
      width: calc(25% - 1px); /* –ú—ñ–Ω—É—Å gap */
      height: 44px;
      background-color: var(--light-on);
      display: flex; align-items: center; justify-content: center;
      font-size: 13px; font-weight: 500; color: #333;
      position: relative;
      flex-grow: 1;
    }
    
    .hour.off-full { background-color: var(--light-off); color: var(--white); }
    
    /* –ü–æ—Ç–æ—á–Ω–∞ –≥–æ–¥–∏–Ω–∞ */
    .hour.current { 
      box-shadow: inset 0 0 0 2px #ff3b30; 
      z-index: 5;
    }

    /* –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è */
    select { width: 100%; padding: 14px; margin-bottom: 12px; border: 1px solid #ccc; border-radius: 12px; background: var(--card); font-size: 16px; }
    .btn-main { width: 100%; padding: 16px; background: var(--accent); color: white; border: none; border-radius: 14px; font-size: 16px; font-weight: 600; }
    .btn-link { background: none; border: none; width: 100%; padding: 15px; color: var(--hint); font-size: 14px; cursor: pointer; }
    .loader { margin-top: 50px; text-align: center; color: var(--hint); }
  </style>
</head>
<body>

  <div id="loader" class="loader">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>

  <div id="setup-screen" class="hidden" style="text-align:center; padding-top:20px;">
    <h2>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h2>
    <p style="color:var(--hint); margin-bottom:20px;">–û–±–µ—Ä—ñ—Ç—å –æ–±–ª–∞—Å—Ç—å —Ç–∞ —á–µ—Ä–≥—É</p>
    <select id="region-select" onchange="loadQueues()"><option value="">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</option></select>
    <div id="queue-block" class="hidden">
      <select id="queue-select"><option value="">–û–±–µ—Ä—ñ—Ç—å —á–µ—Ä–≥—É</option></select>
      <button class="btn-main" onclick="saveConfig()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
    </div>
  </div>

  <div id="view-screen" class="hidden">
    
    <div class="header-row">
      <h1 id="view-queue">–ß–µ—Ä–≥–∞ ...</h1>
      <p id="view-region">–û–±–ª–∞—Å—Ç—å ...</p>
    </div>

    <div id="status-card" class="info-block hidden">
       <div id="status-header" class="status-title">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
       <div id="status-timer" class="status-timer">...</div>
       <div id="status-next" class="status-next">...</div>
    </div>

    <div class="tabs">
      <div id="tab-0" class="tab active" onclick="loadSchedule(0)">–°—å–æ–≥–æ–¥–Ω—ñ <span id="date-today" style="font-weight:400; font-size:12px;"></span></div>
      <div id="tab-1" class="tab" onclick="loadSchedule(1)">–ó–∞–≤—Ç—Ä–∞ <span id="date-tomorrow" style="font-weight:400; font-size:12px;"></span></div>
    </div>

    <div class="schedule-card">
      <div id="schedule-grid" class="grid"></div>
      <div id="error-msg" style="text-align:center; color:red; margin-top:5px;"></div>
    </div>

    <button class="btn-link" onclick="showSetup()">‚öôÔ∏è –ó–º—ñ–Ω–∏—Ç–∏ —á–µ—Ä–≥—É</button>
  </div>

<script>
  const tg = window.Telegram.WebApp;
  tg.expand();
  const userId = tg.initDataUnsafe?.user?.id || "TEST_USER";
  
  // üëá –í–°–¢–ê–í –°–í–Ü–ô URL üëá
  const API_URL = "https://script.google.com/macros/s/AKfycbx0_wj63qj6n3ADHCuHpaTdz-5NmQ61ZWSFKNCjaAkvSsmbBncpiITnkqFN3salqppCAA/exec";

  let scheduleCache = null;

  async function callApi(action, params = {}) {
    const url = new URL(API_URL);
    url.searchParams.append('action', action);
    for (const k in params) url.searchParams.append(k, params[k]);
    try { return await (await fetch(url)).json(); } catch (e) { return { error: "–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ" }; }
  }

  window.onload = async () => {
    const data = await callApi('getUserSchedule', { chatId: userId });
    document.getElementById('loader').classList.add('hidden');
    if (data && data.error === "UserNotFound") showSetup();
    else if (data && !data.error) showView(data);
    else showSetup();
  };

  async function showSetup() {
    document.getElementById('view-screen').classList.add('hidden');
    document.getElementById('setup-screen').classList.remove('hidden');
    const regions = await callApi('getRegions');
    const rSel = document.getElementById('region-select');
    rSel.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å –æ–±–ª–∞—Å—Ç—å</option>';
    if (regions) regions.forEach(r => rSel.innerHTML += `<option value="${r.url}">${r.name}</option>`);
  }

  async function loadQueues() {
    const url = document.getElementById('region-select').value;
    if (!url) return;
    const qs = await callApi('getChildren', { url });
    const qSel = document.getElementById('queue-select');
    qSel.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å —á–µ—Ä–≥—É</option>';
    if (qs) qs.forEach(q => qSel.innerHTML += `<option value="${q.url}">${q.name}</option>`);
    document.getElementById('queue-block').classList.remove('hidden');
  }

  async function saveConfig() {
    const qSel = document.getElementById('queue-select');
    if (!qSel.value) return alert("–û–±–µ—Ä—ñ—Ç—å —á–µ—Ä–≥—É!");
    document.getElementById('loader').classList.remove('hidden');
    await callApi('saveSelection', { chatId: userId, url: qSel.value, name: qSel.options[qSel.selectedIndex].text });
    location.reload();
  }

  function showView(data) {
    document.getElementById('setup-screen').classList.add('hidden');
    document.getElementById('view-screen').classList.remove('hidden');
    
    document.getElementById('view-queue').innerText = data.queueName || "–ß–µ—Ä–≥–∞";
    document.getElementById('view-region').innerText = data.region || "–í–∞—à–∞ –æ–±–ª–∞—Å—Ç—å";
    
    // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –¥–∞—Ç—É –≤ —Ç–∞–± (–°—å–æ–≥–æ–¥–Ω—ñ)
    if(data.dateStr) document.getElementById('date-today').innerText = data.dateStr;
    
    scheduleCache = data.schedule; // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –¥–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—ñ–≤
    renderGrid(data.schedule);
    updateStatusBlock(data.schedule); // –ó–∞–ø—É—Å–∫–∞—î–º–æ –±–ª–æ–∫ —Å—Ç–∞—Ç—É—Å—É
    
    // –ó–∞–ø—É—Å–∫–∞—î–º–æ —Ç–∞–π–º–µ—Ä –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É —â–æ—Ö–≤–∏–ª–∏–Ω–∏
    setInterval(() => updateStatusBlock(scheduleCache), 60000);
  }

  async function loadSchedule(offset) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById('tab-' + offset).classList.add('active');
    
    // –Ø–∫—â–æ "–°—å–æ–≥–æ–¥–Ω—ñ" - –ø–æ–∫–∞–∑—É—î–º–æ —Å—Ç–∞—Ç—É—Å, —è–∫—â–æ "–ó–∞–≤—Ç—Ä–∞" - —Ö–æ–≤–∞—î–º–æ
    const statusCard = document.getElementById('status-card');
    if(offset === 0) statusCard.classList.remove('hidden'); else statusCard.classList.add('hidden');

    const grid = document.getElementById('schedule-grid');
    grid.innerHTML = '<div style="width:100%;text-align:center;padding:20px;color:gray;">–û–Ω–æ–≤–ª–µ–Ω–Ω—è...</div>';
    
    const res = await callApi('getUserSchedule', { chatId: userId, dateOffset: offset });
    if (res.schedule && res.schedule.error) {
       grid.innerHTML = '';
       document.getElementById('error-msg').innerText = res.schedule.error;
    } else {
       if(offset === 0) scheduleCache = res.schedule; // –û–Ω–æ–≤–ª—é—î–º–æ –∫–µ—à —Ç—ñ–ª—å–∫–∏ –¥–ª—è —Å—å–æ–≥–æ–¥–Ω—ñ
       renderGrid(res.schedule);
       
       // –û–Ω–æ–≤–ª—é—î–º–æ –¥–∞—Ç—É –≤ —Ç–∞–±—ñ
       const dateSpan = offset === 0 ? 'date-today' : 'date-tomorrow';
       if(res.dateStr) document.getElementById(dateSpan).innerText = res.dateStr;
    }
  }

  function renderGrid(schedule) {
    const grid = document.getElementById('schedule-grid');
    grid.innerHTML = "";
    document.getElementById('error-msg').innerText = "";
    if (!schedule || !schedule.slots) return;

    const currentHour = new Date().getHours();
    const isToday = document.getElementById('tab-0').classList.contains('active');

    for (let i = 0; i < 24; i++) {
      const slot = schedule.slots.find(s => s.hour === i);
      const div = document.createElement('div');
      
      let className = 'hour';
      if (slot && slot.status === 'off') className += ' off-full';
      if (isToday && i === currentHour) className += ' current';

      div.className = className;
      div.innerText = `${String(i).padStart(2,'0')}-${String(i+1).padStart(2,'0')}`;
      grid.appendChild(div);
    }
  }

  // üî• –õ–û–ì–Ü–ö–ê –ë–õ–û–ö–£ –°–¢–ê–¢–£–°–£ –¢–ê –¢–ê–ô–ú–ï–†–ê
  function updateStatusBlock(schedule) {
    if (!schedule || !schedule.slots) return;
    
    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞, —á–∏ –º–∏ –Ω–∞ –≤–∫–ª–∞–¥—Ü—ñ "–°—å–æ–≥–æ–¥–Ω—ñ"
    if (!document.getElementById('tab-0').classList.contains('active')) return;

    const now = new Date();
    const currentHour = now.getHours();
    const currentMin = now.getMinutes();

    const slot = schedule.slots.find(s => s.hour === currentHour);
    const isOff = slot && slot.status === 'off';

    const header = document.getElementById('status-header');
    const timer = document.getElementById('status-timer');
    const nextText = document.getElementById('status-next');
    const card = document.getElementById('status-card');
    
    card.classList.remove('hidden');

    if (isOff) {
      header.innerHTML = `üåö –ó–∞—Ä–∞–∑ —Å–≤—ñ—Ç–ª–æ <span class="status-off-text">–í–Ü–î–°–£–¢–ù–Ñ</span>`;
    } else {
      header.innerHTML = `üåù –ó–∞—Ä–∞–∑ —Å–≤—ñ—Ç–ª–æ <span class="status-on-text">–Ñ</span>`;
    }

    // –®—É–∫–∞—î–º–æ, –∫–æ–ª–∏ –∑–º—ñ–Ω–∏—Ç—å—Å—è —Å—Ç–∞—Ç—É—Å
    let changeHour = -1;
    for (let i = currentHour + 1; i < 24; i++) {
      const nextSlot = schedule.slots.find(s => s.hour === i);
      const nextIsOff = nextSlot && nextSlot.status === 'off';
      if (nextIsOff !== isOff) {
        changeHour = i;
        break;
      }
    }

    if (changeHour !== -1) {
      // –†–∞—Ö—É—î–º–æ —Ö–≤–∏–ª–∏–Ω–∏
      const diffHrs = changeHour - currentHour;
      const totalMins = (diffHrs * 60) - currentMin;
      
      const hrsLeft = Math.floor(totalMins / 60);
      const minsLeft = totalMins % 60;
      
      let timeLeftStr = "";
      if (hrsLeft > 0) timeLeftStr += `${hrsLeft} –≥–æ–¥ `;
      timeLeftStr += `${minsLeft} —Ö–≤`;

      timer.innerText = `–ó–∞–ª–∏—à–∏–ª–æ—Å—è: ${timeLeftStr}`;
      
      const action = isOff ? "–£–≤—ñ–º–∫–Ω–µ–Ω–Ω—è" : "–í–∏–º–∫–Ω–µ–Ω–Ω—è";
      nextText.innerText = `${action} –æ ${String(changeHour).padStart(2,'0')}:00`;
    } else {
      timer.innerText = "–ë–µ–∑ –∑–º—ñ–Ω –¥–æ –∫—ñ–Ω—Ü—è –¥–æ–±–∏";
      nextText.innerText = "";
    }
  }
</script>
</body>
</html>
