<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* БАЗОВІ СТИЛІ З ТВОГО ФАЙЛУ 
       (Світла/Темна тема, сітка)
    */
    :root {
      --bg: var(--tg-theme-bg-color, #ffffff);
      --text: var(--tg-theme-text-color, #222);
      --button: var(--tg-theme-button-color, #2481cc);
      --button-text: var(--tg-theme-button-text-color, #fff);
      --secondary: var(--tg-theme-secondary-bg-color, #f0f2f5);
      --red: #ff3b30;
      --green: #34c759;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      margin: 0; padding: 16px;
      display: flex; flex-direction: column; min-height: 100vh;
    }

    .hidden { display: none !important; }

    /* ЕЛЕМЕНТИ ФОРМИ (SETUP) */
    .setup-container {
      text-align: center;
      padding-top: 20px;
    }
    select {
      width: 100%; padding: 12px; margin-bottom: 15px;
      border: 1px solid #ccc; border-radius: 12px;
      background: var(--secondary); color: var(--text);
      font-size: 16px; -webkit-appearance: none;
    }
    .btn-main {
      width: 100%; padding: 14px; border: none; border-radius: 12px;
      background: var(--button); color: var(--button-text);
      font-size: 16px; font-weight: 600; cursor: pointer;
    }

    /* ГРАФІК (VIEW) */
    .header { margin-bottom: 20px; text-align: center; }
    .tabs { display: flex; background: var(--secondary); border-radius: 10px; padding: 4px; margin-bottom: 20px; }
    .tab { flex: 1; padding: 8px; text-align: center; border-radius: 8px; cursor: pointer; font-size: 14px; }
    .tab.active { background: var(--bg); box-shadow: 0 2px 4px rgba(0,0,0,0.1); font-weight: 500; }

    .grid { 
      display: flex; flex-wrap: wrap; 
      border: 1px solid var(--secondary); border-radius: 12px; overflow: hidden; 
    }
    .cell {
      width: 4.16%; height: 45px; 
      display: flex; align-items: center; justify-content: center;
      font-size: 10px; border-right: 1px solid var(--secondary);
      box-sizing: border-box;
    }
    .cell:nth-child(24) { border-right: none; }

    .status-on { background-color: #e6e6a1; color: #333; }
    .status-off { background-color: #222; color: #fff; }

    .loader { margin-top: 50px; text-align: center; color: #888; }
  </style>
</head>
<body>

  <div id="loader" class="loader">Завантаження...</div>

  <div id="setup-screen" class="setup-container hidden">
    <h3>Налаштування</h3>
    <p style="color:#888; font-size:14px; margin-bottom:20px;">Оберіть вашу область та чергу для отримання графіків.</p>
    
    <select id="region-select" onchange="loadQueues()">
      <option value="">Завантаження областей...</option>
    </select>
    
    <div id="queue-block" class="hidden">
      <select id="queue-select">
        <option value="">Оберіть чергу</option>
      </select>
      <button class="btn-main" onclick="saveConfig()">Зберегти</button>
    </div>
  </div>

  <div id="view-screen" class="hidden">
    <div class="header">
      <h2 id="view-region" style="margin:0; font-size:18px;"></h2>
      <p id="view-queue" style="margin:5px 0; color: #888; font-size:14px;"></p>
    </div>

    <div class="tabs">
      <div id="tab-0" class="tab active" onclick="loadSchedule(0)">Сьогодні</div>
      <div id="tab-1" class="tab" onclick="loadSchedule(1)">Завтра</div>
    </div>

    <div id="schedule-container" class="grid"></div>
    <div id="error-msg" style="text-align:center; padding:20px; color:var(--red);"></div>

    <button onclick="showSetup()" style="margin-top:30px; background:none; border:none; color:var(--button); width:100%;">⚙️ Змінити налаштування</button>
  </div>

<script>
  const tg = window.Telegram.WebApp;
  tg.expand();
  // Фолбек ID для тестування в браузері
  const userId = tg.initDataUnsafe?.user?.id || "TEST_USER";
  
  // ВСТАВ СЮДИ URL, який отримаєш після DEPLOY
  const API_URL = "https://script.google.com/macros/s/AKfycbx0_wj63qj6n3ADHCuHpaTdz-5NmQ61ZWSFKNCjaAkvSsmbBncpiITnkqFN3salqppCAA/exec";

  // --- API ---
  async function callApi(action, params = {}) {
    const url = new URL(API_URL);
    url.searchParams.append('action', action);
    for (const k in params) url.searchParams.append(k, params[k]);
    try {
      const res = await fetch(url);
      return await res.json();
    } catch (e) {
      alert("Error: " + e.message);
      return null;
    }
  }

  // --- INIT ---
  window.onload = async () => {
    // 1. Перевіряємо, чи є юзер в базі
    const userConfig = await callApi('getUserSchedule', { chatId: userId });
    document.getElementById('loader').classList.add('hidden');

    if (userConfig && userConfig.error === "UserNotFound") {
      // Новий юзер -> Setup
      showSetup();
    } else if (userConfig && !userConfig.error) {
      // Існуючий -> Графік
      showView(userConfig);
    } else {
      // Помилка
      alert("Помилка завантаження: " + JSON.stringify(userConfig));
    }
  };

  // --- SETUP LOGIC ---
  async function showSetup() {
    document.getElementById('view-screen').classList.add('hidden');
    document.getElementById('setup-screen').classList.remove('hidden');
    
    const regions = await callApi('getRegions');
    const rSel = document.getElementById('region-select');
    rSel.innerHTML = '<option value="">Оберіть область</option>';
    
    regions.forEach(r => {
      const opt = document.createElement('option');
      opt.value = r.url;
      opt.text = r.name;
      rSel.appendChild(opt);
    });
  }

  async function loadQueues() {
    const url = document.getElementById('region-select').value;
    if (!url) return;
    
    const queues = await callApi('getChildren', { url: url });
    const qSel = document.getElementById('queue-select');
    qSel.innerHTML = '<option value="">Оберіть чергу</option>';
    
    queues.forEach(q => {
      const opt = document.createElement('option');
      opt.value = q.url;
      opt.text = q.name;
      qSel.appendChild(opt);
    });
    
    document.getElementById('queue-block').classList.remove('hidden');
  }

  async function saveConfig() {
    const qSel = document.getElementById('queue-select');
    
    if (!qSel.value) return alert("Оберіть чергу!");
    
    document.getElementById('loader').classList.remove('hidden');
    document.getElementById('setup-screen').classList.add('hidden');

    // ВИПРАВЛЕНО: action 'saveSelection' замість 'saveUserConfig'
    // і параметри підлаштовані під твій скрипт (url, name)
    await callApi('saveSelection', {
      chatId: userId,
      url: qSel.value,
      name: qSel.options[qSel.selectedIndex].text
    });

    // Перезавантажуємо сторінку, щоб побачити графік
    location.reload();
  }

  // --- VIEW LOGIC ---
  let currentData = null;

  function showView(data) {
    document.getElementById('setup-screen').classList.add('hidden');
    document.getElementById('view-screen').classList.remove('hidden');
    
    document.getElementById('view-region').innerText = data.region;
    document.getElementById('view-queue').innerText = data.queueName;
    
    renderGrid(data.schedule);
  }

  async function loadSchedule(offset) {
    // UI Tabs
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById('tab-' + offset).classList.add('active');
    
    document.getElementById('schedule-container').innerHTML = '<div style="width:100%;text-align:center;padding:20px;">Оновлення...</div>';
    document.getElementById('error-msg').innerText = '';

    const res = await callApi('getUserSchedule', { chatId: userId, dateOffset: offset });
    
    if (res.schedule && res.schedule.error) {
      document.getElementById('schedule-container').innerHTML = '';
      document.getElementById('error-msg').innerText = res.schedule.error;
    } else {
      renderGrid(res.schedule);
    }
  }

  function renderGrid(schedule) {
    const container = document.getElementById('schedule-container');
    container.innerHTML = "";
    
    if (!schedule || !schedule.slots) return;

    // Малюємо 24 години
    for (let i = 0; i < 24; i++) {
      const slot = schedule.slots.find(s => s.hour === i);
      const div = document.createElement('div');
      div.className = 'cell';
      
      if (slot && slot.status === 'off') {
        div.classList.add('status-off');
      } else {
        div.classList.add('status-on');
      }
      
      div.innerText = i;
      container.appendChild(div);
    }
  }
</script>
</body>
</html>
