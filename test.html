<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ccc; background: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); }
        select:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn { background: #2481cc; color: white; border: none; padding: 15px; width: 100%; border-radius: 8px; cursor: pointer; font-size: 16px; margin-top: 10px; }
        .btn:disabled { background: #aaa; }
        .loader { font-size: 12px; color: #2481cc; display: none; margin-top: 5px; }
    </style>
</head>
<body>
    <div id="setup">
        <h3>üìç –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ª–æ–∫–∞—Ü—ñ—ó</h3>
        
        <div class="form-group">
            <label>1. –û–±–ª–∞—Å—Ç—å:</label>
            <select id="region" onchange="onRegionChange()">
                <option value="">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –æ–±–ª–∞—Å—Ç–µ–π...</option>
            </select>
        </div>

        <div class="form-group">
            <label>2. –ú—ñ—Å—Ç–æ/–†–∞–π–æ–Ω:</label>
            <select id="city" disabled onchange="onCityChange()">
                <option value="">–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –æ–±–ª–∞—Å—Ç—å</option>
            </select>
            <div id="city-loader" class="loader">–ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Å–ø–∏—Å–æ–∫...</div>
        </div>

        <div class="form-group">
            <label>3. –ß–µ—Ä–≥–∞/–í—É–ª–∏—Ü—è:</label>
            <select id="queue" disabled>
                <option value="">–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ç–æ</option>
            </select>
            <div id="queue-loader" class="loader">–ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —á–µ—Ä–≥–∏...</div>
        </div>

        <button id="save-btn" class="btn" disabled onclick="save()">–ó–±–µ—Ä–µ–≥—Ç–∏ –≤–∏–±—ñ—Ä</button>
    </div>

    <script>
        // –í–ê–ñ–õ–ò–í–û: –ó–∞–º—ñ–Ω–∏ –Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è —Ç–≤–æ–µ–≥–æ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbx0_wj63qj6n3ADHCuHpaTdz-5NmQ61ZWSFKNCjaAkvSsmbBncpiITnkqFN3salqppCAA/exec";
        let tg = window.Telegram.WebApp;
        tg.expand();

        // 1. –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –æ–±–ª–∞—Å—Ç–µ–π
        async function init() {
            try {
                const res = await fetch(`${WEB_APP_URL}?action=getRegions`);
                const data = await res.json();
                const sel = document.getElementById('region');
                sel.innerHTML = '<option value="">-- –û–±–µ—Ä—ñ—Ç—å –æ–±–ª–∞—Å—Ç—å --</option>';
                data.forEach(r => sel.innerHTML += `<option value="${r.url}">${r.name}</option>`);
            } catch (e) {
                alert("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –æ–±–ª–∞—Å—Ç–µ–π");
            }
        }

        // 2. –î—ñ—è –ø—Ä–∏ –≤–∏–±–æ—Ä—ñ –æ–±–ª–∞—Å—Ç—ñ
        async function onRegionChange() {
            const regionUrl = document.getElementById('region').value;
            const citySel = document.getElementById('city');
            const queueSel = document.getElementById('queue');
            const saveBtn = document.getElementById('save-btn');

            // –°–∫–∏–¥–∞—î–º–æ –Ω–∞—Å—Ç—É–ø–Ω—ñ –ø–æ–ª—è
            citySel.innerHTML = '<option value="">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</option>';
            citySel.disabled = true;
            queueSel.innerHTML = '<option value="">–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ç–æ</option>';
            queueSel.disabled = true;
            saveBtn.disabled = regionUrl === "";

            if (!regionUrl) return;

            document.getElementById('city-loader').style.display = 'block';
            try {
                const res = await fetch(`${WEB_APP_URL}?action=getChildren&url=${encodeURIComponent(regionUrl)}`);
                const data = await res.json();
                
                citySel.innerHTML = '<option value="">-- –û–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ç–æ --</option>';
                if (data.length > 0) {
                    data.forEach(item => citySel.innerHTML += `<option value="${item.url}">${item.name}</option>`);
                    citySel.disabled = false;
                } else {
                    citySel.innerHTML = '<option value="">–ú—ñ—Å—Ç –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</option>';
                }
            } catch (e) {
                alert("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º—ñ—Å—Ç");
            } finally {
                document.getElementById('city-loader').style.display = 'none';
            }
        }

        // 3. –î—ñ—è –ø—Ä–∏ –≤–∏–±–æ—Ä—ñ –º—ñ—Å—Ç–∞
        async function onCityChange() {
            const cityUrl = document.getElementById('city').value;
            const queueSel = document.getElementById('queue');

            queueSel.innerHTML = '<option value="">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</option>';
            queueSel.disabled = true;

            if (!cityUrl) return;

            document.getElementById('queue-loader').style.display = 'block';
            try {
                const res = await fetch(`${WEB_APP_URL}?action=getChildren&url=${encodeURIComponent(cityUrl)}`);
                const data = await res.json();
                
                if (data.length > 0) {
                    queueSel.innerHTML = '<option value="">-- –û–±–µ—Ä—ñ—Ç—å —á–µ—Ä–≥—É --</option>';
                    data.forEach(item => queueSel.innerHTML += `<option value="${item.url}">${item.name}</option>`);
                    queueSel.disabled = false;
                } else {
                    queueSel.innerHTML = '<option value="">–ß–µ—Ä–≥ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</option>';
                }
            } catch (e) {
                alert("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —á–µ—Ä–≥");
            } finally {
                document.getElementById('queue-loader').style.display = 'none';
            }
        }

        // 4. –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è
        async function save() {
            const region = document.getElementById('region');
            const city = document.getElementById('city');
            const queue = document.getElementById('queue');
            
            // –ë–µ—Ä–µ–º–æ –Ω–∞–π–±—ñ–ª—å—à —Ç–æ—á–Ω–∏–π –æ–±—Ä–∞–Ω–∏–π URL
            const finalUrl = queue.value || city.value || region.value;
            const finalName = (queue.value ? queue.selectedOptions[0].text : 
                              (city.value ? city.selectedOptions[0].text : region.selectedOptions[0].text));
            
            const chatId = tg.initDataUnsafe.user?.id || "197183975";
            const btn = document.getElementById('save-btn');
            
            btn.disabled = true;
            btn.innerText = "–ó–±–µ—Ä—ñ–≥–∞—î–º–æ...";

            try {
                const response = await fetch(`${WEB_APP_URL}?action=saveSelection&chatId=${chatId}&url=${encodeURIComponent(finalUrl)}&name=${encodeURIComponent(finalName)}`);
                if (response.ok) {
                    tg.close(); // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ –¢–Ü–õ–¨–ö–ò –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
                } else {
                    alert("–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ");
                    btn.disabled = false;
                    btn.innerText = "–ó–±–µ—Ä–µ–≥—Ç–∏ –≤–∏–±—ñ—Ä";
                }
            } catch (e) {
                alert("–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ");
                btn.disabled = false;
                btn.innerText = "–ó–±–µ—Ä–µ–≥—Ç–∏ –≤–∏–±—ñ—Ä";
            }
        }

        init();
    </script>
</body>
</html>
