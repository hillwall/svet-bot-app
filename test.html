<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg-color: var(--tg-theme-bg-color, #fff);
      --text-color: var(--tg-theme-text-color, #000);
      --button-color: var(--tg-theme-button-color, #2481cc);
      --button-text: var(--tg-theme-button-text-color, #fff);
      --secondary-bg: var(--tg-theme-secondary-bg-color, #f0f0f0);
    }
    body { font-family: sans-serif; background: var(--bg-color); color: var(--text-color); padding: 20px; }
    .hidden { display: none; }
    select, button { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #ccc; background: var(--secondary-bg); color: var(--text-color); font-size: 16px; }
    button { background: var(--button-color); color: var(--button-text); border: none; font-weight: bold; cursor: pointer; }
    
    /* Стилі для сітки графіка (з Вінницького файлу) */
    .grid { display: flex; flex-wrap: wrap; margin-top: 20px; }
    .hour { width: 4.16%; height: 40px; border: 1px solid #eee; box-sizing: border-box; display: flex; align-items: center; justify-content: center; font-size: 10px; }
    .status-on { background-color: #e6e6a1; color: #000; } /* Світло є */
    .status-off { background-color: #333; color: #fff; } /* Світла немає */
    
    h2, h3 { text-align: center; }
  </style>
</head>
<body>

  <div id="setup-screen" class="hidden">
    <h3>Оберіть область та чергу</h3>
    <select id="region-select"><option value="">Завантаження областей...</option></select>
    <select id="queue-select" class="hidden"><option value="">Спочатку оберіть область</option></select>
    <button id="save-btn" class="hidden" onclick="saveConfig()">Зберегти</button>
  </div>

  <div id="schedule-screen" class="hidden">
    <h2 id="user-queue-title">Ваша черга</h2>
    <div style="display:flex; gap:10px;">
      <button onclick="loadSchedule(0)">Сьогодні</button>
      <button onclick="loadSchedule(1)">Завтра</button>
    </div>
    <div id="schedule-container" class="grid"></div>
    <p id="status-msg" style="text-align:center; margin-top:20px; color: gray;"></p>
    <button onclick="showSetup()" style="margin-top:30px; background: #555;">Змінити чергу</button>
  </div>

<script>
  const tg = window.Telegram.WebApp;
  tg.expand();
  const userId = tg.initDataUnsafe?.user?.id;
  // const userId = "197183975"; // Для тестів у браузері розкоментуй

  function run() {
    // 1. Перевіряємо, чи є у користувача збережена черга
    google.script.run.withSuccessHandler(userData => {
      if (userData && userData.queueUrl) {
        showScheduleScreen(userData);
      } else {
        showSetup();
      }
    }).getUserData(userId);
  }

  // --- ЛОГІКА НАЛАШТУВАННЯ ---
  function showSetup() {
    document.getElementById('schedule-screen').classList.add('hidden');
    document.getElementById('setup-screen').classList.remove('hidden');
    loadRegions();
  }

  function loadRegions() {
    google.script.run.withSuccessHandler(regions => {
      const sel = document.getElementById('region-select');
      sel.innerHTML = '<option value="">Оберіть область</option>';
      regions.forEach(r => {
        const opt = document.createElement('option');
        opt.value = r.url;
        opt.text = r.name;
        sel.appendChild(opt);
      });
      sel.onchange = () => loadQueues(sel.value, sel.options[sel.selectedIndex].text);
    }).doGet({ parameter: { action: 'getRegions' } }); // Виклик серверної функції через обгортку або прямий запит
    // Примітка: через google.script.run ми не можемо передавати об'єкт event, тому треба адаптувати сервер
    // АБО використовувати fetch до WebApp URL. 
    // ДЛЯ ПРОСТОТИ: використовуємо fetch, бо це Mini App.
  }
  
  // Хак для виклику doGet через google.script.run не працює напряму з параметрами e.
  // Тому краще використовувати fetch до deployed Web App URL
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbx0_wj63qj6n3ADHCuHpaTdz-5NmQ61ZWSFKNCjaAkvSsmbBncpiITnkqFN3salqppCAA/exec";

  function api(action, params = {}) {
    const url = new URL(WEB_APP_URL);
    url.searchParams.append('action', action);
    for (const key in params) url.searchParams.append(key, params[key]);
    return fetch(url).then(res => res.json());
  }

  // Переписуємо loadRegions з fetch
  function loadRegions() {
    api('getRegions').then(regions => {
      const sel = document.getElementById('region-select');
      sel.innerHTML = '<option value="">Оберіть область</option>';
      regions.forEach(r => {
        const opt = document.createElement('option');
        opt.value = r.url;
        opt.text = r.name;
        sel.appendChild(opt);
      });
      sel.onchange = () => loadQueues(sel.value, sel.options[sel.selectedIndex].text);
    });
  }

  function loadQueues(parentUrl, regionName) {
    if(!parentUrl) return;
    window.selectedRegion = regionName;
    api('getChildren', { url: parentUrl }).then(children => {
      const sel = document.getElementById('queue-select');
      sel.classList.remove('hidden');
      sel.innerHTML = '<option value="">Оберіть чергу</option>';
      children.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.url;
        opt.text = c.name;
        sel.appendChild(opt);
      });
      sel.onchange = () => {
        document.getElementById('save-btn').classList.remove('hidden');
      };
    });
  }

  function saveConfig() {
    const qSel = document.getElementById('queue-select');
    const qUrl = qSel.value;
    const qName = qSel.options[qSel.selectedIndex].text;
    
    api('saveUserConfig', {
      chatId: userId,
      region: window.selectedRegion,
      queueName: qName,
      queueUrl: qUrl
    }).then(res => {
      if(res.success) {
        // Перезавантажуємо сторінку або переходимо до графіка
        location.reload(); 
      }
    });
  }

  // --- ЛОГІКА ВІДОБРАЖЕННЯ ---
  function showScheduleScreen(user) {
    document.getElementById('setup-screen').classList.add('hidden');
    document.getElementById('schedule-screen').classList.remove('hidden');
    document.getElementById('user-queue-title').innerText = `${user.region} - ${user.queueName}`;
    loadSchedule(0);
  }

  function loadSchedule(offset) {
    document.getElementById('status-msg').innerText = "Завантаження...";
    document.getElementById('schedule-container').innerHTML = "";
    
    api('getUserSchedule', { chatId: userId, dateOffset: offset }).then(data => {
      document.getElementById('status-msg').innerText = "";
      if(data.schedule.error) {
        document.getElementById('status-msg').innerText = data.schedule.error;
        return;
      }
      renderGrid(data.schedule.slots);
    });
  }

  function renderGrid(slots) {
    const container = document.getElementById('schedule-container');
    container.innerHTML = "";
    // Припустимо slots = [{hour: 0, status: 'on'}, ...]
    // Спрощена візуалізація. В робочому Вінницькому скрипті вона складніша.
    for(let i=0; i<24; i++) {
        const slot = slots.find(s => s.hour === i);
        const div = document.createElement('div');
        div.className = 'hour ' + (slot && slot.status === 'on' ? 'status-on' : 'status-off');
        div.innerText = i;
        container.appendChild(div);
    }
  }

  // Старт
  run(); 
  // (Але через те, що userId з initDataUnsafe може бути недоступний при прямому відкритті,
  // краще тестувати це всередині Telegram)
</script>
</body>
</html>
