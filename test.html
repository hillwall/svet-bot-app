<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* Стилі ідентичні Вінницьким, адаптовані під темну/світлу тему */
    :root {
      --bg-color: var(--tg-theme-bg-color, #fff);
      --text-color: var(--tg-theme-text-color, #000);
      --button-bg: var(--tg-theme-button-color, #2481cc);
      --button-text: var(--tg-theme-button-text-color, #fff);
      --secondary-bg: var(--tg-theme-secondary-bg-color, #f0f0f0);
    }
    body { font-family: sans-serif; background: var(--bg-color); color: var(--text-color); padding: 16px; margin: 0; }
    .hidden { display: none; }
    
    /* Елементи форм */
    select { width: 100%; padding: 12px; margin-bottom: 12px; border-radius: 10px; border: 1px solid #ccc; background: var(--secondary-bg); color: var(--text-color); font-size: 16px; -webkit-appearance: none; }
    button { width: 100%; padding: 14px; border-radius: 10px; border: none; background: var(--button-bg); color: var(--button-text); font-size: 16px; font-weight: bold; cursor: pointer; margin-bottom: 10px;}
    
    /* Графік */
    .grid { display: flex; flex-wrap: wrap; margin-top: 20px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; }
    .hour { width: 4.16%; height: 45px; display: flex; align-items: center; justify-content: center; font-size: 10px; border-right: 1px solid #eee; box-sizing: border-box; }
    .hour:last-child { border-right: none; }
    
    .status-on { background-color: #e6e6a1; color: #333; } /* Світло є */
    .status-off { background-color: #2c2c2c; color: #fff; } /* Світла немає */
    
    .header { text-align: center; margin-bottom: 20px; }
    .tabs { display: flex; gap: 10px; margin-bottom: 15px; }
    .tabs button { flex: 1; margin: 0; background: var(--secondary-bg); color: var(--text-color); }
    .tabs button.active { background: var(--button-bg); color: var(--button-text); }
  </style>
</head>
<body>

  <div id="loader" style="text-align:center; margin-top: 50px;">Завантаження...</div>

  <div id="setup-screen" class="hidden">
    <div class="header"><h3>Налаштування</h3></div>
    <p>Оберіть вашу область:</p>
    <select id="region-select" onchange="loadQueues()"><option value="">Завантаження...</option></select>
    
    <div id="queue-block" class="hidden">
      <p>Оберіть вашу чергу/групу:</p>
      <select id="queue-select"><option value="">Спочатку оберіть область</option></select>
      <button onclick="saveConfig()">Зберегти</button>
    </div>
  </div>

  <div id="schedule-screen" class="hidden">
    <div class="header">
      <h2 id="region-title" style="margin:0; font-size:18px;"></h2>
      <p id="queue-title" style="margin:5px 0; color: gray;"></p>
    </div>

    <div class="tabs">
      <button id="btn-today" class="active" onclick="switchDay(0)">Сьогодні</button>
      <button id="btn-tomorrow" onclick="switchDay(1)">Завтра</button>
    </div>

    <div id="schedule-grid" class="grid"></div>
    <p id="msg-box" style="text-align:center; margin-top:20px; color: #777;"></p>

    <button onclick="showSetup()" style="background: transparent; color: var(--text-color); border: 1px solid #ccc; margin-top:30px;">⚙️ Змінити налаштування</button>
  </div>

<script>
  const tg = window.Telegram.WebApp;
  tg.expand();
  const userId = tg.initDataUnsafe?.user?.id || "TEST_USER"; // Фолбек для браузера

  // URL до твого скрипта (потрібен для fetch запитів)
  // Встав сюди той самий URL, що і в Code.gs const WEB_APP_URL
  const API_URL = "https://script.google.com/macros/s/AKfycbx0_wj63qj6n3ADHCuHpaTdz-5NmQ61ZWSFKNCjaAkvSsmbBncpiITnkqFN3salqppCAA/exec";

  // --- API HELPER ---
  async function api(action, params = {}) {
    const url = new URL(API_URL);
    url.searchParams.append('action', action);
    for (const key in params) url.searchParams.append(key, params[key]);
    
    try {
      const res = await fetch(url);
      return await res.json();
    } catch (e) {
      alert("Помилка з'єднання: " + e.message);
      return null;
    }
  }

  // --- INIT ---
  window.onload = async () => {
    // Перевіряємо, чи є збережені дані (спробуємо завантажити графік)
    // Якщо графік вертає "User not found" -> показуємо налаштування
    const res = await api('getUserSchedule', { chatId: userId });
    
    document.getElementById('loader').classList.add('hidden');
    
    if (res && !res.error) {
      // Користувач є, показуємо графік
      showScheduleScreen(res);
    } else {
      // Користувача немає, показуємо налаштування
      showSetup();
    }
  };

  // --- SETUP LOGIC ---
  async function showSetup() {
    document.getElementById('schedule-screen').classList.add('hidden');
    document.getElementById('setup-screen').classList.remove('hidden');
    
    const regions = await api('getRegions');
    const sel = document.getElementById('region-select');
    sel.innerHTML = '<option value="">Оберіть область</option>';
    regions.forEach(r => {
      const opt = document.createElement('option');
      opt.value = r.url;
      opt.text = r.name;
      sel.appendChild(opt);
    });
  }

  async function loadQueues() {
    const rSel = document.getElementById('region-select');
    const url = rSel.value;
    if (!url) return;
    
    const qs = await api('getChildren', { url: url });
    const qSel = document.getElementById('queue-select');
    qSel.innerHTML = '<option value="">Оберіть чергу</option>';
    qs.forEach(q => {
      const opt = document.createElement('option');
      opt.value = q.url;
      opt.text = q.name;
      qSel.appendChild(opt);
    });
    document.getElementById('queue-block').classList.remove('hidden');
  }

  async function saveConfig() {
    const rSel = document.getElementById('region-select');
    const qSel = document.getElementById('queue-select');
    
    if (!qSel.value) return alert("Оберіть чергу!");
    
    document.getElementById('loader').classList.remove('hidden');
    document.getElementById('setup-screen').classList.add('hidden');
    
    await api('saveUserConfig', {
      chatId: userId,
      region: rSel.options[rSel.selectedIndex].text,
      queueName: qSel.options[qSel.selectedIndex].text,
      queueUrl: qSel.value
    });
    
    location.reload(); // Перезавантажуємо, щоб відкрити графік
  }

  // --- SCHEDULE LOGIC ---
  let currentScheduleData = null;

  function showScheduleScreen(data) {
    document.getElementById('schedule-screen').classList.remove('hidden');
    document.getElementById('region-title').innerText = data.region;
    document.getElementById('queue-title').innerText = data.queueName;
    
    renderGrid(data.schedule);
  }

  async function switchDay(offset) {
    document.getElementById('btn-today').className = offset === 0 ? 'active' : '';
    document.getElementById('btn-tomorrow').className = offset === 1 ? 'active' : '';
    
    document.getElementById('schedule-grid').innerHTML = '<div style="width:100%; text-align:center; padding:20px;">Завантаження...</div>';
    document.getElementById('msg-box').innerText = "";

    const res = await api('getUserSchedule', { chatId: userId, dateOffset: offset });
    renderGrid(res.schedule);
  }

  function renderGrid(schedule) {
    const grid = document.getElementById('schedule-grid');
    grid.innerHTML = "";
    
    if (schedule.error) {
      grid.innerHTML = `<div style="padding:20px; width:100%; text-align:center;">${schedule.error}</div>`;
      return;
    }

    const slots = schedule.slots || [];
    for (let i = 0; i < 24; i++) {
      const slot = slots.find(s => s.hour === i);
      const div = document.createElement('div');
      div.className = 'hour';
      
      if (slot && slot.status === 'off') {
        div.classList.add('status-off');
      } else {
        div.classList.add('status-on');
      }
      
      div.innerText = i;
      grid.appendChild(div);
    }
  }
</script>
</body>
</html>
