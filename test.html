<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ì—Ä–∞—Ñ—ñ–∫ —Å–≤—ñ—Ç–ª–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: var(--tg-theme-bg-color, #212121);
            color: var(--tg-theme-text-color, #ffffff);
            font-family: sans-serif;
            padding-bottom: 40px;
            font-size: 14px;
        }
        .container { max-width: 400px; }
        
        /* HEADER */
        .header-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .queue-title { font-weight: bold; font-size: 1.1em; }
        .date-display { color: var(--tg-theme-hint-color, #aaaaaa); font-size: 0.9em; }

        /* STATUS BANNER */
        .status-card {
            background-color: #2c2c2c;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            margin-bottom: 15px;
            border: 1px solid #444;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .status-card.on { background: linear-gradient(135deg, #2e4a2e 0%, #1e331e 100%); border-color: #4caf50; }
        .status-card.off { background: linear-gradient(135deg, #4a2e2e 0%, #331e1e 100%); border-color: #f44336; }
        .status-emoji { font-size: 1.5em; display: block; margin-bottom: 5px; }
        .status-timer { font-size: 1.2em; font-weight: bold; margin: 5px 0; }
        .status-next { font-size: 0.9em; opacity: 0.9; }

        /* TABS */
        .nav-pills .nav-link {
            color: var(--tg-theme-text-color, #fff);
            background-color: #2c2c2c;
            margin: 0 5px;
            border-radius: 8px;
            padding: 8px 0;
        }
        .nav-pills .nav-link.active {
            background-color: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #fff);
        }

        /* GRID */
        .slot-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 15px;
        }
        .slot {
            border-radius: 8px;
            padding: 12px 2px;
            text-align: center;
            font-size: 13px;
            font-weight: 600;
            background-color: #2c2c2c;
            border: 1px solid #444;
            color: #ccc;
        }
        .slot.on { background-color: #ffffff; color: #000; border-color: #fff; }
        .slot.off { background-color: #1a1a1a; color: #555; border-color: #333; }
        .slot.maybe { background-color: #6c757d; color: #fff; }
        .slot.current { 
            border: 2px solid var(--tg-theme-button-color, #3390ec); 
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(51, 144, 236, 0.4);
            z-index: 2;
        }

        /* CONTROLS */
        .btn-tg {
            background-color: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            margin-top: 15px;
            font-weight: bold;
        }
        .btn-outline {
            background: transparent;
            border: 1px solid var(--tg-theme-hint-color, #777);
            color: var(--tg-theme-hint-color, #ccc);
            margin-top: 25px;
            font-size: 0.9em;
        }
        .hidden { display: none !important; }
        .empty-msg { text-align: center; padding: 30px; color: #888; }
    </style>
</head>
<body>

<div class="container py-3">
    <div id="setup-screen" class="hidden">
        <h4 class="mb-4 text-center">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h4>
        <div class="mb-3">
            <label class="form-label text-muted small">–û–±–ª–∞—Å—Ç—å</label>
            <select id="region-select" class="form-select bg-dark text-white border-secondary">
                <option value="">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</option>
            </select>
        </div>
        <div class="mb-3">
            <label class="form-label text-muted small">–ß–µ—Ä–≥–∞</label>
            <select id="queue-select" class="form-select bg-dark text-white border-secondary" disabled>
                <option value="">–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –æ–±–ª–∞—Å—Ç—å</option>
            </select>
        </div>
        <button id="save-btn" class="btn-tg" onclick="saveSettings()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
        <div class="text-center mt-3">
            <button class="btn btn-link text-muted" onclick="showScheduleView()" style="text-decoration: none;">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        </div>
    </div>

    <div id="schedule-screen">
        <div class="header-info">
            <div>
                <div class="queue-title" id="display-queue-name">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
                <div class="date-display" id="display-region-name"></div>
            </div>
            <button class="btn btn-sm btn-dark border-0" onclick="tg.close()">‚úñ</button>
        </div>

        <div id="status-banner" class="status-card hidden">
            </div>

        <ul class="nav nav-pills nav-fill mt-3">
            <li class="nav-item">
                <a class="nav-link active" id="tab-today" href="#" onclick="switchDay(0)">–°—å–æ–≥–æ–¥–Ω—ñ</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="tab-tomorrow" href="#" onclick="switchDay(1)">–ó–∞–≤—Ç—Ä–∞</a>
            </li>
        </ul>

        <div id="grid-container" class="slot-grid">
            <div class="col-span-4 text-center py-5">‚åõ –û—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö...</div>
        </div>

        <button class="btn-tg btn-outline" onclick="toggleEdit()">‚öôÔ∏è –ó–º—ñ–Ω–∏—Ç–∏ —á–µ—Ä–≥—É</button>
    </div>
</div>

<script>
    // --- CONFIG ---
    // –ó–ê–ú–Ü–ù–ò –ù–ê –ê–ö–¢–£–ê–õ–¨–ù–ò–ô URL –ü–Ü–°–õ–Ø Deploy -> New Version
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbx0_wj63qj6n3ADHCuHpaTdz-5NmQ61ZWSFKNCjaAkvSsmbBncpiITnkqFN3salqppCAA/exec'; 
    
    let tg = window.Telegram.WebApp;
    tg.expand();

    let regionsData = [];
    let currentUserId = tg.initDataUnsafe?.user?.id || 'TEST_USER_BROWSER';
    let userSettings = null;
    let currentSchedule = []; // –î–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—ñ–≤ –±–∞–Ω–µ—Ä–∞

    window.onload = async function() {
        // 1. Get User Profile
        try {
            const resp = await fetch(`${GAS_API_URL}?action=getUser&userId=${currentUserId}`);
            userSettings = await resp.json();
            
            loadRegions(); // Start loading list in background

            if (userSettings.found) {
                document.getElementById('display-queue-name').innerText = userSettings.queueName;
                document.getElementById('display-region-name').innerText = userSettings.regionName;
                showScheduleView();
                switchDay(0); // Load Today
            } else {
                toggleEdit(); // Show setup
            }
        } catch (e) {
            document.getElementById('grid-container').innerHTML = `<div class="empty-msg">–ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è: ${e}</div>`;
        }
    };

    // --- LOGIC ---

    async function loadRegions() {
        const resp = await fetch(`${GAS_API_URL}?action=getTree`);
        regionsData = await resp.json();
        
        const rSelect = document.getElementById('region-select');
        rSelect.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å –æ–±–ª–∞—Å—Ç—å...</option>';
        
        Object.keys(regionsData).forEach(rName => {
            const opt = document.createElement('option');
            opt.value = rName;
            opt.innerText = rName;
            rSelect.appendChild(opt);
        });

        rSelect.addEventListener('change', () => {
            const qSelect = document.getElementById('queue-select');
            qSelect.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å —á–µ—Ä–≥—É...</option>';
            qSelect.disabled = false;
            
            const queues = regionsData[rSelect.value];
            if(queues) {
                queues.forEach(q => {
                    const opt = document.createElement('option');
                    opt.value = q.url;
                    opt.innerText = q.name;
                    qSelect.appendChild(opt);
                });
            }
        });
    }

    async function saveSettings() {
        const rSelect = document.getElementById('region-select');
        const qSelect = document.getElementById('queue-select');
        
        if(!rSelect.value || !qSelect.value) {
            tg.showAlert("–û–±–µ—Ä—ñ—Ç—å –æ–±–ª–∞—Å—Ç—å —Ç–∞ —á–µ—Ä–≥—É");
            return;
        }

        const rName = rSelect.options[rSelect.selectedIndex].text;
        const qName = qSelect.options[qSelect.selectedIndex].text;
        const qUrl = qSelect.value;

        tg.MainButton.showProgress();
        await fetch(`${GAS_API_URL}?action=saveUser&userId=${currentUserId}&regionName=${encodeURIComponent(rName)}&queueName=${encodeURIComponent(qName)}&queueUrl=${encodeURIComponent(qUrl)}`);
        tg.MainButton.hideProgress();

        // Update local context
        userSettings = { found: true, regionName: rName, queueName: qName, queueUrl: qUrl };
        document.getElementById('display-queue-name').innerText = qName;
        document.getElementById('display-region-name').innerText = rName;
        
        showScheduleView();
        switchDay(0);
    }

    let activeDayOffset = 0;

    async function switchDay(dayOffset) {
        activeDayOffset = dayOffset;
        document.getElementById('tab-today').classList.toggle('active', dayOffset === 0);
        document.getElementById('tab-tomorrow').classList.toggle('active', dayOffset === 1);
        
        const container = document.getElementById('grid-container');
        container.innerHTML = '<div class="col-span-4 text-center py-5">‚åõ</div>';
        document.getElementById('status-banner').classList.add('hidden');

        const date = new Date();
        date.setDate(date.getDate() + dayOffset);
        const dateStr = date.toISOString().split('T')[0];

        if (!userSettings || !userSettings.queueUrl) return;

        const resp = await fetch(`${GAS_API_URL}?action=getSchedule&queueUrl=${encodeURIComponent(userSettings.queueUrl)}&date=${dateStr}`);
        const data = await resp.json();
        
        currentSchedule = data.schedule;
        renderGrid(data.schedule);
        
        if (dayOffset === 0) updateStatusBanner();
        else document.getElementById('status-banner').classList.add('hidden');
    }

    function renderGrid(scheduleArray) {
        const container = document.getElementById('grid-container');
        container.innerHTML = '';

        if (!scheduleArray || scheduleArray.length === 0) {
            container.innerHTML = `<div class="empty-msg" style="grid-column: span 4;">
                ü§∑‚Äç‚ôÇÔ∏è –ì—Ä–∞—Ñ—ñ–∫ –Ω–∞ —Ü–µ–π –¥–µ–Ω—å —â–µ –Ω–µ –æ–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ.
            </div>`;
            return;
        }

        const now = new Date();
        const currentH = now.getHours();

        // Convert 48 slots to 24 visual blocks
        for (let h = 0; h < 24; h++) {
            const val1 = scheduleArray[h*2];     // 00:00-00:30
            const val2 = scheduleArray[h*2+1];   // 00:30-01:00
            
            const div = document.createElement('div');
            div.className = 'slot';
            div.innerText = `${h.toString().padStart(2,'0')}-${(h+1).toString().padStart(2,'0')}`;
            
            // Logic: If ANY part is OFF -> OFF. Else ON.
            let displayClass = 'on';
            if (val1 === 0 || val2 === 0) displayClass = 'off';
            else if (val1 === 2 || val2 === 2) displayClass = 'maybe';
            
            div.classList.add(displayClass);
            
            // Highlight current hour ONLY if Today
            if (activeDayOffset === 0 && h === currentH) {
                div.classList.add('current');
            }
            
            container.appendChild(div);
        }
    }

    function updateStatusBanner() {
        const banner = document.getElementById('status-banner');
        
        if (!currentSchedule || currentSchedule.length === 0) {
            banner.classList.add('hidden');
            return;
        }

        const now = new Date();
        // Index 0..47
        const nowIndex = now.getHours() * 2 + (now.getMinutes() >= 30 ? 1 : 0);
        
        // Safety check if day just rolled over but page loaded
        if (nowIndex >= 48) return; 

        const isLight = currentSchedule[nowIndex] === 1;
        const currentStatusVal = currentSchedule[nowIndex];

        // Find next change
        let changeIndex = -1;
        for (let i = nowIndex + 1; i < 48; i++) {
            if (currentSchedule[i] !== currentStatusVal) {
                changeIndex = i;
                break;
            }
        }

        banner.classList.remove('hidden', 'on', 'off');
        banner.classList.add(isLight ? 'on' : 'off');

        let statusText = isLight ? "–ó–∞—Ä–∞–∑ —Å–≤—ñ—Ç–ª–æ –Ñ (–ø–æ –≥—Ä–∞—Ñ—ñ–∫—É)" : "–ó–∞—Ä–∞–∑ —Å–≤—ñ—Ç–ª–æ –í–Ü–î–°–£–¢–ù–Ñ";
        let emoji = isLight ? "üåù" : "üåö";
        
        // Time diff
        let timeLeftHtml = "";
        let nextEventHtml = "";

        if (changeIndex !== -1) {
            // Minutes until change
            // changeIndex starts at e.g. 32 (16:00). Current is 14:45.
            const targetDate = new Date();
            targetDate.setHours(Math.floor(changeIndex / 2));
            targetDate.setMinutes((changeIndex % 2) * 30);
            targetDate.setSeconds(0);
            
            // If change is tomorrow (not handled by this simple logic for single array), handle simple case
            const diffMs = targetDate - now;
            if (diffMs > 0) {
                const diffHrs = Math.floor(diffMs / 3600000);
                const diffMins = Math.floor((diffMs % 3600000) / 60000);
                
                timeLeftHtml = `<div>–ó–∞–ª–∏—à–∏–ª–æ—Å—è: ${diffHrs} –≥–æ–¥ ${diffMins} —Ö–≤.</div>`;
                
                const nextAction = isLight ? "–í–∏–º–∫–Ω–µ–Ω–Ω—è" : "–£–≤—ñ–º–∫–Ω–µ–Ω–Ω—è";
                const nextTimeStr = `${pad(targetDate.getHours())}:${pad(targetDate.getMinutes())}`;
                nextEventHtml = `<div>${isLight ? 'üåö' : 'üåù'} ${nextAction} –æ ${nextTimeStr}</div>`;
            }
        } else {
            timeLeftHtml = "<div>–ë–µ–∑ –∑–º—ñ–Ω –¥–æ –∫—ñ–Ω—Ü—è –¥–æ–±–∏</div>";
        }

        banner.innerHTML = `
            <div class="status-emoji">${emoji} ${statusText}</div>
            <div class="status-timer">${timeLeftHtml}</div>
            <div class="status-next">${nextEventHtml}</div>
        `;
    }

    function toggleEdit() {
        document.getElementById('schedule-screen').classList.add('hidden');
        document.getElementById('setup-screen').classList.remove('hidden');
    }
    
    function showScheduleView() {
        document.getElementById('setup-screen').classList.add('hidden');
        document.getElementById('schedule-screen').classList.remove('hidden');
    }

    function pad(n) { return n < 10 ? '0'+n : n; }

</script>
</body>
</html>
