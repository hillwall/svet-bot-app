<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ì—Ä–∞—Ñ—ñ–∫ —Å–≤—ñ—Ç–ª–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: var(--tg-theme-bg-color, #212121);
            color: var(--tg-theme-text-color, #ffffff);
            font-family: sans-serif;
            padding-bottom: 80px;
        }
        .slot-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 15px;
        }
        .slot {
            border-radius: 8px;
            padding: 10px 5px;
            text-align: center;
            font-size: 12px;
            font-weight: bold;
            background-color: #2c2c2c;
            border: 1px solid #444;
        }
        .slot.on {
            background-color: #ffffff;
            color: #000;
        }
        .slot.off {
            background-color: #1a1a1a;
            color: #666;
            border-color: #333;
        }
        .slot.maybe {
            background-color: #6c757d; /* –°—ñ—Ä–∏–π */
            color: #fff;
        }
        .slot.current {
            border: 2px solid #3b88fd; /* Telegram Blue */
        }
        .btn-tg {
            background-color: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            margin-top: 20px;
        }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container py-3">
    <div id="setup-screen">
        <h5 class="mb-3">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h5>
        <div class="mb-3">
            <label class="form-label">–û–±–ª–∞—Å—Ç—å</label>
            <select id="region-select" class="form-select bg-dark text-white border-secondary">
                <option value="">–û–±–µ—Ä—ñ—Ç—å –æ–±–ª–∞—Å—Ç—å...</option>
            </select>
        </div>
        <div class="mb-3">
            <label class="form-label">–ß–µ—Ä–≥–∞</label>
            <select id="queue-select" class="form-select bg-dark text-white border-secondary" disabled>
                <option value="">–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –æ–±–ª–∞—Å—Ç—å</option>
            </select>
        </div>
        <button id="save-btn" class="btn-tg" onclick="saveSettings()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
    </div>

    <div id="schedule-screen" class="hidden">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <strong id="display-queue-name">–ß–µ—Ä–≥–∞ ...</strong>
                <div class="small text-muted" id="current-date">...</div>
            </div>
            <button class="btn btn-sm btn-outline-secondary" onclick="toggleEdit()">‚öôÔ∏è</button>
        </div>

        <div class="alert alert-dark mt-3 p-2 text-center" id="status-banner">
            –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...
        </div>

        <ul class="nav nav-pills nav-fill mt-3 small">
            <li class="nav-item">
                <a class="nav-link active" id="tab-today" href="#" onclick="switchDay(0)">–°—å–æ–≥–æ–¥–Ω—ñ</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="tab-tomorrow" href="#" onclick="switchDay(1)">–ó–∞–≤—Ç—Ä–∞</a>
            </li>
        </ul>

        <div id="grid-container" class="slot-grid">
            </div>
    </div>
</div>

<script>
    // –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–Ø
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbx0_wj63qj6n3ADHCuHpaTdz-5NmQ61ZWSFKNCjaAkvSsmbBncpiITnkqFN3salqppCAA/exec'; 
    let tg = window.Telegram.WebApp;
    tg.expand();

    let regionsData = []; // –ö–µ—à –æ–±–ª–∞—Å—Ç–µ–π
    let currentUserId = tg.initDataUnsafe?.user?.id || 'TEST_USER'; // –î–ª—è —Ç–µ—Å—Ç—ñ–≤ –≤ –±—Ä–∞—É–∑–µ—Ä—ñ

    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
    window.onload = async function() {
        // 1. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ —é–∑–µ—Ä –≤–∂–µ –º–∞—î –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
        try {
            const resp = await fetch(`${GAS_API_URL}?action=getUser&userId=${currentUserId}`);
            const user = await resp.json();
            
            // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ä–µ–≥—ñ–æ–Ω—ñ–≤ —É —Ñ–æ–Ω—ñ
            loadRegions();

            if (user.found) {
                showSchedule(user.queueUrl, user.regionName, user.queueName);
            } else {
                // –ù–æ–≤–∏–π —é–∑–µ—Ä
                document.getElementById('setup-screen').classList.remove('hidden');
            }
        } catch (e) {
            alert("–ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è: " + e);
        }
    };

    async function loadRegions() {
        const resp = await fetch(`${GAS_API_URL}?action=getTree`);
        const data = await resp.json();
        // data –º–∞—î —Å—Ç—Ä—É–∫—Ç—É—Ä—É { "–í—ñ–Ω–Ω–∏—Ü—å–∫–∞": [ {name: "1.1", url: ".."} ], ... } (—è–∫—â–æ backend —Ç–∞–∫ –≤—ñ–¥–¥–∞—î)
        // –ê–±–æ —è–∫—â–æ backend –≤—ñ–¥–¥–∞—î array —Ä—è–¥–∫—ñ–≤, —Ç—É—Ç —Ç—Ä–µ–±–∞ —Ä–æ–∑–ø–∞—Ä—Å–∏—Ç–∏.
        // *–ü—Ä–∏–ø—É—Å—Ç–∏–º–æ –¥–ª—è —Å–ø—Ä–æ—â–µ–Ω–Ω—è, —â–æ GAS buildTreeFromData –ø–æ–≤–µ—Ä—Ç–∞—î –∑—Ä—É—á–Ω–∏–π JSON –æ–±'—î–∫—Ç
        regionsData = data; 
        
        const rSelect = document.getElementById('region-select');
        Object.keys(data).forEach(rName => {
            const opt = document.createElement('option');
            opt.value = rName;
            opt.innerText = rName;
            rSelect.appendChild(opt);
        });

        rSelect.addEventListener('change', () => {
            const qSelect = document.getElementById('queue-select');
            qSelect.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å —á–µ—Ä–≥—É...</option>';
            qSelect.disabled = false;
            
            const queues = regionsData[rSelect.value];
            queues.forEach(q => {
                const opt = document.createElement('option');
                opt.value = q.url; // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ URL
                opt.innerText = q.name;
                qSelect.appendChild(opt);
            });
        });
    }

    async function saveSettings() {
        const rSelect = document.getElementById('region-select');
        const qSelect = document.getElementById('queue-select');
        
        if(!rSelect.value || !qSelect.value) {
            tg.showAlert("–ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å –≤—Å–µ.");
            return;
        }

        const rName = rSelect.options[rSelect.selectedIndex].text;
        const qName = qSelect.options[qSelect.selectedIndex].text;
        const qUrl = qSelect.value;

        // –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        tg.MainButton.showProgress();
        await fetch(`${GAS_API_URL}?action=saveUser&userId=${currentUserId}&regionName=${encodeURIComponent(rName)}&queueName=${encodeURIComponent(qName)}&queueUrl=${encodeURIComponent(qUrl)}`);
        tg.MainButton.hideProgress();

        showSchedule(qUrl, rName, qName);
    }

    let activeQueueUrl = '';

    function showSchedule(url, rName, qName) {
        activeQueueUrl = url;
        document.getElementById('setup-screen').classList.add('hidden');
        document.getElementById('schedule-screen').classList.remove('hidden');
        document.getElementById('display-queue-name').innerText = `${rName}, ${qName}`;
        
        switchDay(0); // –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å—å–æ–≥–æ–¥–Ω—ñ
    }

    async function switchDay(dayOffset) {
        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è UI –≤–∫–ª–∞–¥–æ–∫
        document.getElementById('tab-today').classList.toggle('active', dayOffset === 0);
        document.getElementById('tab-tomorrow').classList.toggle('active', dayOffset === 1);
        
        const container = document.getElementById('grid-container');
        container.innerHTML = '<div class="col-span-4 text-center">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';

        // –§–æ—Ä–º—É–≤–∞–Ω–Ω—è –¥–∞—Ç–∏
        const date = new Date();
        date.setDate(date.getDate() + dayOffset);
        const dateStr = date.toISOString().split('T')[0];
        document.getElementById('current-date').innerText = dateStr;

        // –ó–∞–ø–∏—Ç
        const resp = await fetch(`${GAS_API_URL}?action=getSchedule&queueUrl=${encodeURIComponent(activeQueueUrl)}&date=${dateStr}`);
        const data = await resp.json();
        
        renderGrid(data.schedule);
    }

    function renderGrid(scheduleArray) {
        const container = document.getElementById('grid-container');
        container.innerHTML = '';

        if (!scheduleArray || scheduleArray.length === 0) {
            container.innerHTML = '–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –Ω–∞ —Ü—é –¥–∞—Ç—É';
            return;
        }

        const now = new Date();
        const currentSlotIndex = now.getHours() * 2 + (now.getMinutes() >= 30 ? 1 : 0);
        const isToday = document.getElementById('tab-today').classList.contains('active');

        scheduleArray.forEach((status, index) => {
            const div = document.createElement('div');
            // –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ —á–∞—Å—É: 0 -> 00-01 (–ø–æ–º–∏–ª–∫–∞ –≤ –ª–æ–≥—ñ—Ü—ñ –º–∞—Å–∏–≤—É 48), 
            // –í–∏ —Ö–æ—á–µ—Ç–µ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—Ç–∏ –ø–æ –≥–æ–¥–∏–Ω–∞–º (24 –∫–ª—ñ—Ç–∏–Ω–∫–∏) —á–∏ –ø–æ 30 —Ö–≤ (48 –∫–ª—ñ—Ç–∏–Ω–æ–∫)?
            // –ù–∞ –º–∞–∫–µ—Ç—ñ 24 –∫–ª—ñ—Ç–∏–Ω–∫–∏. 
            // –¢–æ–º—É –±–µ—Ä–µ–º–æ –∫–æ–∂–Ω—ñ 2 –µ–ª–µ–º–µ–Ω—Ç–∏ –º–∞—Å–∏–≤—É.
            
            // –ê–ª–µ –∫–æ–¥ GAS –ø–æ–≤–µ—Ä—Ç–∞—î 48 –∑–Ω–∞—á–µ–Ω—å. –¢—Ä–µ–±–∞ –∑–≥—Ä—É–ø—É–≤–∞—Ç–∏.
            // –°–ø—Ä–æ—â–µ–Ω–Ω—è: –≤–∏–≤–æ–¥–∏–º–æ 24 –±–ª–æ–∫–∏, —è–∫—â–æ –≤ –æ–±–æ—Ö –ø–æ–ª–æ–≤–∏–Ω–∞—Ö –≥–æ–¥–∏–Ω–∏ —Å–≤—ñ—Ç–ª–æ —î - —Ç–æ –±—ñ–ª–∏–π.
            // –Ø–∫—â–æ —Ö–æ—á –≤ –æ–¥–Ω—ñ–π –ø–æ–ª–æ–≤–∏–Ω—ñ –Ω–µ–º–∞—î - —Ç–æ —á–æ—Ä–Ω–∏–π (–∞–±–æ –∫–æ–º–±—ñ–Ω–æ–≤–∞–Ω–∏–π).
            
            // –î–õ–Ø –¢–û–ß–ù–û–°–¢–Ü: –í–∏–≤–æ–¥–∏–º–æ 24 –≥–æ–¥–∏–Ω–∏, –∞–ª–µ –∫–æ–ª—ñ—Ä –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –≥—ñ—Ä—à–æ–≥–æ —Å—Ç–∞–Ω—É.
            
            /* –¢—É—Ç –ª–æ–≥—ñ–∫–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è. –Ø–∫—â–æ —Ç—Ä–µ–±–∞ —è–∫ –Ω–∞ —Å–∫—Ä—ñ–Ω—ñ (00-01, 01-02), —Ü–µ 24 –±–ª–æ–∫–∏ */
            /* –Ø –∑—Ä–æ–±–ª—é –∞–¥–∞–ø—Ç–∞—Ü—ñ—é –º–∞—Å–∏–≤—É 48 -> 24 –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è */
        });
        
        // --- –¢–ò–ú–ß–ê–°–û–í–ê –†–ï–ê–õ–Ü–ó–ê–¶–Ü–Ø –î–õ–Ø 48 –°–õ–û–¢–Ü–í (–¢–û–ß–ù–Ü–®–ï) ---
        // –Ø–∫—â–æ —Ö–æ—á–µ—à —Å—É–≤–æ—Ä–æ —è–∫ –Ω–∞ —Å–∫—Ä—ñ–Ω—ñ (24 –±–ª–æ–∫–∏), —Ç—Ä–µ–±–∞ –æ–±'—î–¥–Ω—É–≤–∞—Ç–∏ [0] —ñ [1].
        
        for (let h = 0; h < 24; h++) {
            const val1 = scheduleArray[h*2];
            const val2 = scheduleArray[h*2+1];
            
            const div = document.createElement('div');
            div.className = 'slot';
            div.innerText = `${h.toString().padStart(2,'0')}-${(h+1).toString().padStart(2,'0')}`;
            
            // –í–∏–∑–Ω–∞—á–∞—î–º–æ –∫–ª–∞—Å
            if (val1 === 0 || val2 === 0) div.classList.add('off');
            else if (val1 === 2 || val2 === 2) div.classList.add('maybe');
            else div.classList.add('on');
            
            // –ü—ñ–¥—Å–≤—ñ—Ç–∫–∞ –ø–æ—Ç–æ—á–Ω–æ–≥–æ
            if (isToday && h === now.getHours()) {
                div.classList.add('current');
                // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –∑–≤–µ—Ä—Ö—É
                const statusText = (val1===1 && val2===1) ? "–°–≤—ñ—Ç–ª–æ –Ñ üåù" : "–°–≤—ñ—Ç–ª–∞ –ù–ï–ú–ê–Ñ üåö";
                document.getElementById('status-banner').innerText = statusText;
            }
            
            container.appendChild(div);
        }
    }

    function toggleEdit() {
        document.getElementById('schedule-screen').classList.add('hidden');
        document.getElementById('setup-screen').classList.remove('hidden');
    }
</script>

</body>
</html>
