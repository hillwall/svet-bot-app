<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>–°–≤—ñ—Ç–ª–æ –ë–æ—Ç</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* --- –°–¢–ò–õ–Ü –ó –í–Ü–ù–ù–ò–¶–¨–ö–û–ì–û –§–ê–ô–õ–£ --- */
    :root {
      --bg: var(--tg-theme-bg-color, #f0f2f5);
      --card: var(--tg-theme-secondary-bg-color, #ffffff);
      --text: var(--tg-theme-text-color, #222);
      --hint: var(--tg-theme-hint-color, #777);
      --accent: #2481cc;
      
      /* –ü–∞–ª—ñ—Ç—Ä–∞ –í—ñ–Ω–Ω–∏—Ü—ñ */
      --color-light: #e6e6a1; /* –ñ–æ–≤—Ç–∏–π (—Å–≤—ñ—Ç–ª–æ —î) */
      --color-dark: #00193a;  /* –¢–µ–º–Ω–æ-—Å–∏–Ω—ñ–π (—Å–≤—ñ—Ç–ª–∞ –Ω–µ–º–∞—î) */
      --color-border-light: #d1d18b;
      --white: #ffffff;
      --red: #ff3b30;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background-color: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 12px;
      display: flex; flex-direction: column; min-height: 100vh;
      box-sizing: border-box;
    }

    .hidden { display: none !important; }

    /* –ó–ê–ì–û–õ–û–í–û–ö */
    .header-row {
      display: flex; justify-content: space-between; align-items: flex-start;
      margin-bottom: 16px; padding: 0 4px;
    }
    .title-group h1 {
      margin: 0; font-size: 22px; font-weight: 700;
      line-height: 1.2;
    }
    .title-group p {
      margin: 4px 0 0 0; font-size: 14px; color: var(--hint);
    }
    
    /* –°–¢–ê–¢–£–° (–ë–ï–ô–î–ñ) */
    .status-badge {
      font-size: 13px; font-weight: 600;
      padding: 6px 12px; border-radius: 20px;
      background-color: var(--color-light); color: #333;
      white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .status-badge.off {
      background-color: var(--color-dark); color: var(--white);
    }

    /* –í–Ü–ö–õ–ê–î–ö–ò (–°—å–æ–≥–æ–¥–Ω—ñ/–ó–∞–≤—Ç—Ä–∞) */
    .tabs {
      display: flex; background: rgba(118, 118, 128, 0.12);
      border-radius: 9px; padding: 2px; margin-bottom: 20px;
    }
    .tab {
      flex: 1; text-align: center; padding: 8px;
      font-size: 14px; font-weight: 500; cursor: pointer;
      border-radius: 7px; color: var(--text);
      transition: all 0.2s ease;
    }
    .tab.active {
      background: var(--card);
      box-shadow: 0 3px 8px rgba(0,0,0,0.12);
      font-weight: 600;
    }

    /* –°–Ü–¢–ö–ê –ì–†–ê–§–Ü–ö–ê */
    .schedule-card {
      background: var(--card);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 20px;
    }

    .grid {
      display: flex; flex-wrap: wrap;
      border-radius: 8px; overflow: hidden;
      border: 1px solid rgba(0,0,0,0.1);
    }

    .hour {
      width: 25%; /* 4 —Å—Ç–æ–≤–ø—á–∏–∫–∏ –º–æ–±—ñ–ª—å–Ω–∏–π */
      height: 44px;
      background-color: var(--color-light);
      border: 0.5px solid var(--color-border-light);
      box-sizing: border-box;
      display: flex; align-items: center; justify-content: center;
      font-size: 13px; font-weight: 500; color: #333;
      position: relative;
    }
    
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å —Å—ñ—Ç–∫–∏ */
    @media (min-width: 360px) { .hour { width: 20%; } } /* 5 —Å—Ç–æ–≤–ø—á–∏–∫—ñ–≤ */
    @media (min-width: 420px) { .hour { width: 16.66%; } } /* 6 —Å—Ç–æ–≤–ø—á–∏–∫—ñ–≤ */

    /* –°—Ç–∏–ª—ñ –¥–ª—è –≤–∏–º–∫–Ω–µ–Ω—å */
    .hour.off-full {
      background-color: var(--color-dark);
      color: var(--white);
      border-color: #002555;
    }

    /* –ü–æ—Ç–æ—á–Ω–∞ –≥–æ–¥–∏–Ω–∞ */
    .hour.current {
      border: 2px solid var(--red) !important;
      z-index: 10;
    }
    /* –ú–∞–ª–µ–Ω—å–∫–∞ –º—ñ—Ç–∫–∞ "–ó–∞—Ä–∞–∑" (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ) */
    .hour.current::after {
      content: '';
      position: absolute; top: 2px; right: 2px;
      width: 6px; height: 6px; background: var(--red);
      border-radius: 50%;
    }

    /* –ö–ù–û–ü–ö–ò –¢–ê –§–û–†–ú–ò */
    select {
      width: 100%; padding: 14px; margin-bottom: 12px;
      border: 1px solid #ccc; border-radius: 12px;
      background: var(--card); color: var(--text);
      font-size: 16px; -webkit-appearance: none;
    }
    
    .btn-main {
      width: 100%; padding: 16px; border: none; border-radius: 14px;
      background: var(--accent); color: white;
      font-size: 16px; font-weight: 600; cursor: pointer;
      transition: opacity 0.2s;
    }
    .btn-main:active { opacity: 0.8; }

    .btn-text {
      background: none; border: none; width: 100%;
      padding: 12px; color: var(--hint);
      font-size: 15px; cursor: pointer;
    }

    .loader { margin-top: 40px; text-align: center; color: var(--hint); }
    
    /* –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø–æ–º–∏–ª–∫—É */
    #error-msg {
        text-align: center; color: var(--red); font-size: 14px; margin-top: 10px;
    }
  </style>
</head>
<body>

  <div id="loader" class="loader">
    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
    </svg>
    <p>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö...</p>
  </div>

  <div id="setup-screen" class="hidden" style="text-align:center; padding-top:20px;">
    <h2 style="margin-bottom:10px;">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h2>
    <p style="margin-bottom:20px; color:var(--hint)">–û–±–µ—Ä—ñ—Ç—å –≤–∞—à—É –æ–±–ª–∞—Å—Ç—å —Ç–∞ —á–µ—Ä–≥—É</p>
    
    <select id="region-select" onchange="loadQueues()">
      <option value="">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –æ–±–ª–∞—Å—Ç–µ–π...</option>
    </select>
    
    <div id="queue-block" class="hidden">
      <select id="queue-select">
        <option value="">–û–±–µ—Ä—ñ—Ç—å —á–µ—Ä–≥—É</option>
      </select>
      <button class="btn-main" onclick="saveConfig()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
    </div>
  </div>

  <div id="view-screen" class="hidden">
    
    <div class="header-row">
      <div class="title-group">
        <h1 id="view-queue">–ß–µ—Ä–≥–∞ ...</h1>
        <p id="view-region">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>
      </div>
      <div id="status-badge" class="status-badge">...</div>
    </div>

    <div class="tabs">
      <div id="tab-0" class="tab active" onclick="loadSchedule(0)">–°—å–æ–≥–æ–¥–Ω—ñ</div>
      <div id="tab-1" class="tab" onclick="loadSchedule(1)">–ó–∞–≤—Ç—Ä–∞</div>
    </div>

    <div class="schedule-card">
      <div id="schedule-grid" class="grid">
        </div>
      <div id="error-msg"></div>
    </div>

    <button class="btn-text" onclick="showSetup()">
      ‚öôÔ∏è –ó–º—ñ–Ω–∏—Ç–∏ —á–µ—Ä–≥—É
    </button>
  </div>

<script>
  const tg = window.Telegram.WebApp;
  tg.expand();
  // –î–ª—è —Ç–µ—Å—Ç—ñ–≤ —É –±—Ä–∞—É–∑–µ—Ä—ñ (—è–∫—â–æ –≤—ñ–¥–∫—Ä–∏–≤–∞—Ç–∏ –Ω–µ —á–µ—Ä–µ–∑ –¢–ì)
  const userId = tg.initDataUnsafe?.user?.id || "TEST_USER_ID";

  // üëáüëáüëá –¢–£–¢ –í–°–¢–ê–í –°–í–Ü–ô WEB APP URL üëáüëáüëá
  const API_URL = "https://script.google.com/macros/s/AKfycbx0_wj63qj6n3ADHCuHpaTdz-5NmQ61ZWSFKNCjaAkvSsmbBncpiITnkqFN3salqppCAA/exec";

  // --- API ---
  async function callApi(action, params = {}) {
    const url = new URL(API_URL);
    url.searchParams.append('action', action);
    for (const k in params) url.searchParams.append(k, params[k]);
    try {
      const res = await fetch(url);
      return await res.json();
    } catch (e) {
      console.error(e);
      return { error: "–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ" };
    }
  }

  // --- INIT ---
  window.onload = async () => {
    // 1. –°–ø—Ä–æ–±—É—î–º–æ –æ—Ç—Ä–∏–º–∞—Ç–∏ –≥—Ä–∞—Ñ—ñ–∫.
    // –Ø–∫—â–æ —é–∑–µ—Ä–∞ –Ω–µ–º–∞—î –≤ –±–∞–∑—ñ -> —Å–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä–Ω–µ error: "UserNotFound"
    const data = await callApi('getUserSchedule', { chatId: userId });
    document.getElementById('loader').classList.add('hidden');

    if (data && data.error === "UserNotFound") {
      showSetup();
    } else if (data && !data.error) {
      showView(data);
    } else {
      // –Ø–∫–∞—Å—å —ñ–Ω—à–∞ –ø–æ–º–∏–ª–∫–∞
      document.body.innerHTML = `<h3 style="text-align:center;margin-top:50px;">–ü–æ–º–∏–ª–∫–∞: ${data?.error || "–ù–µ–≤—ñ–¥–æ–º–∞"}</h3>`;
    }
  };

  // --- SETUP ---
  async function showSetup() {
    document.getElementById('view-screen').classList.add('hidden');
    document.getElementById('setup-screen').classList.remove('hidden');
    
    // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –æ–±–ª–∞—Å—Ç—ñ
    const regions = await callApi('getRegions');
    const rSel = document.getElementById('region-select');
    rSel.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å –æ–±–ª–∞—Å—Ç—å</option>';
    if (regions && regions.length) {
      regions.forEach(r => {
        const opt = document.createElement('option');
        opt.value = r.url;
        opt.text = r.name;
        rSel.appendChild(opt);
      });
    }
  }

  async function loadQueues() {
    const url = document.getElementById('region-select').value;
    if (!url) return;
    
    const qs = await callApi('getChildren', { url: url });
    const qSel = document.getElementById('queue-select');
    qSel.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å —á–µ—Ä–≥—É</option>';
    if (qs && qs.length) {
      qs.forEach(q => {
        const opt = document.createElement('option');
        opt.value = q.url;
        opt.text = q.name;
        qSel.appendChild(opt);
      });
      document.getElementById('queue-block').classList.remove('hidden');
    }
  }

  async function saveConfig() {
    const rSel = document.getElementById('region-select');
    const qSel = document.getElementById('queue-select');
    
    if (!qSel.value) return alert("–ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å —á–µ—Ä–≥—É!");
    
    document.getElementById('loader').classList.remove('hidden');
    document.getElementById('setup-screen').classList.add('hidden');
    
    // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –Ω–∞–∑–≤—É –æ–±–ª–∞—Å—Ç—ñ –æ–∫—Ä–µ–º–æ, —è–∫—â–æ —Ç—Ä–µ–±–∞ –±—É–¥–µ –∑–±–µ—Ä–µ–≥—Ç–∏ (–ø–æ–∫–∏ —Å–∫—Ä–∏–ø—Ç –∑–±–µ—Ä—ñ–≥–∞—î —Ç—ñ–ª—å–∫–∏ URL —á–µ—Ä–≥–∏)
    await callApi('saveSelection', {
      chatId: userId,
      url: qSel.value,
      name: qSel.options[qSel.selectedIndex].text,
      // –ú–æ–∂–Ω–∞ –ø–µ—Ä–µ–¥–∞—Ç–∏ –Ω–∞–∑–≤—É –æ–±–ª–∞—Å—Ç—ñ, —è–∫—â–æ –¥–æ–ø–∏–ª—è—Ç–∏ –±–µ–∫–µ–Ω–¥, –∞–ª–µ –ø–æ–∫–∏ —Ç–∞–∫
    });
    
    location.reload();
  }

  // --- VIEW ---
  function showView(data) {
    document.getElementById('setup-screen').classList.add('hidden');
    document.getElementById('view-screen').classList.remove('hidden');
    
    // –ó–∞–ø–æ–≤–Ω—é—î–º–æ —à–∞–ø–∫—É
    document.getElementById('view-queue').innerText = data.queueName || "–ß–µ—Ä–≥–∞";
    // –Ø–∫—â–æ –±–µ–∫–µ–Ω–¥ –Ω–µ –ø–æ–≤–µ—Ä—Ç–∞—î –Ω–∞–∑–≤—É –æ–±–ª–∞—Å—Ç—ñ, –ø–æ–∫–∏ –ø–∏—à–µ–º–æ –¥–µ—Ñ–æ–ª—Ç–Ω—É. 
    // (–ê–ª–µ —è–∫—â–æ —Ç–∏ –¥–æ–¥–∞–≤ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –Ω–∞–∑–≤–∏ –æ–±–ª–∞—Å—Ç—ñ –≤ –±–∞–∑—É, –≤–æ–Ω–∞ –ø—Ä–∏–π–¥–µ —Å—é–¥–∏)
    document.getElementById('view-region').innerText = data.region || "–í–∞—à–∞ –æ–±–ª–∞—Å—Ç—å";

    renderGrid(data.schedule);
  }

  async function loadSchedule(offset) {
    // –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è —Ç–∞–±—ñ–≤
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById('tab-' + offset).classList.add('active');
    
    const grid = document.getElementById('schedule-grid');
    grid.innerHTML = '<div style="width:100%;text-align:center;padding:20px;color:gray;">–û–Ω–æ–≤–ª–µ–Ω–Ω—è...</div>';
    
    const res = await callApi('getUserSchedule', { chatId: userId, dateOffset: offset });
    
    if (res.schedule && res.schedule.error) {
       grid.innerHTML = '';
       document.getElementById('error-msg').innerText = res.schedule.error;
    } else {
       renderGrid(res.schedule);
    }
  }

  function renderGrid(schedule) {
    const grid = document.getElementById('schedule-grid');
    grid.innerHTML = "";
    document.getElementById('error-msg').innerText = "";

    if (!schedule || !schedule.slots) return;

    const now = new Date();
    const currentHour = now.getHours();
    
    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –¥–∏–≤–∏–º–æ—Å—å –º–∏ "–°—å–æ–≥–æ–¥–Ω—ñ" (–∞–∫—Ç–∏–≤–Ω–∏–π —Ç–∞–± 0)
    const isTodayTab = document.getElementById('tab-0').classList.contains('active');
    
    let isLightOffNow = false;

    for (let i = 0; i < 24; i++) {
      const slot = schedule.slots.find(s => s.hour === i);
      const isOff = slot && slot.status === 'off';
      
      const div = document.createElement('div');
      // –ö–ª–∞—Å–∏
      if (isOff) {
        div.className = 'hour off-full';
      } else {
        div.className = 'hour';
      }

      // –ü—ñ–¥—Å–≤—ñ—Ç–∫–∞ –ø–æ—Ç–æ—á–Ω–æ—ó –≥–æ–¥–∏–Ω–∏
      if (isTodayTab && i === currentHour) {
        div.classList.add('current');
        if (isOff) isLightOffNow = true;
      }

      // –¢–µ–∫—Å—Ç 00-01
      div.innerText = `${String(i).padStart(2,'0')}-${String(i+1).padStart(2,'0')}`;
      
      grid.appendChild(div);
    }

    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –≤ —à–∞–ø—Ü—ñ
    const badge = document.getElementById('status-badge');
    if (isTodayTab) {
        if (isLightOffNow) {
            badge.innerText = "–°–≤—ñ—Ç–ª–∞ –Ω–µ–º–∞—î";
            badge.className = "status-badge off";
        } else {
            badge.innerText = "–°–≤—ñ—Ç–ª–æ —î";
            badge.className = "status-badge";
        }
    } else {
        badge.innerText = "–ó–∞–≤—Ç—Ä–∞";
        badge.className = "status-badge";
    }
  }
</script>
</body>
</html>
