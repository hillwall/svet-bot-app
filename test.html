<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); }
        select { width: 100%; padding: 10px; margin: 10px 0; border-radius: 8px; }
        .btn { background: #2481cc; color: white; border: none; padding: 15px; width: 100%; border-radius: 8px; cursor: pointer; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div id="setup">
        <h3>üìç –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ª–æ–∫–∞—Ü—ñ—ó</h3>
        
        <label>1. –û–±–ª–∞—Å—Ç—å:</label>
        <select id="region" onchange="loadNextLevel('region', 'city')">
            <option>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –æ–±–ª–∞—Å—Ç–µ–π...</option>
        </select>

        <div id="city-container" class="hidden">
            <label>2. –ú—ñ—Å—Ç–æ/–†–∞–π–æ–Ω:</label>
            <select id="city" onchange="loadNextLevel('city', 'queue')">
                <option value="">–û–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ç–æ</option>
            </select>
        </div>

        <div id="queue-container" class="hidden">
            <label>3. –ß–µ—Ä–≥–∞/–í—É–ª–∏—Ü—è:</label>
            <select id="queue">
                <option value="">–û–±–µ—Ä—ñ—Ç—å —á–µ—Ä–≥—É</option>
            </select>
        </div>

        <button class="btn" onclick="save()">–ó–±–µ—Ä–µ–≥—Ç–∏ –≤–∏–±—ñ—Ä</button>
    </div>

    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbx0_wj63qj6n3ADHCuHpaTdz-5NmQ61ZWSFKNCjaAkvSsmbBncpiITnkqFN3salqppCAA/exec";
        let tg = window.Telegram.WebApp;

        // 1. –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –æ–±–ª–∞—Å—Ç–µ–π –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ
        async function init() {
            const res = await fetch(`${WEB_APP_URL}?action=getRegions`);
            const data = await res.json();
            const sel = document.getElementById('region');
            sel.innerHTML = '<option value="">-- –û–±–µ—Ä—ñ—Ç—å –æ–±–ª–∞—Å—Ç—å --</option>';
            data.forEach(r => sel.innerHTML += `<option value="${r.url}">${r.name}</option>`);
        }

        // 2. –î–∏–Ω–∞–º—ñ—á–Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞—Å—Ç—É–ø–Ω–∏—Ö —Ä—ñ–≤–Ω—ñ–≤ (–º—ñ—Å—Ç–æ -> —á–µ—Ä–≥–∞)
        async function loadNextLevel(currentId, nextId) {
            const url = document.getElementById(currentId).value;
            if (!url) return;

            const res = await fetch(`${WEB_APP_URL}?action=getChildren&url=${url}`);
            const data = await res.json();

            if (data.length > 0) {
                document.getElementById(`${nextId}-container`).classList.remove('hidden');
                const sel = document.getElementById(nextId);
                sel.innerHTML = `<option value="">-- –û–±–µ—Ä—ñ—Ç—å –∑—ñ —Å–ø–∏—Å–∫—É --</option>`;
                data.forEach(item => sel.innerHTML += `<option value="${item.url}">${item.name}</option>`);
            }
        }

        // 3. –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ñ—ñ–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
        async function save() {
            const q = document.getElementById('queue').value || document.getElementById('city').value || document.getElementById('region').value;
            const name = document.getElementById('queue').selectedOptions[0]?.text || "–õ–æ–∫–∞—Ü—ñ—è";
            const chatId = tg.initDataUnsafe.user?.id || "197183975";

            await fetch(`${WEB_APP_URL}?action=saveSelection&chatId=${chatId}&url=${encodeURIComponent(q)}&name=${encodeURIComponent(name)}`);
            tg.close();
        }

        init();
    </script>
</body>
</html>
