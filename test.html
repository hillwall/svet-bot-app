<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≥—Ä–∞—Ñ—ñ–∫–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: var(--tg-theme-bg-color, #ffffff);
            --text: var(--tg-theme-text-color, #222222);
            --hint: var(--tg-theme-hint-color, #999999);
            --btn-bg: var(--tg-theme-button-color, #2481cc);
            --btn-text: var(--tg-theme-button-text-color, #ffffff);
            --secondary: var(--tg-theme-secondary-bg-color, #f0f2f5);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        h3 { margin-top: 0; font-size: 18px; }

        .form-group { margin-bottom: 20px; }
        
        label { 
            display: block; 
            margin-bottom: 8px; 
            font-size: 14px; 
            color: var(--hint); 
            font-weight: 500;
        }

        select {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #ccc;
            background-color: var(--secondary);
            color: var(--text);
            font-size: 16px;
            appearance: none;
            outline: none;
        }

        select:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn {
            background-color: var(--btn-bg);
            color: var(--btn-text);
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
            transition: opacity 0.2s;
        }

        .btn:disabled { opacity: 0.6; }

        .loader {
            font-size: 12px;
            color: var(--btn-bg);
            margin-top: 6px;
            display: none;
        }

        /* –°—Ç–∏–ª—ñ–∑–∞—Ü—ñ—è –¥–ª—è –≤–∏–ø–∞–¥–∞—é—á–æ–≥–æ —Å–ø–∏—Å–∫—É (—Å—Ç—Ä—ñ–ª–æ—á–∫–∞) */
        .select-wrapper { position: relative; }
        .select-wrapper::after {
            content: "‚ñº";
            font-size: 12px;
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            opacity: 0.5;
        }
    </style>
</head>
<body>

    <div id="app">
        <h3>üìç –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ª–æ–∫–∞—Ü—ñ—ó</h3>

        <div class="form-group">
            <label>1. –û–±–ª–∞—Å—Ç—å:</label>
            <div class="select-wrapper">
                <select id="region" onchange="onRegionChange()">
                    <option value="">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <label>2. –ú—ñ—Å—Ç–æ / –†–∞–π–æ–Ω:</label>
            <div class="select-wrapper">
                <select id="city" disabled onchange="onCityChange()">
                    <option value="">–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –æ–±–ª–∞—Å—Ç—å</option>
                </select>
            </div>
            <div id="city-loader" class="loader">–®—É–∫–∞—î–º–æ –º—ñ—Å—Ç–∞...</div>
        </div>

        <div class="form-group">
            <label>3. –ß–µ—Ä–≥–∞ / –í—É–ª–∏—Ü—è:</label>
            <div class="select-wrapper">
                <select id="queue" disabled onchange="onQueueChange()">
                    <option value="">–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ç–æ</option>
                </select>
            </div>
            <div id="queue-loader" class="loader">–®—É–∫–∞—î–º–æ —á–µ—Ä–≥–∏...</div>
        </div>

        <button id="save-btn" class="btn" disabled onclick="save()">–ó–±–µ—Ä–µ–≥—Ç–∏ –≤–∏–±—ñ—Ä</button>
    </div>

    <script>
        // –¢–ï–°–¢–û–í–ò–ô URL (–ê–Ω–¥—Ä—ñ—é, –ø–µ—Ä–µ–≤—ñ—Ä —á–∏ –≤—ñ–Ω –∞–∫—Ç—É–∞–ª—å–Ω–∏–π –¥–ª—è —Ç–≤–æ–≥–æ GAS)
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbx0_wj63qj6n3ADHCuHpaTdz-5NmQ61ZWSFKNCjaAkvSsmbBncpiITnkqFN3salqppCAA/exec";
        
        let tg = window.Telegram.WebApp;
        tg.expand(); // –†–æ–∑–≥–æ—Ä–Ω—É—Ç–∏ –Ω–∞ –≤–µ—Å—å –µ–∫—Ä–∞–Ω

        // 1. –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –æ–±–ª–∞—Å—Ç–µ–π
        async function init() {
            try {
                const res = await fetch(`${WEB_APP_URL}?action=getRegions`);
                const regions = await res.json();
                const sel = document.getElementById('region');
                sel.innerHTML = '<option value="">-- –û–±–µ—Ä—ñ—Ç—å –æ–±–ª–∞—Å—Ç—å --</option>';
                regions.forEach(r => {
                    sel.innerHTML += `<option value="${r.url}">${r.name}</option>`;
                });
            } catch (e) {
                alert("–ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è –∑—ñ —Å–∫—Ä–∏–ø—Ç–æ–º.");
            }
        }

        // 2. –ö–æ–ª–∏ –∑–º—ñ–Ω–∏–ª–∏ –æ–±–ª–∞—Å—Ç—å
        async function onRegionChange() {
            const url = document.getElementById('region').value;
            const citySel = document.getElementById('city');
            const queueSel = document.getElementById('queue');
            const saveBtn = document.getElementById('save-btn');

            // –°–∫–∏–¥–∞–Ω–Ω—è
            citySel.innerHTML = '<option value="">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</option>';
            citySel.disabled = true;
            queueSel.innerHTML = '<option value="">–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ç–æ</option>';
            queueSel.disabled = true;
            saveBtn.disabled = !url;

            if (!url) return;

            document.getElementById('city-loader').style.display = 'block';
            
            try {
                const res = await fetch(`${WEB_APP_URL}?action=getChildren&url=${encodeURIComponent(url)}`);
                const data = await res.json();

                // –§—ñ–ª—å—Ç—Ä—É—î–º–æ: –¢—ñ–ª—å–∫–∏ –ú–Ü–°–¢–ê (isQueue: false)
                const cities = data.filter(item => !item.isQueue);
                // –§—ñ–ª—å—Ç—Ä—É—î–º–æ: –¢—ñ–ª—å–∫–∏ –ß–ï–†–ì–ò (isQueue: true)
                const queues = data.filter(item => item.isQueue);

                if (cities.length > 0) {
                    citySel.innerHTML = '<option value="">-- –û–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ç–æ --</option>';
                    cities.forEach(c => citySel.innerHTML += `<option value="${c.url}">${c.name}</option>`);
                    citySel.disabled = false;
                    
                    // –Ø–∫—â–æ –≤ —Ü—ñ–π –æ–±–ª–∞—Å—Ç—ñ —î —ñ —á–µ—Ä–≥–∏ –ø—Ä—è–º–æ –≤ –∫–æ—Ä–µ–Ω—ñ (—è–∫ –≤–∞—Ä—ñ–∞–Ω—Ç)
                    if (queues.length > 0) {
                        queueSel.innerHTML = '<option value="">-- –û–±–µ—Ä—ñ—Ç—å —á–µ—Ä–≥—É --</option>';
                        queues.forEach(q => queueSel.innerHTML += `<option value="${q.url}">${q.name}</option>`);
                        queueSel.disabled = false;
                    }
                } else if (queues.length > 0) {
                    // –Ø–∫—â–æ –º—ñ—Å—Ç –Ω–µ–º–∞—î, –∞ —á–µ—Ä–≥–∏ —î ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ –∫—Ä–æ–∫ 2
                    citySel.innerHTML = '<option value="">–ú—ñ—Å—Ç–∞ –≤—ñ–¥—Å—É—Ç–Ω—ñ</option>';
                    queueSel.innerHTML = '<option value="">-- –û–±–µ—Ä—ñ—Ç—å —á–µ—Ä–≥—É --</option>';
                    queues.forEach(q => queueSel.innerHTML += `<option value="${q.url}">${q.name}</option>`);
                    queueSel.disabled = false;
                } else {
                    citySel.innerHTML = '<option value="">–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</option>';
                }
            } catch (e) {
                alert("–ü–æ–º–∏–ª–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥—É –º—ñ—Å—Ç.");
            } finally {
                document.getElementById('city-loader').style.display = 'none';
            }
        }

        // 3. –ö–æ–ª–∏ –∑–º—ñ–Ω–∏–ª–∏ –º—ñ—Å—Ç–æ
        async function onCityChange() {
            const url = document.getElementById('city').value;
            const queueSel = document.getElementById('queue');

            queueSel.innerHTML = '<option value="">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</option>';
            queueSel.disabled = true;

            if (!url) return;

            document.getElementById('queue-loader').style.display = 'block';
            
            try {
                const res = await fetch(`${WEB_APP_URL}?action=getChildren&url=${encodeURIComponent(url)}`);
                const data = await res.json();

                // –¢—É—Ç –±–µ—Ä–µ–º–æ –≤—Å–µ, —â–æ –ø–æ–≤–µ—Ä–Ω—É–≤ —Å–∞–π—Ç –¥–ª—è –º—ñ—Å—Ç–∞ (–∑–∞–∑–≤–∏—á–∞–π —Ü–µ –≤–∂–µ —á–µ—Ä–≥–∏ –∞–±–æ –≤—É–ª–∏—Ü—ñ)
                if (data.length > 0) {
                    queueSel.innerHTML = '<option value="">-- –û–±–µ—Ä—ñ—Ç—å —á–µ—Ä–≥—É/–≤—É–ª–∏—Ü—é --</option>';
                    data.forEach(q => queueSel.innerHTML += `<option value="${q.url}">${q.name}</option>`);
                    queueSel.disabled = false;
                } else {
                    queueSel.innerHTML = '<option value="">–ß–µ—Ä–≥ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</option>';
                }
            } catch (e) {
                alert("–ü–æ–º–∏–ª–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥—É —á–µ—Ä–≥.");
            } finally {
                document.getElementById('queue-loader').style.display = 'none';
            }
        }

        function onQueueChange() {
            // –ú–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –¥–æ–¥–∞—Ç–∫–æ–≤—É –ª–æ–≥—ñ–∫—É –ø—Ä–∏ –≤–∏–±–æ—Ä—ñ —á–µ—Ä–≥–∏
        }

        // 4. –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤–∏–±–æ—Ä—É
        async function save() {
            const region = document.getElementById('region');
            const city = document.getElementById('city');
            const queue = document.getElementById('queue');
            
            // –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç –≤–∏–±–æ—Ä—É: –ß–µ—Ä–≥–∞ -> –ú—ñ—Å—Ç–æ -> –û–±–ª–∞—Å—Ç—å
            const finalUrl = queue.value || city.value || region.value;
            const finalName = queue.selectedOptions[0]?.text || city.selectedOptions[0]?.text || region.selectedOptions[0]?.text;

            const chatId = tg.initDataUnsafe.user?.id || "197183975";
            const btn = document.getElementById('save-btn');
            
            btn.disabled = true;
            btn.innerText = "–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...";

            try {
                const saveUrl = `${WEB_APP_URL}?action=saveSelection&chatId=${chatId}&url=${encodeURIComponent(finalUrl)}&name=${encodeURIComponent(finalName)}`;
                const response = await fetch(saveUrl);
                if (response.ok) {
                    tg.close();
                } else {
                    alert("–°–µ—Ä–≤–µ—Ä –Ω–µ –∑–º—ñ–≥ –∑–±–µ—Ä–µ–≥—Ç–∏ –¥–∞–Ω—ñ.");
                    btn.disabled = false;
                    btn.innerText = "–ó–±–µ—Ä–µ–≥—Ç–∏ –≤–∏–±—ñ—Ä";
                }
            } catch (e) {
                alert("–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ.");
                btn.disabled = false;
                btn.innerText = "–ó–±–µ—Ä–µ–≥—Ç–∏ –≤–∏–±—ñ—Ä";
            }
        }

        // –°—Ç–∞—Ä—Ç
        init();
    </script>
</body>
</html>
