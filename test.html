<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>–°–≤—ñ—Ç–ª–æ –ë–æ—Ç</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* --- –í–Ü–ù–ù–ò–¶–¨–ö–ò–ô –î–ò–ó–ê–ô–ù (VARIABLES) --- */
    :root {
      --bg-color: var(--tg-theme-bg-color, #f0f2f5);
      --text-color: var(--tg-theme-text-color, #222);
      --card-bg: var(--tg-theme-secondary-bg-color, #ffffff);
      --accent-color: #2481cc;
      --red-color: #ff3b30;
      
      /* –ü–∞–ª—ñ—Ç—Ä–∞ —Å—Ç–∞—Ç—É—Å—É */
      --light-on: #e6e6a1;  /* –ñ–æ–≤—Ç–∏–π */
      --light-off: #00193a; /* –°–∏–Ω—ñ–π */
      --border-color: rgba(0, 0, 0, 0.05);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      margin: 0;
      padding: 16px;
      -webkit-font-smoothing: antialiased;
      box-sizing: border-box;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .hidden { display: none !important; }

    /* –ö–ê–†–¢–ö–ê –ù–ê–õ–ê–®–¢–£–í–ê–ù–¨ */
    .setup-card {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 24px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      margin-top: 20px;
    }
    
    select {
      width: 100%; padding: 14px; margin-bottom: 12px;
      border: 1px solid #ddd; border-radius: 12px;
      background: var(--bg-color); color: var(--text-color);
      font-size: 16px; appearance: none; -webkit-appearance: none;
      outline: none;
    }

    .btn-primary {
      width: 100%; padding: 16px;
      background: var(--accent-color); color: #fff;
      border: none; border-radius: 14px;
      font-size: 16px; font-weight: 600;
      cursor: pointer; transition: opacity 0.2s;
    }
    .btn-primary:active { opacity: 0.8; }

    /* --- –ì–û–õ–û–í–ù–ò–ô –ï–ö–†–ê–ù (–Ø–ö –£ –í–Ü–ù–ù–ò–¶–Ü) --- */
    
    /* –®–∞–ø–∫–∞: –ß–µ—Ä–≥–∞ –∑–ª—ñ–≤–∞, –°—Ç–∞—Ç—É—Å —Å–ø—Ä–∞–≤–∞ */
    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
    }

    .queue-info h1 {
      margin: 0; font-size: 28px; font-weight: 800;
      line-height: 1.1; letter-spacing: -0.5px;
    }
    .queue-info p {
      margin: 4px 0 0 0; font-size: 15px; color: #888; font-weight: 400;
    }

    .status-badge {
      font-size: 13px; font-weight: 700;
      padding: 6px 12px; border-radius: 30px;
      background-color: var(--light-on); color: #333;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      white-space: nowrap;
    }
    .status-badge.off {
      background-color: var(--light-off); color: #fff;
    }

    /* –¢–∞–±–∏ (–ü–µ—Ä–µ–º–∏–∫–∞—á) */
    .tabs-wrapper {
      background: rgba(118, 118, 128, 0.12);
      border-radius: 10px; padding: 2px;
      display: flex; margin-bottom: 24px;
    }
    .tab-btn {
      flex: 1; text-align: center; padding: 8px;
      font-size: 14px; font-weight: 600;
      border-radius: 8px; cursor: pointer;
      color: var(--text-color); transition: all 0.2s ease;
    }
    .tab-btn.active {
      background: var(--card-bg);
      box-shadow: 0 3px 8px rgba(0,0,0,0.12);
    }

    /* –°—ñ—Ç–∫–∞ –≥—Ä–∞—Ñ—ñ–∫–∞ */
    .grid-container {
      display: flex; flex-wrap: wrap;
      border-radius: 12px; overflow: hidden;
      background: var(--card-bg);
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      /* border: 1px solid rgba(0,0,0,0.05); */
    }

    .hour-cell {
      width: 25%; /* 4 –≤ —Ä—è–¥ */
      height: 48px;
      background-color: var(--light-on);
      border: 0.5px solid rgba(0,0,0,0.04);
      box-sizing: border-box;
      display: flex; align-items: center; justify-content: center;
      font-size: 13px; font-weight: 500; color: #333;
      position: relative;
    }
    
    @media (min-width: 370px) { .hour-cell { width: 20%; } } /* 5 –≤ —Ä—è–¥ */
    @media (min-width: 440px) { .hour-cell { width: 16.66%; } } /* 6 –≤ —Ä—è–¥ */

    /* –°—Ç–∏–ª—ñ —Å—Ç–∞–Ω—ñ–≤ */
    .hour-cell.is-off {
      background-color: var(--light-off);
      color: #fff; border-color: #0b2d5a;
    }

    /* –ü–æ—Ç–æ—á–Ω–∞ –≥–æ–¥–∏–Ω–∞ - –ß–µ—Ä–≤–æ–Ω–∞ —Ä–∞–º–∫–∞ */
    .hour-cell.is-current {
      border: 2px solid var(--red-color) !important;
      z-index: 10;
    }
    /* –ö—Ä–∞–ø–∫–∞ "LIVE" */
    .hour-cell.is-current::after {
      content: ''; position: absolute;
      top: 3px; right: 3px;
      width: 6px; height: 6px;
      background: var(--red-color);
      border-radius: 50%;
    }

    /* –ù–∏–∂–Ω—è –∫–Ω–æ–ø–∫–∞ */
    .footer-action {
      margin-top: auto; padding-top: 30px; text-align: center;
    }
    .btn-link {
      background: none; border: none;
      color: #888; font-size: 15px; font-weight: 500;
      cursor: pointer; text-decoration: none;
    }

    /* Loader */
    .loader {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      color: #888; font-size: 14px;
    }
  </style>
</head>
<body>

  <div id="loader" class="loader">
    <p>–û—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö...</p>
  </div>

  <div id="setup-screen" class="hidden">
    <div class="setup-card">
      <h2 style="margin: 0 0 10px 0;">–í—ñ—Ç–∞—é! üëã</h2>
      <p style="color:#888; margin-bottom:20px;">–©–æ–± –ø–æ—á–∞—Ç–∏, –æ–±–µ—Ä—ñ—Ç—å –≤–∞—à—É –æ–±–ª–∞—Å—Ç—å</p>
      
      <select id="region-select" onchange="loadQueues()">
        <option value="">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</option>
      </select>
      
      <div id="queue-block" class="hidden">
        <select id="queue-select">
          <option value="">–û–±–µ—Ä—ñ—Ç—å —á–µ—Ä–≥—É</option>
        </select>
        <button class="btn-primary" onclick="saveConfig()">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
      </div>
    </div>
  </div>

  <div id="view-screen" class="hidden">
    
    <div class="header-container">
      <div class="queue-info">
        <h1 id="view-queue">...</h1> <p id="view-region">...</p> </div>
      <div id="status-badge" class="status-badge">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</div>
    </div>

    <div class="tabs-wrapper">
      <div id="tab-0" class="tab-btn active" onclick="loadSchedule(0)">–°—å–æ–≥–æ–¥–Ω—ñ</div>
      <div id="tab-1" class="tab-btn" onclick="loadSchedule(1)">–ó–∞–≤—Ç—Ä–∞</div>
    </div>

    <div id="schedule-grid" class="grid-container">
      </div>
    
    <div style="text-align:center; margin-top:10px;">
      <span id="error-msg" style="color:var(--red-color); font-size:13px;"></span>
    </div>

    <div class="footer-action">
      <button class="btn-link" onclick="showSetup()">üîÑ –ó–º—ñ–Ω–∏—Ç–∏ —á–µ—Ä–≥—É</button>
    </div>
  </div>

<script>
  const tg = window.Telegram.WebApp;
  tg.expand();
  const userId = tg.initDataUnsafe?.user?.id || "TEST_USER";

  // üëá –í–°–¢–ê–í –°–Æ–î–ò URL –°–í–û–ì–û –°–ö–†–ò–ü–¢–ê (/exec) üëá
  const API_URL = "https://script.google.com/macros/s/AKfycbx0_wj63qj6n3ADHCuHpaTdz-5NmQ61ZWSFKNCjaAkvSsmbBncpiITnkqFN3salqppCAA/exec";

  // --- API ---
  async function callApi(action, params = {}) {
    const url = new URL(API_URL);
    url.searchParams.append('action', action);
    for (const k in params) url.searchParams.append(k, params[k]);
    try {
      const res = await fetch(url);
      return await res.json();
    } catch (e) {
      console.error(e);
      return { error: "–ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è" };
    }
  }

  // --- INIT ---
  window.onload = async () => {
    const data = await callApi('getUserSchedule', { chatId: userId });
    document.getElementById('loader').classList.add('hidden');

    if (data && data.error === "UserNotFound") {
      showSetup();
    } else if (data && !data.error) {
      showView(data);
    } else {
      showSetup(); // –§–æ–ª–±–µ–∫ –Ω–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ
    }
  };

  // --- SETUP ---
  async function showSetup() {
    document.getElementById('view-screen').classList.add('hidden');
    document.getElementById('setup-screen').classList.remove('hidden');
    
    const regions = await callApi('getRegions');
    const rSel = document.getElementById('region-select');
    rSel.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å –æ–±–ª–∞—Å—Ç—å</option>';
    if (regions && regions.length) {
      regions.forEach(r => {
        const opt = document.createElement('option');
        opt.value = r.url;
        opt.text = r.name;
        rSel.appendChild(opt);
      });
    }
  }

  async function loadQueues() {
    const url = document.getElementById('region-select').value;
    if (!url) return;
    
    const qs = await callApi('getChildren', { url: url });
    const qSel = document.getElementById('queue-select');
    qSel.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å —á–µ—Ä–≥—É</option>';
    if (qs && qs.length) {
      qs.forEach(q => {
        const opt = document.createElement('option');
        opt.value = q.url;
        opt.text = q.name;
        qSel.appendChild(opt);
      });
      document.getElementById('queue-block').classList.remove('hidden');
    }
  }

  async function saveConfig() {
    const rSel = document.getElementById('region-select');
    const qSel = document.getElementById('queue-select');
    
    if (!qSel.value) return tg.showAlert("–ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å —á–µ—Ä–≥—É");
    
    document.getElementById('loader').classList.remove('hidden');
    document.getElementById('setup-screen').classList.add('hidden');
    
    // –ü–µ—Ä–µ–¥–∞—î–º–æ —Ç–∞–∫–æ–∂ –Ω–∞–∑–≤—É —Ä–µ–≥—ñ–æ–Ω—É, —Ö–æ—á–∞ –±–µ–∫–µ–Ω–¥ –ø–æ–∫–∏ —ó—ó —ñ–≥–Ω–æ—Ä—É—î (–Ω–∞ –º–∞–π–±—É—Ç–Ω—î)
    await callApi('saveSelection', {
      chatId: userId,
      url: qSel.value,
      name: qSel.options[qSel.selectedIndex].text
    });
    
    location.reload();
  }

  // --- VIEW (–†–µ–Ω–¥–µ—Ä —è–∫ —É –í—ñ–Ω–Ω–∏—Ü—ñ) ---
  function showView(data) {
    document.getElementById('setup-screen').classList.add('hidden');
    document.getElementById('view-screen').classList.remove('hidden');
    
    document.getElementById('view-queue').innerText = data.queueName || "–ß–µ—Ä–≥–∞";
    // –Ø–∫—â–æ –±–µ–∫–µ–Ω–¥ –Ω–µ –ø–æ–≤–µ—Ä—Ç–∞—î region, –ø–∏—à–µ–º–æ –¥–µ—Ñ–æ–ª—Ç.
    document.getElementById('view-region').innerText = data.region || "–í–∞—à–∞ –æ–±–ª–∞—Å—Ç—å";
    
    renderGrid(data.schedule);
  }

  async function loadSchedule(offset) {
    // –¢–∞–±–∏
    document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
    document.getElementById('tab-' + offset).classList.add('active');
    
    const grid = document.getElementById('schedule-grid');
    grid.innerHTML = '<div style="width:100%;padding:20px;text-align:center;color:#888">–û–Ω–æ–≤–ª–µ–Ω–Ω—è...</div>';
    
    const res = await callApi('getUserSchedule', { chatId: userId, dateOffset: offset });
    
    if (res.schedule && res.schedule.error) {
       grid.innerHTML = '';
       document.getElementById('error-msg').innerText = res.schedule.error;
    } else {
       renderGrid(res.schedule);
    }
  }

  function renderGrid(schedule) {
    const grid = document.getElementById('schedule-grid');
    grid.innerHTML = "";
    document.getElementById('error-msg').innerText = "";

    if (!schedule || !schedule.slots) return;

    const now = new Date();
    const currentHour = now.getHours();
    const isToday = document.getElementById('tab-0').classList.contains('active');
    
    let isCurrentOff = false;

    for (let i = 0; i < 24; i++) {
      const slot = schedule.slots.find(s => s.hour === i);
      const isOff = slot && slot.status === 'off';
      
      const div = document.createElement('div');
      div.className = 'hour-cell';
      
      if (isOff) div.classList.add('is-off');

      // –ü—ñ–¥—Å–≤—ñ—Ç–∫–∞ –ø–æ—Ç–æ—á–Ω–æ—ó –≥–æ–¥–∏–Ω–∏
      if (isToday && i === currentHour) {
        div.classList.add('is-current');
        if (isOff) isCurrentOff = true;
      }

      div.innerText = `${String(i).padStart(2,'0')}-${String(i+1).padStart(2,'0')}`;
      grid.appendChild(div);
    }

    updateStatusBadge(isToday, isCurrentOff);
  }

  function updateStatusBadge(isToday, isOff) {
    const badge = document.getElementById('status-badge');
    if (!isToday) {
      badge.innerText = "–ì—Ä–∞—Ñ—ñ–∫ –Ω–∞ –∑–∞–≤—Ç—Ä–∞";
      badge.className = "status-badge";
      return;
    }

    if (isOff) {
      badge.innerText = "–°–≤—ñ—Ç–ª–∞ –Ω–µ–º–∞—î";
      badge.className = "status-badge off";
    } else {
      badge.innerText = "–°–≤—ñ—Ç–ª–æ —î";
      badge.className = "status-badge";
    }
  }
</script>
</body>
</html>
