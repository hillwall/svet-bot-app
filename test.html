<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>Світло — вибір черги</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: Arial; padding: 16px; }
    select, button { width: 100%; padding: 8px; margin-top: 10px; }
    #status { margin-top: 12px; }
    #result { margin-top: 16px; white-space: pre-line; }
  </style>
</head>
<body>

<h3>Оберіть область</h3>
<select id="region"></select>

<h3>Оберіть чергу</h3>
<select id="queue"></select>

<button onclick="saveSelection()">Зберегти</button>

<div id="status"></div>
<div id="result"></div>

<script>
const tg = window.Telegram.WebApp;
tg.ready();

const user = tg.initDataUnsafe?.user;

if (!user || !user.id) {
  document.body.innerHTML = "❌ Відкрийте Mini App через Telegram кнопку";
  throw new Error("NO_TG_CONTEXT");
}

// ⚠️ ЗАМІНИ НА СВІЙ TEST GAS URL
const GAS_URL = "https://script.google.com/macros/s/AKfycbx0_wj63qj6n3ADHCuHpaTdz-5NmQ61ZWSFKNCjaAkvSsmbBncpiITnkqFN3salqppCAA/exec";

// ===== ДЕМО ДАНІ (ТИМЧАСОВО) =====
const regions = [
  {
    name: "Вінницька область",
    queues: [
      { name: "Черга 1.1", url: "/vinnytska-oblast/cherha-1-1" },
      { name: "Черга 1.2", url: "/vinnytska-oblast/cherha-1-2" }
    ]
  }
];

// ===== ІНІЦІАЛІЗАЦІЯ =====
const regionSelect = document.getElementById("region");
const queueSelect = document.getElementById("queue");

regions.forEach((r, i) => {
  const opt = document.createElement("option");
  opt.value = i;
  opt.textContent = r.name;
  regionSelect.appendChild(opt);
});

regionSelect.onchange = () => {
  queueSelect.innerHTML = "";
  regions[regionSelect.value].queues.forEach(q => {
    const opt = document.createElement("option");
    opt.value = q.url;
    opt.textContent = q.name;
    opt.dataset.name = q.name;
    queueSelect.appendChild(opt);
  });
};

regionSelect.dispatchEvent(new Event("change"));

// ===== ЗБЕРЕЖЕННЯ =====
function saveSelection() {
  document.getElementById("status").innerText = "⏳ Завантаження…";
  document.getElementById("result").innerText = "";

  const region = regions[regionSelect.value];
  const queueOpt = queueSelect.selectedOptions[0];

  const payload = {
    chat_id: user.id,
    first_name: user.first_name || "",
    username: user.username || "",
    region_name: region.name,
    queue_name: queueOpt.dataset.name,
    queue_url: queueOpt.value
  };

  fetch(GAS_URL, {
    method: "POST",
    body: JSON.stringify(payload)
  })
  .then(r => r.json())
  .then(res => {
    if (!res.ok) {
      document.getElementById("status").innerText = "❌ Помилка";
      return;
    }

    document.getElementById("status").innerText = "✅ Збережено";
    document.getElementById("result").innerHTML = res.scheduleText;
  })
  .catch(() => {
    document.getElementById("status").innerText = "❌ Помилка зʼєднання";
  });
}
</script>

</body>
</html>
